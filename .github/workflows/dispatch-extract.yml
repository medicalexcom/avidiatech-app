name: Dispatch - Run Avidia Extract smoke test

# Manually-run workflow to call the local wrapper which calls medx-ingest-api ingest endpoint.
# This lets you run the extract test from GitHub Actions UI (no local commands needed).
#
# Inputs:
#   url: product page to ingest
# Secrets (set in repository Settings -> Secrets):
#   INGEST_API_ENDPOINT (optional; defaults to https://medx-ingest-api.onrender.com)
#   INGEST_API_KEY      (optional; required if your ingest API needs a key)
on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Target product URL to ingest'
        required: true
        default: 'https://www.apple.com/iphone-17/'

permissions:
  contents: read

jobs:
  run-smoke:
    name: Run extract smoke test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies (if package.json present)
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "No package.json found; skipping npm ci"
          fi

      - name: Run TypeScript smoke script with ts-node
        env:
          TARGET_URL: ${{ github.event.inputs.url }}
          INGEST_API_ENDPOINT: ${{ secrets.INGEST_API_ENDPOINT }}
          INGEST_API_KEY: ${{ secrets.INGEST_API_KEY }}
        run: |
          # Use npx ts-node to avoid requiring ts-node in repo deps.
          # The -O option forces commonjs module output for compatibility.
          npx ts-node -O '{"module":"commonjs"}' scripts/run-extract.ts "${{ github.event.inputs.url }}"
