name: Dispatch - Run Avidia Extract smoke test

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Target product URL to ingest'
        required: true
        default: 'https://www.apple.com/iphone-17/'

permissions:
  contents: read

jobs:
  run-smoke:
    name: Run extract smoke test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies (try npm ci, fall back to npm install)
        run: |
          if [ -f package.json ]; then
            echo "Attempting npm ci..."
            npm ci --prefer-offline --no-audit || { echo "npm ci failed, running npm install..."; npm install --prefer-offline --no-audit; }
          else
            echo "No package.json found; skipping install"
          fi

      - name: Run TypeScript smoke script with ts-node
        env:
          TARGET_URL: ${{ github.event.inputs.url }}
          INGEST_API_ENDPOINT: ${{ secrets.INGEST_API_ENDPOINT }}
          INGEST_API_KEY: ${{ secrets.INGEST_API_KEY }}
        run: |
          npx ts-node -O '{"module":"commonjs"}' scripts/run-extract.ts "${{ github.event.inputs.url }}"
