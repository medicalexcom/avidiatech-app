# Pushes scaffold files from an embedded base64 patch and opens a PR (manual trigger)
name: Add AvidiaMatch scaffold (apply patch and open PR)

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  apply-patch-and-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create branch
        run: |
          BRANCH="feature/avidiatch-match"
          # fail if branch already exists remotely to avoid unintended overwrites
          if git ls-remote --heads origin $BRANCH | grep -q $BRANCH; then
            echo "Remote branch $BRANCH already exists. Exiting."
            exit 1
          fi
          git switch -c $BRANCH

      - name: Write base64 patch to disk
        run: |
          cat > avidiatch-match-scaffold.patch.b64 <<'B64'
          REPLACE_WITH_BASE64_PATCH
          B64

      - name: Decode patch and apply
        run: |
          set -e
          base64 --decode avidiatch-match-scaffold.patch.b64 > avidiatch-match-scaffold.patch
          if ! git apply --index avidiatch-match-scaffold.patch; then
            echo "git apply failed"
            exit 1
          fi
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 1
          fi
          git commit -m "feat(match): scaffold AvidiaMatch SKU→URL matching module"

      - name: Push branch
        env:
          BRANCH: feature/avidiatch-match
        run: |
          git push -u origin HEAD:$BRANCH

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: feat(match): scaffold AvidiaMatch SKU→URL matching module (retry)
          branch: feature/avidiatch-match
          title: feat(match): scaffold AvidiaMatch SKU→URL matching module (retry)
          body: |
            Adds Supabase migrations, match library, Next.js API endpoints, UI scaffold under /dashboard/match, and a unit test.

            Next steps:
            1. Run the SQL migrations in supabase/migrations/ (0XX, 0XY, 0XZ).
            2. Seed starter patterns (BD, Nonin, MTI, etc).
            3. Set environment variables: INGEST_ENGINE_URL, FEATURE_MATCH=true (or NEXT_PUBLIC_FEATURE_MATCH), MATCH_MAX_BATCH.
            4. Wire real auth & supabase clients (stubs are included for scaffolding).
          labels: scaffold
