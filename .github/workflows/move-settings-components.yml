name: Move settings UI components (move to src/components/settings)

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  move-and-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # allow pushing commits back using the GITHUB_TOKEN
          persist-credentials: true
          fetch-depth: 0

      - name: Show current branch
        run: |
          echo "Repository: $(basename $(git rev-parse --show-toplevel))"
          git status --porcelain
          git rev-parse --abbrev-ref HEAD

      - name: Move settings UI component files
        id: move
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          mkdir -p src/components/settings

          files=(
            "ProfileForm.tsx"
            "OrganizationForm.tsx"
            "ApiKeysManager.tsx"
            "WebhooksManager.tsx"
          )

          moved=false
          for f in "${files[@]}"; do
            src="src/app/settings/$f"
            dst="src/components/settings/$f"
            if [ -f "$src" ]; then
              echo "Moving $src -> $dst"
              git mv "$src" "$dst"
              moved=true
            else
              echo "Not found (skipping): $src"
            fi
          done

          if [ "$moved" = false ]; then
            echo "No files moved. Exiting."
            echo "::set-output name=changed::false"
            exit 0
          fi

          git add -A
          git commit -m "chore(settings): move UI components to src/components/settings (preserve history)"
          # create a branch for the PR
          BRANCH="move/settings-components"
          git push -u origin HEAD:"$BRANCH"
          echo "::set-output name=changed::true"
          echo "::set-output name=branch::$BRANCH"

      - name: Create Pull Request
        if: steps.move.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: chore(settings): move UI components to src/components/settings (preserve history)
          branch: ${{ steps.move.outputs.branch }}
          title: Move settings UI components to src/components/settings
          body: |
            This automated PR moves UI components (ProfileForm, OrganizationForm, ApiKeysManager, WebhooksManager)
            from src/app/settings to src/components/settings to resolve build import paths.
            Please review and merge if everything looks good.

      - name: No-op if nothing moved
        if: steps.move.outputs.changed == 'false'
        run: echo "No component files were moved; nothing to do."
