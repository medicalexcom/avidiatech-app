(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,77309,e=>{"use strict";var s=e.i(43476),t=e.i(71645),l=e.i(18566);function a(e){if(!e)return"—";try{return new Date(e).toLocaleString()}catch{return e}}function i(){let e=(0,l.useSearchParams)(),i=e?.get("bulkJobId")||"",[n,r]=(0,t.useState)(null),[d,c]=(0,t.useState)([]),[o,x]=(0,t.useState)(!1),[m,h]=(0,t.useState)(!1),[u,p]=(0,t.useState)(null),[j]=(0,t.useState)(200),[b,f]=(0,t.useState)(0),[g,N]=(0,t.useState)(!0),[y]=(0,t.useState)(3e3),[w,v]=(0,t.useState)({}),[k,_]=(0,t.useState)(null),S=(0,t.useMemo)(()=>`/api/v1/bulk/${encodeURIComponent(i)}`,[i]);async function C(){if(i){x(!0),p(null);try{let e=await fetch(S);if(!e.ok){let s=await e.json().catch(()=>null);throw Error(s?.error??`Failed to fetch job (${e.status})`)}let s=await e.json();r(s?.data??s)}catch(e){p(String(e?.message||e))}finally{x(!1)}}}async function $(){if(i){h(!0),p(null);try{let e=`${S}/items?limit=${j}&offset=${b}`,s=await fetch(e);if(!s.ok){let e=await s.json().catch(()=>null);throw Error(e?.error??`Failed to fetch items (${s.status})`)}let t=await s.json();c(t?.data??t??[])}catch(e){p(String(e?.message||e))}finally{h(!1)}}}(0,t.useEffect)(()=>{i&&(C(),$())},[i,b]),(0,t.useEffect)(()=>{if(!i||!g)return;let e=!0,s=setInterval(async()=>{e&&(await C(),await $())},y);return()=>{e=!1,clearInterval(s)}},[i,g,b,y]);let R=n?.total_items??d?.length??0,I=n?.completed_items??d.filter(e=>"succeeded"===e.status).length,U=n?.failed_items??d.filter(e=>"failed"===e.status).length,T=Math.max(0,(R??0)-(I??0)-(U??0)),E=R?Math.round((I??0)/R*100):0;async function O(){if(!i)return;let e=`${S}/items/errors`;window.open(e,"_blank")}async function P(e){if(i&&e){v(s=>({...s,[e]:!0})),_(null);try{let s=`${S}/items/${encodeURIComponent(e)}/retry`,t=await fetch(s,{method:"POST"});if(!t.ok){let e=await t.json().catch(()=>null);throw Error(e?.error??`Retry failed (${t.status})`)}_("Item re-enqueued"),await $(),await C()}catch(e){_(String(e?.message||e))}finally{v(s=>{let t={...s};return delete t[e],t}),setTimeout(()=>_(null),4e3)}}}async function M(){if(i){_(null);try{let e=`${S}/retry-failed`,s=await fetch(e,{method:"POST"});if(!s.ok){let e=await s.json().catch(()=>null);throw Error(e?.error??`Retry failed (${s.status})`)}_("Failed items enqueued for retry"),await $(),await C()}catch(e){_(String(e?.message||e))}finally{setTimeout(()=>_(null),4e3)}}}function D(e){e&&window.open(`/dashboard/extract?ingestionId=${encodeURIComponent(e)}`,"_blank")}return(0,s.jsxs)("div",{className:"mx-auto max-w-7xl p-4",children:[(0,s.jsxs)("div",{className:"flex items-start justify-between gap-4 mb-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold",children:"Bulk job"}),(0,s.jsxs)("div",{className:"mt-1 text-sm text-slate-600",children:["Job id: ",(0,s.jsx)("span",{className:"font-mono",children:i||"—"})]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("button",{onClick:()=>{C(),$()},className:"rounded-md border px-3 py-2 text-sm bg-white",disabled:!i||o||m,children:"Refresh"}),(0,s.jsxs)("label",{className:"inline-flex items-center gap-2 text-sm",children:[(0,s.jsx)("input",{type:"checkbox",checked:g,onChange:e=>N(e.target.checked)}),"Auto refresh"]}),(0,s.jsx)("button",{onClick:O,className:"rounded-md bg-rose-600 px-3 py-2 text-sm text-white",disabled:!i,title:"Download CSV of failed items",children:"Download errors CSV"})]})]}),u?(0,s.jsx)("div",{className:"mb-4 rounded-md border border-rose-300 bg-rose-50 p-3 text-sm text-rose-800",children:u}):null,(0,s.jsxs)("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-12",children:[(0,s.jsxs)("div",{className:"lg:col-span-8 space-y-4",children:[(0,s.jsxs)("section",{className:"rounded-2xl border bg-white p-4 shadow-sm",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-xs text-slate-500",children:"Summary"}),(0,s.jsx)("h2",{className:"text-lg font-semibold",children:n?.name??"Bulk job"})]}),(0,s.jsxs)("div",{className:"text-right",children:[(0,s.jsx)("div",{className:"text-xs text-slate-500",children:"Created"}),(0,s.jsx)("div",{className:"font-mono text-sm",children:a(n?.created_at)})]})]}),(0,s.jsxs)("div",{className:"mt-4",children:[(0,s.jsxs)("div",{className:"flex items-center gap-4",children:[(0,s.jsxs)("div",{className:"rounded-lg border px-3 py-2 text-sm",children:["Total: ",(0,s.jsx)("span",{className:"font-semibold ml-2",children:R??"—"})]}),(0,s.jsxs)("div",{className:"rounded-lg border px-3 py-2 text-sm",children:["Completed: ",(0,s.jsx)("span",{className:"font-semibold ml-2",children:I??0})]}),(0,s.jsxs)("div",{className:"rounded-lg border px-3 py-2 text-sm",children:["Failed: ",(0,s.jsx)("span",{className:"font-semibold ml-2",children:U??0})]}),(0,s.jsxs)("div",{className:"rounded-lg border px-3 py-2 text-sm",children:["Queued: ",(0,s.jsx)("span",{className:"font-semibold ml-2",children:T??0})]})]}),(0,s.jsxs)("div",{className:"mt-3",children:[(0,s.jsx)("div",{className:"h-3 w-full rounded-full bg-slate-200",children:(0,s.jsx)("div",{className:"h-3 rounded-full bg-gradient-to-r from-sky-400 via-emerald-400 to-amber-400",style:{width:`${Math.min(100,Math.max(0,E))}%`}})}),(0,s.jsxs)("div",{className:"mt-2 text-sm text-slate-500",children:["Progress: ",E,"%"]})]})]})]}),(0,s.jsxs)("section",{className:"rounded-2xl border bg-white p-4 shadow-sm",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("h3",{className:"text-sm font-semibold",children:"Items"}),(0,s.jsxs)("div",{className:"text-xs text-slate-500",children:["Showing ",d.length," items (offset ",b,")"]})]}),(0,s.jsx)("div",{className:"mt-3 overflow-auto",children:(0,s.jsxs)("table",{className:"min-w-full text-sm",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{className:"text-left text-xs text-slate-500",children:[(0,s.jsx)("th",{className:"py-2 pr-3",children:"#"}),(0,s.jsx)("th",{className:"py-2 pr-3",children:"URL"}),(0,s.jsx)("th",{className:"py-2 pr-3",children:"Status"}),(0,s.jsx)("th",{className:"py-2 pr-3",children:"Ingestion"}),(0,s.jsx)("th",{className:"py-2 pr-3",children:"Pipeline"}),(0,s.jsx)("th",{className:"py-2 pr-3",children:"Error"}),(0,s.jsx)("th",{className:"py-2 pr-3",children:"Actions"})]})}),(0,s.jsx)("tbody",{children:m?(0,s.jsx)("tr",{children:(0,s.jsx)("td",{className:"py-4 text-sm text-slate-500",colSpan:7,children:"Loading items…"})}):0===d.length?(0,s.jsx)("tr",{children:(0,s.jsx)("td",{className:"py-4 text-sm text-slate-500",colSpan:7,children:"No items found."})}):d.map(e=>(0,s.jsxs)("tr",{className:"border-t",children:[(0,s.jsx)("td",{className:"py-2 pr-3 align-top",children:e.item_index+1}),(0,s.jsx)("td",{className:"py-2 pr-3 align-top max-w-[36ch] truncate",children:e.input_url}),(0,s.jsx)("td",{className:"py-2 pr-3 align-top",children:(0,s.jsx)("span",{className:`inline-flex items-center rounded-full px-2 py-0.5 text-xs ${"succeeded"===e.status?"bg-emerald-50 text-emerald-700":"failed"===e.status?"bg-rose-50 text-rose-700":"bg-slate-100 text-slate-700"}`,children:e.status??"—"})}),(0,s.jsx)("td",{className:"py-2 pr-3 align-top",children:e.ingestion_id?(0,s.jsxs)("button",{className:"text-xs text-sky-700 underline",onClick:()=>D(e.ingestion_id),children:[e.ingestion_id.slice(0,10),"…"]}):"—"}),(0,s.jsx)("td",{className:"py-2 pr-3 align-top",children:e.pipeline_run_id?(0,s.jsxs)("a",{className:"text-xs underline",href:`/api/v1/pipeline/run/${encodeURIComponent(e.pipeline_run_id)}/output/0`,target:"_blank",rel:"noreferrer",children:[e.pipeline_run_id.slice(0,10),"…"]}):"—"}),(0,s.jsx)("td",{className:"py-2 pr-3 align-top",children:e.last_error?(0,s.jsx)("div",{className:"max-w-[28ch] truncate text-xs text-rose-700",children:"string"==typeof e.last_error?e.last_error:JSON.stringify(e.last_error)}):"—"}),(0,s.jsx)("td",{className:"py-2 pr-3 align-top",children:(0,s.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,s.jsx)("button",{className:"rounded px-2 py-1 text-xs border bg-white",onClick:()=>D(e.ingestion_id),disabled:!e.ingestion_id,children:"Open Extract"}),(0,s.jsx)("button",{className:"rounded px-2 py-1 text-xs border bg-white",onClick:()=>{var s;(s=e.ingestion_id)&&window.open(`/dashboard/describe?ingestionId=${encodeURIComponent(s)}`,"_blank")},disabled:!e.ingestion_id,children:"Open Describe"}),(0,s.jsx)("button",{className:"rounded px-2 py-1 text-xs border bg-white",onClick:()=>{var s;(s=e.ingestion_id)&&window.open(`/dashboard/monitor?ingestionId=${encodeURIComponent(s)}`,"_blank")},disabled:!e.ingestion_id,children:"Open Monitor"}),(0,s.jsx)("button",{className:"rounded px-2 py-1 text-xs bg-amber-400 text-slate-900",disabled:w[e.id]||"failed"!==e.status,onClick:()=>P(e.id),children:w[e.id]?"Retrying…":"Retry"})]})})]},e.id))})]})}),(0,s.jsxs)("div",{className:"mt-4 flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,s.jsx)("button",{className:"rounded px-2 py-1 border",onClick:()=>f(Math.max(0,b-j)),disabled:0===b,children:"Prev"}),(0,s.jsx)("button",{className:"rounded px-2 py-1 border",onClick:()=>f(b+j),disabled:d.length<j,children:"Next"}),(0,s.jsxs)("div",{className:"text-xs text-slate-500",children:["offset ",b]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("button",{className:"rounded px-3 py-2 bg-sky-600 text-white text-sm",onClick:M,disabled:0===U,children:"Retry failed items"}),k?(0,s.jsx)("div",{className:"text-sm text-slate-600",children:k}):null]})]})]})]}),(0,s.jsxs)("aside",{className:"lg:col-span-4 space-y-4",children:[(0,s.jsxs)("section",{className:"rounded-2xl border bg-white p-4 shadow-sm",children:[(0,s.jsx)("h3",{className:"text-sm font-semibold",children:"Job details"}),(0,s.jsxs)("div",{className:"mt-3 text-sm text-slate-700",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:"Name:"})," ",n?.name??"—"]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:"Created by:"})," ",(0,s.jsx)("span",{className:"font-mono",children:n?.created_by??"—"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:"Created:"})," ",a(n?.created_at)]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:"Updated:"})," ",a(n?.updated_at)]})]})]}),(0,s.jsxs)("section",{className:"rounded-2xl border bg-white p-4 shadow-sm",children:[(0,s.jsx)("h3",{className:"text-sm font-semibold",children:"Quick actions"}),(0,s.jsxs)("div",{className:"mt-3 space-y-2",children:[(0,s.jsx)("button",{className:"w-full rounded px-3 py-2 bg-sky-600 text-white",onClick:O,disabled:!i,children:"Download failed rows CSV"}),(0,s.jsx)("button",{className:"w-full rounded px-3 py-2 bg-white border text-sm",onClick:()=>{C(),$()},children:"Refresh now"})]})]}),(0,s.jsxs)("section",{className:"rounded-2xl border bg-white p-4 shadow-sm",children:[(0,s.jsx)("h3",{className:"text-sm font-semibold",children:"Diagnostics"}),(0,s.jsx)("div",{className:"mt-2 text-xs text-slate-600",children:"Failed rows will appear here and can be downloaded for inspection. If items are stuck, check worker logs and Redis connectivity."})]})]})]})]})}e.s(["default",()=>i])}]);