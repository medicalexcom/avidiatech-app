module.exports=[92509,(e,t,r)=>{t.exports=e.x("url",()=>require("url"))},24868,(e,t,r)=>{t.exports=e.x("fs/promises",()=>require("fs/promises"))},79622,e=>{"use strict";var t=e.i(47909),r=e.i(74017),o=e.i(96250),n=e.i(59756),s=e.i(61916),a=e.i(14444),i=e.i(37092),l=e.i(69741),u=e.i(16795),c=e.i(87718),d=e.i(95169),p=e.i(47587),_=e.i(66012),f=e.i(70101),h=e.i(26937),g=e.i(10372),m=e.i(93695);e.i(52474);var R=e.i(5232),v=e.i(22734),w=e.i(14747),y=e.i(92509),E=e.i(89171),x=e.i(87914),S=e.i(44070),T=e.i(24868);let C=process.env.RENDER_PROMPTS_REPO||"medicalexcom/medx-ingest-api",N=process.env.RENDER_PROMPTS_COMMIT||"34dd54c508824b84d2ad3cd21d782af219044718",P=parseInt(process.env.RENDER_PROMPTS_TTL_SECONDS||"600",10),A=null;async function O(){for(let e of[w.default.join(process.cwd(),"tools","render-engine","prompts","custom_gpt_instructions.md"),w.default.join(process.cwd(),"tools","render-engine","prompts","custom_gpt_instructions.txt"),w.default.join(process.cwd(),"tools","render-engine","prompts","custom_gpt_instructions","custom_gpt_instructions.md"),w.default.join(process.cwd(),"src","tools","render-engine","prompts","custom_gpt_instructions.md")])try{let t=await T.default.stat(e).catch(()=>null);if(t&&t.isFile()){let t=await T.default.readFile(e,{encoding:"utf8"});if(t&&t.trim().length>0)return console.info("loadInstructions: loaded local prompt from",e),t}}catch(e){}return null}async function I(){let e=process.env.RENDER_PROMPTS_REPO||C,t=process.env.RENDER_PROMPTS_COMMIT||N,r=`https://raw.githubusercontent.com/${e}/${t}/tools/render-engine/prompts/custom_gpt_instructions.md`;try{let e=new AbortController,t=setTimeout(()=>e.abort(),8e3),o=await fetch(r,{signal:e.signal});if(clearTimeout(t),!o.ok)return console.warn(`loadInstructions: raw fetch failed ${o.status} ${r}`),null;return await o.text()||null}catch(e){return console.warn("loadInstructions: fetch error",String(e)),null}}async function b(t){if(!t)return null;try{let{getServiceSupabaseClient:r}=e.r(44070),o=r(),{data:n,error:s}=await o.from("tenant_settings").select("custom_gpt_instructions").eq("tenant_id",t).limit(1).single();if(s||!n)return null;let a=n.custom_gpt_instructions;return"string"==typeof a&&a.trim().length>0?a:null}catch(e){return console.warn("loadInstructions: tenant override lookup failed:",String(e)),null}}async function D(e){try{let t=await b(e??null);if(t)return A={value:t,fetchedAt:Date.now(),source:"tenant"},{text:t,source:"tenant"}}catch{}let t=Date.now();if(A&&(t-A.fetchedAt)/1e3<P)return{text:A.value,source:"cache"};try{let e=await O();if(e)return A={value:e,fetchedAt:Date.now(),source:"local"},{text:e,source:"local"}}catch(e){console.warn("loadInstructions: local read attempt failed:",String(e))}let r=await I();return r?(A={value:r,fetchedAt:Date.now(),source:"remote"},{text:r,source:"remote"}):(A={value:null,fetchedAt:Date.now(),source:"none"},{text:null,source:"none"})}let M=process.env.CENTRAL_GPT_URL||"",j=process.env.CENTRAL_GPT_KEY||"";async function U(e,t,r,o){let n;if(!M||!j)throw Error("central_gpt_not_configured: CENTRAL_GPT_URL / CENTRAL_GPT_KEY missing");let{text:s,source:a}=await D(o??null),i=({module:e="seo",payload:t,correlationId:r,customInstructions:o,instructionsSource:n})=>{let s="string"==typeof o?o.trim():"";return{module:e,payload:t,correlation_id:r||void 0,custom_gpt_instructions:s.length>0?s:void 0,instruction_source:n||void 0,enforce_instructions:s.length>0,audit:{format:"avidia_seo_v1"}}};try{let e=w.default.join(process.cwd(),"../medx-ingest-api/tools/render-engine/gptInstructionsEnforcer.mjs");if(v.default.existsSync(e)){(0,y.pathToFileURL)(e).toString();let t=await Promise.resolve().then(()=>{let e=Error("Cannot find module as expression is too dynamic");throw e.code="MODULE_NOT_FOUND",e});i=t.buildSeoRequestBody||t.default?.buildSeoRequestBody||i,console.log("[api/v1/seo] using shared gptInstructionsEnforcer module")}else console.log("[api/v1/seo] shared gptInstructionsEnforcer not present; using built-in body builder")}catch(e){console.warn("[api/v1/seo] unable to load shared gptInstructionsEnforcer",e?.message||e)}let l=i?i({module:"seo",payload:e,correlationId:t||void 0,customInstructions:s,instructionsSource:a}):{module:"seo",payload:e,correlation_id:t||void 0,custom_gpt_instructions:s||void 0,instruction_source:a||void 0,enforce_instructions:!!s},u=await fetch(M,{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${j}`},body:JSON.stringify(l)}),c=await u.text();if(!u.ok)throw console.error("[api/v1/seo] central GPT non-200",u.status,c?.slice(0,500)),Error(`central_gpt_seo_error: ${u.status} ${c||"(empty body)"}`);try{n=JSON.parse(c)}catch(e){throw console.error("[api/v1/seo] central GPT returned non-JSON",e?.message||e,"raw=",c?.slice(0,500)),Error("central_gpt_invalid_json")}let d=e||{},p=n?.seo||d?.seo||{},_=n?.description_html||n?.description||d?.description_html||null,f=Array.isArray(n?.features)?n.features:d?.features??null;return console.log("[api/v1/seo] central GPT SEO summary",{hasSeo:!!p,hasDescription:!!_,featuresCount:Array.isArray(f)?f.length:null,sourceUrl:r||null,instructionsSource:a||null}),{seo_payload:p,description_html:_,features:f}}async function q(e){try{let t;console.log("[api/v1/seo] POST called");let r=(0,x.safeGetAuth)(e);if(!r?.userId)return E.NextResponse.json({error:"unauthenticated"},{status:401});let o=await e.json().catch(()=>({})),n=o?.ingestionId?.toString()||"";if(!n)return E.NextResponse.json({error:"missing_ingestionId"},{status:400});let s=(0,S.getServiceSupabaseClient)(),{data:a,error:i}=await s.from("product_ingestions").select("id, tenant_id, user_id, source_url, normalized_payload, seo_payload, description_html, features, correlation_id, diagnostics, status").eq("id",n).maybeSingle();if(i)return console.error("[api/v1/seo] failed to load ingestion",{ingestionId:n,error:i}),E.NextResponse.json({error:"ingestion_load_failed"},{status:500});if(!a)return E.NextResponse.json({error:"ingestion_not_found"},{status:404});if(!a.normalized_payload)return E.NextResponse.json({error:"ingestion_not_ready"},{status:409});let l=a.normalized_payload,u=new Date().toISOString();try{t=await U(l,a.correlation_id||null,a.source_url||null,a.tenant_id||null)}catch(e){return console.error("[api/v1/seo] seo model error:",e?.message||e),E.NextResponse.json({error:"seo_model_failed",detail:e?.message||String(e)},{status:500})}let c=new Date().toISOString(),d=a.diagnostics||{},p={...d.seo||{},last_run_at:c,started_at:u,status:"completed"},_={...d,seo:p},{data:f,error:h}=await s.from("product_ingestions").update({seo_payload:t.seo_payload,description_html:t.description_html,features:t.features,seo_generated_at:c,diagnostics:_,updated_at:c}).eq("id",a.id).select("id, seo_payload, description_html, features").maybeSingle();if(h)return console.error("[api/v1/seo] failed to update ingestion with SEO",{ingestionId:a.id,error:h}),E.NextResponse.json({error:"seo_persist_failed",detail:h.message||h},{status:500});return console.log("[api/v1/seo] SEO persisted",{ingestionId:a.id,hasSeo:!!f?.seo_payload,hasDescription:!!f?.description_html,featuresCount:Array.isArray(f?.features)?f?.features.length:null}),E.NextResponse.json({ingestionId:a.id,seo_payload:f?.seo_payload??t.seo_payload,description_html:f?.description_html??t.description_html,features:f?.features??t.features},{status:200})}catch(e){return console.error("POST /api/v1/seo error:",e),E.NextResponse.json({error:e?.message||"internal_error"},{status:500})}}e.s(["POST",()=>q],19878);var H=e.i(19878);let k=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/v1/seo/route",pathname:"/api/v1/seo",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/v1/seo/route.ts",nextConfigOutput:"",userland:H}),{workAsyncStorage:$,workUnitAsyncStorage:L,serverHooks:F}=k;function G(){return(0,o.patchFetch)({workAsyncStorage:$,workUnitAsyncStorage:L})}async function K(e,t,o){k.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/v1/seo/route";v=v.replace(/\/index$/,"")||"/";let w=await k.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:y,params:E,nextConfig:x,parsedUrl:S,isDraftMode:T,prerenderManifest:C,routerServerContext:N,isOnDemandRevalidate:P,revalidateOnlyGenerated:A,resolvedPathname:O,clientReferenceManifest:I,serverActionsManifest:b}=w,D=(0,l.normalizeAppPath)(v),M=!!(C.dynamicRoutes[D]||C.routes[O]),j=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,S,!1):t.end("This page could not be found"),null);if(M&&!T){let e=!!C.routes[O],t=C.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await j();throw new m.NoFallbackError}}let U=null;!M||k.isDev||T||(U="/index"===(U=O)?"/":U);let q=!0===k.isDev||!M,H=M&&!q;b&&I&&(0,a.setReferenceManifestsSingleton)({page:v,clientReferenceManifest:I,serverActionsManifest:b,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:b})});let $=e.method||"GET",L=(0,s.getTracer)(),F=L.getActiveScopeSpan(),G={params:E,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:o.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,o)=>k.onRequestError(e,t,o,N)},sharedContext:{buildId:y}},K=new u.NodeNextRequest(e),B=new u.NodeNextResponse(t),z=c.NextRequestAdapter.fromNodeNextRequest(K,(0,c.signalFromNodeResponse)(t));try{let a=async e=>k.handle(z,G).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=L.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=r.get("next.route");if(o){let t=`${$} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${v}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var s,l;let u=async({previousCacheEntry:r})=>{try{if(!i&&P&&A&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await a(n);e.fetchMetrics=G.renderOpts.fetchMetrics;let l=G.renderOpts.pendingWaitUntil;l&&o.waitUntil&&(o.waitUntil(l),l=void 0);let u=G.renderOpts.collectedTags;if(!M)return await (0,_.sendResponse)(K,B,s,G.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(s.headers);u&&(t[g.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==G.renderOpts.collectedRevalidate&&!(G.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&G.renderOpts.collectedRevalidate,o=void 0===G.renderOpts.collectedExpire||G.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:G.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:o}}}}catch(t){throw(null==r?void 0:r.isStale)&&await k.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:P})},N),t}},c=await k.handleResponse({req:e,nextConfig:x,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:P,revalidateOnlyGenerated:A,responseGenerator:u,waitUntil:o.waitUntil,isMinimalMode:i});if(!M)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",P?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,f.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&M||d.delete(g.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,h.getCacheControlHeader)(c.cacheControl)),await (0,_.sendResponse)(K,B,new Response(c.value.body,{headers:d,status:c.value.status||200})),null};F?await l(F):await L.withPropagatedContext(e.headers,()=>L.trace(d.BaseServerSpan.handleRequest,{spanName:`${$} ${v}`,kind:s.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof m.NoFallbackError||await k.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:P})}),M)throw t;return await (0,_.sendResponse)(K,B,new Response(null,{status:500})),null}}e.s(["handler",()=>K,"patchFetch",()=>G,"routeModule",()=>k,"serverHooks",()=>F,"workAsyncStorage",()=>$,"workUnitAsyncStorage",()=>L],79622)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__0ba4a160._.js.map