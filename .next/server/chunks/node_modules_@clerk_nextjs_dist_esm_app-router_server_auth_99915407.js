module.exports=[7218,40317,13868,57717,e=>{"use strict";e.i(78417);var t=e.i(51564);e.i(51783);var n=e.i(79509),r=e.i(57594);e.i(40726);var a=e.i(62790),s=e.i(347);let i=e=>{if(!e||"string"!=typeof e)return e;try{return(e||"").replace(/^(sk_(live|test)_)(.+?)(.{3})$/,"$1*********$4")}catch{return""}},o=e=>(Array.isArray(e)?e:[e]).map(e=>"string"==typeof e?i(e):JSON.stringify(Object.fromEntries(Object.entries(e).map(([e,t])=>[e,i(t)])),null,2)).join(", "),u=(e,t)=>(...n)=>{let r=("string"==typeof e?()=>{let t=[],n=!1;return{enable:()=>{n=!0},debug:(...e)=>{n&&t.push(e.map(e=>"function"==typeof e?e():e))},commit:()=>{if(n){var r,a;for(let n of(console.log((r=e,`[clerk debug start: ${r}]`)),t)){let e=o(n);e=e.split("\n").map(e=>`  ${e}`).join("\n"),process.env.VERCEL&&(e=function(e,t){let n=new TextEncoder,r=new TextDecoder("utf-8"),a=n.encode(e).slice(0,4096);return r.decode(a).replace(/\uFFFD/g,"")}(e,4096)),console.log(e)}console.log((a=e,`[clerk debug end: ${a}] (@clerk/nextjs=6.36.2,next=${s.default.version},timestamp=${Math.round(new Date().getTime()/1e3)})`))}}}}:e)(),a=t(r);try{let e=a(...n);if("object"==typeof e&&"then"in e&&"function"==typeof e.then)return e.then(e=>(r.commit(),e)).catch(e=>{throw r.commit(),e});return r.commit(),e}catch(e){throw r.commit(),e}};var l=e.i(78538),c=e.i(39184),d=e.i(10698),g=e.i(52119);function h(e){let t=JSON.stringify(e),n=new TextEncoder().encode(t);return d.base64url.stringify(n,{pad:!1})}async function p(e,t,n){if(!n.algorithm)throw Error("No algorithm specified");let r=new TextEncoder,a=(0,d.getCryptoAlgorithm)(n.algorithm);if(!a)return{errors:[new g.SignJWTError(`Unsupported algorithm ${n.algorithm}`)]};let s=await (0,d.importKey)(t,a,"sign"),i=n.header||{typ:"JWT"};i.alg=n.algorithm,e.iat=Math.floor(Date.now()/1e3);let o=h(i),u=h(e),l=`${o}.${u}`;try{let e=await d.runtime.crypto.subtle.sign(a,s,r.encode(l));return{data:`${l}.${d.base64url.stringify(new Uint8Array(e),{pad:!1})}`}}catch(e){return{errors:[new g.SignJWTError(e?.message)]}}}e.i(1618),(0,c.withLegacyReturn)(d.verifyJwt);var m=(0,c.withLegacySyncReturn)(d.decodeJwt);(0,c.withLegacyReturn)(p),(0,c.withLegacyReturn)(d.hasValidSignature);var _=e.i(73271),y=e.i(13832);let T=e=>({authStatus:(0,_.getAuthKeyFromRequest)(e,"AuthStatus"),authToken:(0,_.getAuthKeyFromRequest)(e,"AuthToken"),authMessage:(0,_.getAuthKeyFromRequest)(e,"AuthMessage"),authReason:(0,_.getAuthKeyFromRequest)(e,"AuthReason"),authSignature:(0,_.getAuthKeyFromRequest)(e,"AuthSignature")}),f=(e,n,a=!0)=>{let s=(0,_.getHeader)(e,t.constants.Headers.ClerkRequestData),i=(0,y.decryptClerkRequestData)(s);return{secretKey:(null==n?void 0:n.secretKey)||i.secretKey||r.SECRET_KEY,publishableKey:i.publishableKey||r.PUBLISHABLE_KEY,apiUrl:r.API_URL,apiVersion:r.API_VERSION,authStatus:(0,_.getAuthKeyFromRequest)(e,"AuthStatus"),authMessage:(0,_.getAuthKeyFromRequest)(e,"AuthMessage"),authReason:(0,_.getAuthKeyFromRequest)(e,"AuthReason"),treatPendingAsSignedOut:a}},v=(e,{treatPendingAsSignedOut:n=!0,...r}={})=>{var a,s;let{authStatus:i,authMessage:o,authReason:u,authToken:l,authSignature:c}=T(e);null==(a=r.logger)||a.debug("headers",{authStatus:i,authMessage:o,authReason:u});let d=f(e,r,n);if(!(0,t.isTokenTypeAccepted)(t.TokenType.SessionToken,r.acceptsToken||t.TokenType.SessionToken))return(0,t.signedOutAuthObject)(d);if(i&&i===t.AuthStatus.SignedIn){(0,y.assertTokenSignature)(l,d.secretKey,c);let e=m(l);return null==(s=r.logger)||s.debug("jwt",e.raw),(0,t.getAuthObjectFromJwt)(e,d)}return(0,t.signedOutAuthObject)(d)};var k=e.i(78295);(({debugLoggerName:e,noAuthStatusMessage:n})=>u(e,e=>(r,s)=>((0,a.isTruthy)((0,_.getHeader)(r,t.constants.Headers.EnableDebug))&&e.enable(),(0,y.assertAuthStatus)(r,n),((t,n={})=>v(t,{...n,logger:e,acceptsToken:null==n?void 0:n.acceptsToken}))(r,{...s,logger:e,acceptsToken:null==s?void 0:s.acceptsToken}))))({debugLoggerName:"getAuth()",noAuthStatusMessage:(0,k.getAuthAuthHeaderMissing)()});let A={NOT_FOUND:404,FORBIDDEN:403,UNAUTHORIZED:401};Object.values(A);let S="NEXT_HTTP_ERROR_FALLBACK";function w(){let e=Error(S);throw e.digest=`${S};${A.UNAUTHORIZED}`,e}var b=e.i(63177);let R=e=>{var n,r;return!!e.headers.get(b.constants.Headers.NextUrl)&&!(e.headers.get(b.constants.Headers.NextUrl)&&((null==(n=e.headers.get(t.constants.Headers.Accept))?void 0:n.includes("text/x-component"))||(null==(r=e.headers.get(t.constants.Headers.ContentType))?void 0:r.includes("multipart/form-data"))||e.headers.get(b.constants.Headers.NextAction)))||q()},q=()=>{let e=globalThis.fetch;if(!("__nextPatched"in e&&!0===e.__nextPatched))return!1;let{page:t,pagePath:n}=e.__nextGetStaticStore().getStore()||{};return!!(n||t)},E=e=>!!e.headers.get(b.constants.Headers.NextjsData);var U=e.i(15484);let H=async s=>{var i;e.r(23502);let o=await (0,U.buildRequestLike)(),c=async()=>{if(l.isNextWithUnstableServerActions)return[];try{let t=await e.A(29652).then(e=>e.hasSrcAppDir());return[`Your Middleware exists at ./${t?"src/":""}middleware.(ts|js)`]}catch{return[]}},d=await (({debugLoggerName:n,noAuthStatusMessage:r})=>u(n,n=>async(s,i)=>{if((0,a.isTruthy)((0,_.getHeader)(s,t.constants.Headers.EnableDebug))&&n.enable(),!(0,_.detectClerkMiddleware)(s)){l.isNextWithUnstableServerActions&&(0,y.assertAuthStatus)(s,r);let t=await e.A(29652).then(e=>e.suggestMiddlewareLocation()).catch(()=>void 0);if(t)throw Error(t);(0,y.assertAuthStatus)(s,r)}return((e,r={})=>((e,n={})=>{var r,a;let{authStatus:s,authMessage:i,authReason:o}=T(e);null==(r=n.logger)||r.debug("headers",{authStatus:s,authMessage:i,authReason:o});let u=(0,_.getHeader)(e,t.constants.Headers.ClerkRequestData),l=(0,y.decryptClerkRequestData)(u),c=null==(a=(0,_.getHeader)(e,t.constants.Headers.Authorization))?void 0:a.replace("Bearer ",""),d=n.acceptsToken||t.TokenType.SessionToken,g=f(e,n),h=((e,n,r,a)=>{let s=e&&(0,t.isMachineTokenByPrefix)(e),i=r===t.TokenType.SessionToken||Array.isArray(r)&&1===r.length&&r[0]===t.TokenType.SessionToken;if(s&&n&&!i){let s=(0,t.getAuthObjectForAcceptedToken)({authObject:{...n,debug:()=>a},acceptsToken:r});return{...s,getToken:()=>s.isAuthenticated?Promise.resolve(e):Promise.resolve(null),has:()=>!1}}return null})(c,l.machineAuthObject,d,g);return h||(c&&Array.isArray(d)&&!d.includes(t.TokenType.SessionToken)?(0,t.invalidTokenAuthObject)():v(e,n))})(e,{...r,logger:n,acceptsToken:null==r?void 0:r.acceptsToken}))(s,{...i,logger:n,acceptsToken:null==i?void 0:i.acceptsToken})}))({debugLoggerName:"auth()",noAuthStatusMessage:(0,k.authAuthHeaderMissing)("auth",await c())})(o,{treatPendingAsSignedOut:null==s?void 0:s.treatPendingAsSignedOut,acceptsToken:null!=(i=null==s?void 0:s.acceptsToken)?i:t.TokenType.SessionToken}),g=(0,_.getAuthKeyFromRequest)(o,"ClerkUrl"),h=(...e)=>{let{returnBackUrl:a}=e[0]||{},s=(0,t.createClerkRequest)(o),i=s.clerkUrl.searchParams.get(t.constants.QueryParameters.DevBrowser)||s.cookies.get(t.constants.Cookies.DevBrowser),u=(0,_.getHeader)(o,t.constants.Headers.ClerkRequestData),l=(0,y.decryptClerkRequestData)(u);return[(0,t.createRedirect)({redirectAdapter:n.redirect,devBrowserToken:i,baseUrl:s.clerkUrl.toString(),publishableKey:l.publishableKey||r.PUBLISHABLE_KEY,signInUrl:l.signInUrl||r.SIGN_IN_URL,signUpUrl:l.signUpUrl||r.SIGN_UP_URL,sessionStatus:d.tokenType===t.TokenType.SessionToken?d.sessionStatus:null}),null===a?"":a||(null==g?void 0:g.toString())]};return d.tokenType===t.TokenType.SessionToken?Object.assign(d,{redirectToSignIn:(e={})=>{let[t,n]=h(e);return t.redirectToSignIn({returnBackUrl:n})},redirectToSignUp:(e={})=>{let[t,n]=h(e);return t.redirectToSignUp({returnBackUrl:n})}}):d};H.protect=async(...r)=>{var a,s;e.r(23502);let i=await (0,U.buildRequestLike)(),o=(null==(a=null==r?void 0:r[0])?void 0:a.token)||(null==(s=null==r?void 0:r[1])?void 0:s.token)||t.TokenType.SessionToken,u=await H({acceptsToken:o});return(function(e){let{redirectToSignIn:n,authObject:r,redirect:a,notFound:s,request:i,unauthorized:o}=e;return async(...e)=>{var u,l,c,d,g,h,p,m;let _=(e=>{if(e&&!e.unauthenticatedUrl&&!e.unauthorizedUrl&&!e.token&&(1!==Object.keys(e).length||!("token"in e)))return e})(e[0]),y=(null==(u=e[0])?void 0:u.unauthenticatedUrl)||(null==(l=e[1])?void 0:l.unauthenticatedUrl),T=(null==(c=e[0])?void 0:c.unauthorizedUrl)||(null==(d=e[1])?void 0:d.unauthorizedUrl),f=(null==(g=e[0])?void 0:g.token)||(null==(h=e[1])?void 0:h.token)||t.TokenType.SessionToken,v=()=>r.tokenType!==t.TokenType.SessionToken?o():T?a(T):s();if(!(0,t.isTokenTypeAccepted)(r.tokenType,f))return v();if(r.tokenType!==t.TokenType.SessionToken)return r.isAuthenticated?r:v();if("pending"===r.sessionStatus||!r.userId){return y?a(y):"document"===(p=i).headers.get(t.constants.Headers.SecFetchDest)||"iframe"===p.headers.get(t.constants.Headers.SecFetchDest)||(null==(m=p.headers.get(t.constants.Headers.Accept))?void 0:m.includes("text/html"))||R(p)||E(p)?n():s()}return _?"function"==typeof _?_(r.has)?r:v():r.has(_)?r:v():r}})({request:i,authObject:u,redirectToSignIn:u.redirectToSignIn,notFound:n.notFound,redirect:n.redirect,unauthorized:w})(...r)},e.s(["auth",()=>H],7218);var I=e.i(89171),O=e.i(67404);class x extends Error{status;constructor(e,t){super(t),this.status=e,this.name="HttpError"}}e.s(["HttpError",()=>x],40317);var K=e.i(44070);function N(e){if(!e)return;let t=e.trim().toLowerCase();return t.length?t:void 0}let D={ingestion:{column:"ingestion_count",quotaKey:"ingestion"},seo:{column:"seo_count",quotaKey:"seo"},variants:{column:"variants_count",quotaKey:"variants"},match:{column:"match_count",quotaKey:"match"}};async function F(e,t){let n,r=(n=process.env.OWNER_EMAILS)?n.split(",").map(e=>N(e)??"").filter(e=>!!e):[];if(0===r.length)return!1;let a=N(t);if(a)return r.includes(a);try{let t=await (0,O.clerkClient)(),n=await t.users.getUser(e),a=N(n.primaryEmailAddress?.emailAddress)||N(n.emailAddresses?.[0]?.emailAddress);if(!a)return!1;return r.includes(a)}catch(e){return console.error("Failed to resolve owner override",e),!1}}function C(e){let t=e.headers.get("x-tenant-id");return t||(new URL(e.url).searchParams.get("tenant_id")??void 0)}async function L(e,t){let n=(0,K.getServiceSupabaseClient)().from("team_members").select("tenant_id, role").eq("user_id",e).order("created_at",{ascending:!0}).limit(1);t&&(n=n.eq("tenant_id",t));let{data:r,error:a}=await n;if(a)throw Error(a.message);let s=r?.[0];if(!s)throw new x(403,"No tenant membership found for user.");return{tenantId:s.tenant_id,role:s.role}}async function j(e){var t;let n=(0,K.getServiceSupabaseClient)(),{data:r,error:a}=await n.from("tenant_subscriptions").select("plan_name, status, current_period_end, ingestion_quota, seo_quota, variant_quota, match_quota").eq("tenant_id",e).order("current_period_end",{ascending:!1}).limit(1);if(a)throw Error(a.message);let s=r?.[0];return{planName:s?.plan_name??null,status:s?.status??null,currentPeriodEnd:s?.current_period_end??null,quotas:{ingestion:s?.ingestion_quota??null,seo:s?.seo_quota??null,variants:s?.variant_quota??null,match:s?.match_quota??null},isActive:!!(t=s?.status??null)&&["active","trialing","paid"].includes(t)}}async function P(e){let t=(0,K.getServiceSupabaseClient)(),{data:n,error:r}=await t.from("usage_counters").select("id, tenant_id, period_start, ingestion_count, seo_count, variants_count, match_count, updated_at").eq("tenant_id",e).order("period_start",{ascending:!1}).limit(1);if(r)throw Error(r.message);if(n&&n.length>0){let e=n[0];return{id:e.id,tenant_id:e.tenant_id,period_start:e.period_start,ingestion_count:e.ingestion_count??0,seo_count:e.seo_count??0,variants_count:e.variants_count??0,match_count:e.match_count??0,updated_at:e.updated_at??void 0}}let a=new Date().toISOString().slice(0,10),{data:s,error:i}=await t.from("usage_counters").insert({tenant_id:e,period_start:a}).select("id, tenant_id, period_start, ingestion_count, seo_count, variants_count, match_count, updated_at").limit(1);if(i)throw Error(i.message);let o=s?.[0];return{id:o.id,tenant_id:o.tenant_id,period_start:o.period_start,ingestion_count:o.ingestion_count??0,seo_count:o.seo_count??0,variants_count:o.variants_count??0,match_count:o.match_count??0,updated_at:o.updated_at??void 0}}async function $(e,t,n){let r=(0,K.getServiceSupabaseClient)(),{column:a}=D[t],s=e[a]+n,{error:i}=await r.from("usage_counters").update({[a]:s,updated_at:new Date().toISOString()}).eq("id",e.id);if(i)throw Error(i.message);return{...e,[a]:s}}async function M({userId:e,requestedTenantId:t,userEmail:n}){let r=await L(e,t),a=await j(r.tenantId),s=await P(r.tenantId),i="owner"===r.role||await F(e,n)?"owner":r.role;return{tenantId:r.tenantId,role:i,subscription:a,usage:s}}async function B({userId:e,requestedTenantId:t,feature:n,increment:r=1,userEmail:a}){let s=await M({userId:e,requestedTenantId:t,userEmail:a}),i="owner"===s.role;if(!i&&!s.subscription.isActive)throw new x(402,"An active subscription is required for this action.");if(n){let{quotaKey:e}=D[n],t=s.subscription.quotas[e],a=s.usage[D[n].column]+r;if(!i&&null!==t&&a>t)throw new x(402,"Quota exceeded for this plan. Please upgrade to continue.");let o=await $(s.usage,n,r);return{...s,usage:o}}return s}function J(e){return e instanceof x?I.NextResponse.json({error:e.message},{status:e.status}):(console.error(e),I.NextResponse.json({error:"Internal server error"},{status:500}))}function W(e){if(!e)return;for(let t of["email","email_address"]){let n=e[t];if("string"==typeof n&&n.length>0)return n}let t=e.email_addresses;if(Array.isArray(t)){let e=t.find(e=>"string"==typeof e);if(e)return e}}e.s(["handleRouteError",()=>J,"requireSubscriptionAndUsage",()=>B,"tenantFromRequest",()=>C],13868),e.s(["extractEmailFromSessionClaims",()=>W],57717)}];

//# sourceMappingURL=node_modules_%40clerk_nextjs_dist_esm_app-router_server_auth_99915407.js.map