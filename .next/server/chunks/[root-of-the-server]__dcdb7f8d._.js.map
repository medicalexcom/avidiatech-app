{"version":3,"sources":["../../../src/lib/ingest/signature.ts"],"sourcesContent":["// HMAC SHA256 signing helpers for gateway <-> ingestion engine\n// Usage:\n//   const sig = signPayload(JSON.stringify(payload), process.env.INGEST_SECRET);\n//   const ok = verifySignature(JSON.stringify(payload), sig, process.env.INGEST_SECRET);\n\nimport crypto from \"crypto\";\n\nexport function signPayload(payload: string, secret: string): string {\n  if (!secret || !payload) return \"\";\n  return crypto.createHmac(\"sha256\", secret).update(payload).digest(\"hex\");\n}\n\n/**\n * Try to parse provided signature into a Buffer.\n * Accepts:\n *  - raw hex (e.g. \"a3f...\")\n *  - prefixed hex (e.g. \"sha256=a3f...\")\n *  - base64 (e.g. \"AbC...==\")\n */\nfunction signatureToBuffer(sig?: string | null): Buffer | null {\n  if (!sig) return null;\n  sig = sig.trim();\n\n  // strip common prefix 'sha256=' if present\n  if (sig.toLowerCase().startsWith(\"sha256=\")) {\n    sig = sig.slice(\"sha256=\".length);\n  }\n\n  // try hex\n  try {\n    if (/^[0-9a-fA-F]+$/.test(sig)) {\n      return Buffer.from(sig, \"hex\");\n    }\n  } catch (err) {\n    // ignore\n  }\n\n  // try base64\n  try {\n    return Buffer.from(sig, \"base64\");\n  } catch (err) {\n    // ignore\n  }\n\n  return null;\n}\n\nexport function verifySignature(\n  payload: string,\n  signature: string | undefined | null,\n  secret: string\n): boolean {\n  if (!secret) return false;\n  if (!signature) return false;\n  try {\n    const expectedHex = signPayload(payload, secret);\n    const expectedBuf = Buffer.from(expectedHex, \"hex\");\n\n    const actualBuf = signatureToBuffer(signature);\n    if (!actualBuf) return false;\n\n    // Must match length for timingSafeEqual\n    if (expectedBuf.length !== actualBuf.length) return false;\n\n    return crypto.timingSafeEqual(expectedBuf, actualBuf);\n  } catch (err) {\n    return false;\n  }\n}\n"],"names":[],"mappings":"q7BAKA,IAAA,EAAA,EAAA,CAAA,CAAA,OAEO,SAAS,EAAY,CAAe,CAAE,CAAc,SACzD,AAAI,AAAC,GAAW,EACT,EAAA,GADQ,EAAU,EACZ,CAAC,UAAU,CAAC,SAAU,GAAQ,MAAM,CAAC,GAAS,MAAM,CAAC,OADlC,EAElC,CAqCO,SAAS,EACd,CAAe,CACf,CAAoC,CACpC,CAAc,EAEd,GAAI,CAAC,GACD,CAAC,EADQ,OAAO,EACJ,AAChB,GAAI,CACF,GAFqB,CAEf,EAAc,EAAY,EAAS,GACnC,EAAc,OAAO,IAAI,CAAC,EAAa,OAEvC,EAAY,AAvCtB,SAAS,AAAkB,CAAmB,EAC5C,GAAI,CAAC,EAAK,OAAO,KAIb,CAHJ,EAAM,EAAI,IAAI,EAAA,EAGN,WAAW,GAAG,UAAU,CAAC,YAAY,CAC3C,EAAM,EAAI,KAAK,CAAC,EAAgB,EAIlC,GAAI,CACF,EAL0B,CAKtB,iBAAiB,IAAI,CAAC,GACxB,GAD8B,IACvB,OAAO,IAAI,CAAC,EAAK,MAE5B,CAAE,MAAO,EAAK,CAEd,CAGA,GAAI,CACF,OAAO,OAAO,IAAI,CAAC,EAAK,SAC1B,CAAE,MAAO,EAAK,CAEd,CAEA,OAAO,IACT,EAawC,GACpC,GAAI,CAAC,GAGD,EAAY,MAAM,GAAK,EAAU,MAAM,CAH3B,CAG6B,MAHtB,CAG6B,CAEpD,OAAO,EAAA,OAAM,CAAC,eAAe,CAAC,EAAa,EAC7C,CAAE,MAAO,EAAK,CACZ,OAAO,CACT,CACF"}