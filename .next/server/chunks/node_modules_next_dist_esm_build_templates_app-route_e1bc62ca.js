module.exports=[76020,e=>{"use strict";var t=e.i(47909),r=e.i(74017),n=e.i(96250),a=e.i(59756),s=e.i(61916),i=e.i(14444),o=e.i(37092),l=e.i(69741),u=e.i(16795),c=e.i(87718),d=e.i(95169),p=e.i(47587),m=e.i(66012),f=e.i(70101),h=e.i(26937),_=e.i(10372),g=e.i(93695);e.i(52474);var y=e.i(5232),w=e.i(89171),v=e.i(87914),R=e.i(24389);let E=process.env.SUPABASE_URL??"",S=process.env.SUPABASE_SERVICE_ROLE_KEY??"",b=process.env.SUPABASE_GLOBAL_TENANT_ID??"global";E&&S||console.warn("Supabase service role or URL not configured. Supabase helpers will no-op when used.");let A=E&&S?(0,R.createClient)(E,S,{auth:{persistSession:!1}}):null;async function N({tenantId:e,type:t="describe",status:r="success",normalizedPayload:n,rawPayload:a,userId:s,sourceUrl:i}){if(!E||!S||!A)return{id:null};let o={tenant_id:e??b,user_id:s??null,type:t,status:r,normalized_payload:n??null,raw_payload:a??null,created_at:new Date().toISOString()};"string"==typeof i&&i.length>0&&(o.source_url=i);let{data:l,error:u}=await A.from("product_ingestions").insert([o]).select("id").limit(1).maybeSingle();if(u)throw console.error("saveIngestion error:",u),u;return l}async function O({tenantId:e,metric:t="describe_calls",incrementBy:r=1}){if(!E||!S||!A)return null;let n=new Date().toISOString(),a=e??b;try{let{data:e,error:s}=await A.from("usage_counters").select("count").eq("tenant_id",a).eq("metric",t).limit(1).maybeSingle();if(s)throw console.error("incrementUsageCounter: fetch error",s),s;if(e&&void 0!==e.count){let s=Number(e.count??0)+Number(r),{error:i}=await A.from("usage_counters").update({count:s,updated_at:n}).eq("tenant_id",a).eq("metric",t);if(i)throw console.error("incrementUsageCounter: update error",i),i;return!0}{let{error:e}=await A.from("usage_counters").insert([{tenant_id:a,metric:t,count:r,updated_at:n}]);if(e)throw console.error("incrementUsageCounter: insert error",e),e;return!0}}catch(e){throw console.error("incrementUsageCounter unexpected error:",e),e}}async function T({tenantId:e,metric:t="describe_calls",limit:r=1/0}){if(!E||!S||!A)return!0;let n=e??b;try{let{data:e,error:a}=await A.from("usage_counters").select("count").eq("tenant_id",n).eq("metric",t).limit(1).maybeSingle();if(a)throw console.error("checkQuota query error:",a),a;return Number(e?.count??0)<r}catch(e){return console.error("checkQuota unexpected error:",e),!0}}var x=e.i(13108);e.i(89228);var C=e.i(91601);let I=process.env.OPENAI_API_KEY||"",P=process.env.OPENAI_DESCRIBE_MODEL||process.env.OPENAI_SEO_MODEL||process.env.OPENAI_MODEL||"gpt-4.1",U=new C.default({apiKey:I});function D(e,t=12e3){let r=String(e||"");return r.length>t?r.slice(0,t)+"â€¦(truncated)":r}function q(e){return"string"==typeof e&&e.trim().length>0}function M(e,t){if(!e){let e=Error(t);throw e.code="describe_invalid_model_output",e}}async function j(e){let t;if(!I)throw Error("OPENAI_API_KEY not configured");let r={model:P,input:[{role:"system",content:e.system},{role:"user",content:e.user}],temperature:.1,max_output_tokens:12e3,text:{format:{type:"json_schema",name:"AvidiaDescribeFull",strict:!0,schema:{type:"object",additionalProperties:!1,required:["descriptionHtml","sections","seo","features","data_gaps"],properties:{descriptionHtml:{type:"string"},sections:{type:"object",additionalProperties:!1,required:["overview","hook","mainDescription","featuresBenefits","specifications","internalLinks","whyChoose","manuals","faqs"],properties:{overview:{type:"string"},hook:{type:"string"},mainDescription:{type:"string"},featuresBenefits:{type:"string"},specifications:{type:"string"},internalLinks:{type:"string"},whyChoose:{type:"string"},manuals:{type:"string"},faqs:{type:"string"}}},seo:{type:"object",additionalProperties:!1,required:["h1","title","metaDescription"],properties:{h1:{type:"string"},title:{type:"string"},metaDescription:{type:"string"}}},features:{type:"array",items:{type:"string"}},data_gaps:{type:"array",items:{type:"string"}}}}}}},n=function(e){let t=e?.output?.at?.(0)??e?.output?.[0]??null;if(!t)return"";let r=t?.content;if("string"==typeof r)return r;if(Array.isArray(r)){let e="";for(let t of r)"string"==typeof t?e+=t:t?.text&&"string"==typeof t.text?e+=t.text:t?.content&&"string"==typeof t.content&&(e+=t.content);return e}if("string"==typeof t?.text)return t.text;try{return JSON.stringify(t)}catch{return""}}(await U.responses.create(r));try{t=JSON.parse(n)}catch(t){let e=Error("describe_invalid_json_from_responses_api");throw e.raw=n,e}return{json:t,rawText:n}}async function H(e){let t=`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,r="true"===process.env.DEBUG_DESCRIBE_MODEL_OUTPUT;try{let n,a=(0,v.safeGetAuth)(e);if(!a?.userId)return w.NextResponse.json({error:"Unauthorized"},{status:401});let s=a.userId,i=a.actor?.tenantId||null,o=await e.json().catch(()=>null);if(!o)return w.NextResponse.json({error:"Invalid JSON body"},{status:422});let l=o.name?.trim(),u=o.shortDescription?.trim();if(!l||!u)return w.NextResponse.json({error:"Validation failed: name and shortDescription are required"},{status:422});try{if(!await T({tenantId:i,metric:"describe_calls",limit:1/0}))return w.NextResponse.json({error:"Quota exceeded"},{status:402})}catch{}let{text:c,source:d}=await (0,x.loadCustomGptInstructionsWithInfo)(i);M(q(c),"custom_gpt_instructions_missing_or_empty");let p={name_raw:l,description_raw:u,browsed_text:u,dom:{name_raw:l,description_raw:u,specs:o.specs??{},brand:o.brand??null},pdf_text:"",pdf_docs:[],pdf_manual_urls:[],manuals:[],specs_structured:o.specs??{},brand:o.brand??null},m=["You are AvidiaDescribe.\nABSOLUTE PRIORITY: Follow the CUSTOM GPT INSTRUCTIONS below exactly. They override all other guidance.\n\nHARD REQUIREMENTS:\n1) Output MUST include ALL required sections/fields per the JSON schema (even if some are 'Not available').\n2) Do NOT invent facts. Use ONLY the packet fields as grounding.\n3) If info is missing, still output the section and add a note in data_gaps (data_gaps can be empty).\n4) The formatting/structure of the HTML content MUST follow the CUSTOM GPT INSTRUCTIONS.\n\nCUSTOM GPT INSTRUCTIONS (AUTHORITATIVE):",c.trim()].join("\n"),f=["GROUND TRUTH PACKET (JSON):",JSON.stringify(p,null,2),"\nGenerate the full SEO description output now, following the instructions."].join("\n"),h="";try{let e=await j({system:m,user:f});n=e.json,h=e.rawText}catch(e){try{await N({tenantId:i,userId:s,type:"describe",status:"failed",rawPayload:{requestId:t,model:P,instruction_source:d||null,request:{name:l,shortDescription:u,brand:o.brand??null,specs:o.specs??null,format:o.format??null},error:String(e?.message||e),raw:D(String(e?.raw||h||""))}})}catch{}return w.NextResponse.json({error:"Describe model returned invalid JSON",...r?{detail:String(e?.message||e),debug:{requestId:t,model:P,raw_snippet:D(String(e?.raw||h||"")),instruction_source:d||null}}:{}},{status:502})}M(q(n?.descriptionHtml),"missing_descriptionHtml"),M(q(n?.sections?.overview),"missing_sections.overview"),M(q(n?.seo?.h1),"missing_seo.h1"),M(q(n?.seo?.title),"missing_seo.title"),M(q(n?.seo?.metaDescription),"missing_seo.metaDescription"),M(Array.isArray(n?.features),"missing_features_array"),M(Array.isArray(n?.data_gaps),"missing_data_gaps_array");try{await N({tenantId:i,userId:s,type:"describe",status:"success",normalizedPayload:n.normalizedPayload??null,rawPayload:n??null})}catch{}try{await O({tenantId:i,metric:"describe_calls",incrementBy:1})}catch{}return w.NextResponse.json({...n,_debug:{requestId:t,model:P,instruction_source:d||null,mode:"json_schema_closed_objects_required_all_properties"}})}catch(e){if(e?.code==="describe_invalid_model_output")return w.NextResponse.json({error:"describe_model_invalid_output",detail:e?.message||"invalid_output"},{status:502});return w.NextResponse.json({error:e?.message||"Unknown error"},{status:500})}}e.s(["POST",()=>H],20503);var k=e.i(20503);let L=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/v1/describe/route",pathname:"/api/v1/describe",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/v1/describe/route.ts",nextConfigOutput:"",userland:k}),{workAsyncStorage:B,workUnitAsyncStorage:K,serverHooks:G}=L;function $(){return(0,n.patchFetch)({workAsyncStorage:B,workUnitAsyncStorage:K})}async function F(e,t,n){L.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/v1/describe/route";w=w.replace(/\/index$/,"")||"/";let v=await L.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:R,params:E,nextConfig:S,parsedUrl:b,isDraftMode:A,prerenderManifest:N,routerServerContext:O,isOnDemandRevalidate:T,revalidateOnlyGenerated:x,resolvedPathname:C,clientReferenceManifest:I,serverActionsManifest:P}=v,U=(0,l.normalizeAppPath)(w),D=!!(N.dynamicRoutes[U]||N.routes[C]),q=async()=>((null==O?void 0:O.render404)?await O.render404(e,t,b,!1):t.end("This page could not be found"),null);if(D&&!A){let e=!!N.routes[C],t=N.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await q();throw new g.NoFallbackError}}let M=null;!D||L.isDev||A||(M="/index"===(M=C)?"/":M);let j=!0===L.isDev||!D,H=D&&!j;P&&I&&(0,i.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:I,serverActionsManifest:P,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:P})});let k=e.method||"GET",B=(0,s.getTracer)(),K=B.getActiveScopeSpan(),G={params:E,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>L.onRequestError(e,t,n,O)},sharedContext:{buildId:R}},$=new u.NodeNextRequest(e),F=new u.NodeNextResponse(t),J=c.NextRequestAdapter.fromNodeNextRequest($,(0,c.signalFromNodeResponse)(t));try{let i=async e=>L.handle(J,G).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=B.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${k} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${w}`)}),o=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var s,l;let u=async({previousCacheEntry:r})=>{try{if(!o&&T&&x&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(a);e.fetchMetrics=G.renderOpts.fetchMetrics;let l=G.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let u=G.renderOpts.collectedTags;if(!D)return await (0,m.sendResponse)($,F,s,G.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(s.headers);u&&(t[_.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==G.renderOpts.collectedRevalidate&&!(G.renderOpts.collectedRevalidate>=_.INFINITE_CACHE)&&G.renderOpts.collectedRevalidate,n=void 0===G.renderOpts.collectedExpire||G.renderOpts.collectedExpire>=_.INFINITE_CACHE?void 0:G.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await L.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})},O),t}},c=await L.handleResponse({req:e,nextConfig:S,cacheKey:M,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:x,responseGenerator:u,waitUntil:n.waitUntil,isMinimalMode:o});if(!D)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",T?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,f.fromNodeOutgoingHttpHeaders)(c.value.headers);return o&&D||d.delete(_.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,h.getCacheControlHeader)(c.cacheControl)),await (0,m.sendResponse)($,F,new Response(c.value.body,{headers:d,status:c.value.status||200})),null};K?await l(K):await B.withPropagatedContext(e.headers,()=>B.trace(d.BaseServerSpan.handleRequest,{spanName:`${k} ${w}`,kind:s.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await L.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})}),D)throw t;return await (0,m.sendResponse)($,F,new Response(null,{status:500})),null}}e.s(["handler",()=>F,"patchFetch",()=>$,"routeModule",()=>L,"serverHooks",()=>G,"workAsyncStorage",()=>B,"workUnitAsyncStorage",()=>K],76020)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_e1bc62ca.js.map