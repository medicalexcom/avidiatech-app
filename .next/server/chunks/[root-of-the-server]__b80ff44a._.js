module.exports=[93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},14747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},72195,e=>{"use strict";var t=e.i(45850);let{PostgrestError:r,FunctionsHttpError:n,FunctionsFetchError:o,FunctionsRelayError:s,FunctionsError:a,FunctionRegion:i,SupabaseClient:l,createClient:u,GoTrueAdminApi:c,GoTrueClient:d,AuthAdminApi:p,AuthClient:_,navigatorLock:f,NavigatorLockAcquireTimeoutError:g,lockInternals:h,processLock:m,SIGN_OUT_SCOPES:E,AuthError:v,AuthApiError:R,AuthUnknownError:S,CustomAuthError:x,AuthSessionMissingError:w,AuthInvalidTokenResponseError:y,AuthInvalidCredentialsError:A,AuthImplicitGrantRedirectError:P,AuthPKCEGrantCodeExchangeError:C,AuthRetryableFetchError:N,AuthWeakPasswordError:T,AuthInvalidJwtError:b,isAuthError:O,isAuthApiError:I,isAuthSessionMissingError:U,isAuthImplicitGrantRedirectError:j,isAuthRetryableFetchError:D,isAuthWeakPasswordError:q,RealtimePresence:L,RealtimeChannel:B,RealtimeClient:M,REALTIME_LISTEN_TYPES:k,REALTIME_POSTGRES_CHANGES_LISTEN_EVENT:K,REALTIME_PRESENCE_LISTEN_EVENTS:$,REALTIME_SUBSCRIBE_STATES:H,REALTIME_CHANNEL_STATES:F}=t.default||t;t.default,e.s(["createClient",()=>u])},44070,e=>{"use strict";var t=e.i(72195);let r=process.env.NEXT_PUBLIC_SUPABASE_URL||process.env.SUPABASE_URL,n=process.env.SUPABASE_SERVICE_ROLE_KEY||process.env.SUPABASE_ANON_KEY,o=null;r&&n?o=(0,t.createClient)(r,n):console.warn("Supabase client not configured (missing SUPABASE_URL or KEY). Some server operations will fail until configured.");let s=o,a=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY??process.env.SUPABASE_ANON_KEY,i=process.env.SUPABASE_SERVICE_ROLE_KEY,l=null;function u(){return r&&i?(l||(l=(0,t.createClient)(r,i,{})),l):null}function c(){let e=u();if(!e)throw Error("Server Supabase client is not configured. Ensure SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY are set in the environment.");return e}let d=null;function p(){return r&&a?(d||(d=(0,t.createClient)(r,a,{})),d):(console.warn("Browser Supabase client not configured (missing NEXT_PUBLIC_SUPABASE_URL or NEXT_PUBLIC_SUPABASE_ANON_KEY)."),null)}let _=r&&i?(0,t.createClient)(r,i):null,f=r&&a?(0,t.createClient)(r,a):null;e.s(["browserSupabase",0,f,"getBrowserSupabase",()=>p,"getServerSupabase",()=>c,"getServerSupabaseSafe",()=>u,"getServiceSupabaseClient",0,c,"serverSupabase",0,_,"supabase",0,s])},22734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},92509,(e,t,r)=>{t.exports=e.x("url",()=>require("url"))},24868,(e,t,r)=>{t.exports=e.x("fs/promises",()=>require("fs/promises"))},6167,e=>{"use strict";var t=e.i(44070),r=e.i(22734),n=e.i(14747),o=e.i(92509),s=e.i(24868);let a=process.env.RENDER_PROMPTS_REPO||"medicalexcom/medx-ingest-api",i=process.env.RENDER_PROMPTS_COMMIT||"34dd54c508824b84d2ad3cd21d782af219044718",l=parseInt(process.env.RENDER_PROMPTS_TTL_SECONDS||"600",10),u=null;async function c(){for(let e of[n.default.join(process.cwd(),"tools","render-engine","prompts","custom_gpt_instructions.md"),n.default.join(process.cwd(),"tools","render-engine","prompts","custom_gpt_instructions.txt"),n.default.join(process.cwd(),"tools","render-engine","prompts","custom_gpt_instructions","custom_gpt_instructions.md"),n.default.join(process.cwd(),"src","tools","render-engine","prompts","custom_gpt_instructions.md")])try{let t=await s.default.stat(e).catch(()=>null);if(t&&t.isFile()){let t=await s.default.readFile(e,{encoding:"utf8"});if(t&&t.trim().length>0)return console.info("loadInstructions: loaded local prompt from",e),t}}catch(e){}return null}async function d(){let e=process.env.RENDER_PROMPTS_REPO||a,t=process.env.RENDER_PROMPTS_COMMIT||i,r=`https://raw.githubusercontent.com/${e}/${t}/tools/render-engine/prompts/custom_gpt_instructions.md`;try{let e=new AbortController,t=setTimeout(()=>e.abort(),8e3),n=await fetch(r,{signal:e.signal});if(clearTimeout(t),!n.ok)return console.warn(`loadInstructions: raw fetch failed ${n.status} ${r}`),null;return await n.text()||null}catch(e){return console.warn("loadInstructions: fetch error",String(e)),null}}async function p(t){if(!t)return null;try{let{getServiceSupabaseClient:r}=e.r(44070),n=r(),{data:o,error:s}=await n.from("tenant_settings").select("custom_gpt_instructions").eq("tenant_id",t).limit(1).single();if(s||!o)return null;let a=o.custom_gpt_instructions;return"string"==typeof a&&a.trim().length>0?a:null}catch(e){return console.warn("loadInstructions: tenant override lookup failed:",String(e)),null}}async function _(e){try{let t=await p(e??null);if(t)return u={value:t,fetchedAt:Date.now(),source:"tenant"},{text:t,source:"tenant"}}catch{}let t=Date.now();if(u&&(t-u.fetchedAt)/1e3<l)return{text:u.value,source:"cache"};try{let e=await c();if(e)return u={value:e,fetchedAt:Date.now(),source:"local"},{text:e,source:"local"}}catch(e){console.warn("loadInstructions: local read attempt failed:",String(e))}let r=await d();return r?(u={value:r,fetchedAt:Date.now(),source:"remote"},{text:r,source:"remote"}):(u={value:null,fetchedAt:Date.now(),source:"none"},{text:null,source:"none"})}let f=process.env.CENTRAL_GPT_URL||"",g=process.env.CENTRAL_GPT_KEY||"";async function h(e,t,s,a){let i;if(!f||!g)throw Error("central_gpt_not_configured: CENTRAL_GPT_URL / CENTRAL_GPT_KEY missing");let{text:l,source:u}=await _(a??null),c=({module:e="seo",payload:t,correlationId:r,customInstructions:n,instructionsSource:o})=>{let s="string"==typeof n?n.trim():"";return{module:e,payload:t,correlation_id:r||void 0,custom_gpt_instructions:s.length>0?s:void 0,instruction_source:o||void 0,enforce_instructions:s.length>0,audit:{format:"avidia_seo_v1"}}};try{let e=n.default.join(process.cwd(),"../medx-ingest-api/tools/render-engine/gptInstructionsEnforcer.mjs");if(r.default.existsSync(e)){(0,o.pathToFileURL)(e).toString();let t=await Promise.resolve().then(()=>{let e=Error("Cannot find module as expression is too dynamic");throw e.code="MODULE_NOT_FOUND",e});c=t.buildSeoRequestBody||t.default?.buildSeoRequestBody||c,console.log("[api/v1/seo] using shared gptInstructionsEnforcer module")}else console.log("[api/v1/seo] shared gptInstructionsEnforcer not present; using built-in body builder")}catch(e){console.warn("[api/v1/seo] unable to load shared gptInstructionsEnforcer",e?.message||e)}let d=c?c({module:"seo",payload:e,correlationId:t||void 0,customInstructions:l,instructionsSource:u}):{module:"seo",payload:e,correlation_id:t||void 0,custom_gpt_instructions:l||void 0,instruction_source:u||void 0,enforce_instructions:!!l},p=await fetch(f,{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${g}`},body:JSON.stringify(d)}),h=await p.text();if(!p.ok)throw console.error("[api/v1/seo] central GPT non-200",p.status,h?.slice(0,500)),Error(`central_gpt_seo_error: ${p.status} ${h||"(empty body)"}`);try{i=JSON.parse(h)}catch(e){throw console.error("[api/v1/seo] central GPT returned non-JSON",e?.message||e,"raw=",h?.slice(0,500)),Error("central_gpt_invalid_json")}let m=e||{},E=i?.seo||m?.seo||{},v=i?.description_html||i?.description||m?.description_html||null,R=Array.isArray(i?.features)?i.features:m?.features??null;return console.log("[api/v1/seo] central GPT SEO summary",{hasSeo:!!E,hasDescription:!!v,featuresCount:Array.isArray(R)?R.length:null,sourceUrl:s||null,instructionsSource:u||null}),{seo_payload:E,description_html:v,features:R}}async function m(e){let r=(0,t.getServiceSupabaseClient)(),{data:n,error:o}=await r.from("product_ingestions").select("id, tenant_id, user_id, source_url, normalized_payload, seo_payload, description_html, features, correlation_id, diagnostics, status").eq("id",e).maybeSingle();if(o)throw Error(`ingestion_load_failed: ${o.message||String(o)}`);if(!n)throw Error("ingestion_not_found");if(!n.normalized_payload)throw Error("ingestion_not_ready");let s=n.normalized_payload,a=new Date().toISOString(),i=await h(s,n.correlation_id||null,n.source_url||null,n.tenant_id||null),l=new Date().toISOString(),u=n.diagnostics||{},c={...u.seo||{},last_run_at:l,started_at:a,status:"completed"},d={...u,seo:c},{data:p,error:_}=await r.from("product_ingestions").update({seo_payload:i.seo_payload,description_html:i.description_html,features:i.features,seo_generated_at:l,diagnostics:d,updated_at:l}).eq("id",n.id).select("id, seo_payload, description_html, features").maybeSingle();if(_)throw Error(`seo_persist_failed: ${_.message||String(_)}`);return console.log("[api/v1/seo] SEO persisted",{ingestionId:n.id,hasSeo:!!p?.seo_payload,hasDescription:!!p?.description_html,featuresCount:Array.isArray(p?.features)?p?.features.length:null}),{ingestionId:n.id,seo_payload:p?.seo_payload??i.seo_payload,description_html:p?.description_html??i.description_html,features:p?.features??i.features}}e.s(["runSeoForIngestion",()=>m],6167)},54696,e=>{"use strict";var t=e.i(47909),r=e.i(74017),n=e.i(96250),o=e.i(59756),s=e.i(61916),a=e.i(14444),i=e.i(37092),l=e.i(69741),u=e.i(16795),c=e.i(87718),d=e.i(95169),p=e.i(47587),_=e.i(66012),f=e.i(70101),g=e.i(26937),h=e.i(10372),m=e.i(93695);e.i(52474);var E=e.i(5232),v=e.i(89171),R=e.i(6167);async function S(e){let t=e.headers.get("x-pipeline-secret")||"",r=process.env.PIPELINE_INTERNAL_SECRET||"";if(!r||t!==r)return v.NextResponse.json({error:"unauthorized"},{status:401});let n=await e.json().catch(()=>({})),o=n?.ingestionId?.toString()||"";if(!o)return v.NextResponse.json({error:"missing_ingestionId"},{status:400});try{let e=await (0,R.runSeoForIngestion)(o);return v.NextResponse.json(e,{status:200})}catch(t){let e=t?.message||String(t);if("ingestion_not_found"===e)return v.NextResponse.json({error:"ingestion_not_found"},{status:404});if("ingestion_not_ready"===e)return v.NextResponse.json({error:"ingestion_not_ready"},{status:409});if(e.startsWith("ingestion_load_failed:"))return v.NextResponse.json({error:"ingestion_load_failed",detail:e},{status:500});if("central_gpt_invalid_json"===e||e.startsWith("central_gpt_not_configured:")||e.startsWith("central_gpt_seo_error:"))return v.NextResponse.json({error:"seo_model_failed",detail:e},{status:500});if(e.startsWith("seo_persist_failed:"))return v.NextResponse.json({error:"seo_persist_failed",detail:e},{status:500});return v.NextResponse.json({error:"seo_internal_failed",detail:e},{status:500})}}e.s(["POST",()=>S],61644);var x=e.i(61644);let w=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/v1/pipeline/internal/seo/route",pathname:"/api/v1/pipeline/internal/seo",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/v1/pipeline/internal/seo/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:y,workUnitAsyncStorage:A,serverHooks:P}=w;function C(){return(0,n.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:A})}async function N(e,t,n){w.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/v1/pipeline/internal/seo/route";v=v.replace(/\/index$/,"")||"/";let R=await w.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:S,params:x,nextConfig:y,parsedUrl:A,isDraftMode:P,prerenderManifest:C,routerServerContext:N,isOnDemandRevalidate:T,revalidateOnlyGenerated:b,resolvedPathname:O,clientReferenceManifest:I,serverActionsManifest:U}=R,j=(0,l.normalizeAppPath)(v),D=!!(C.dynamicRoutes[j]||C.routes[O]),q=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,A,!1):t.end("This page could not be found"),null);if(D&&!P){let e=!!C.routes[O],t=C.dynamicRoutes[j];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await q();throw new m.NoFallbackError}}let L=null;!D||w.isDev||P||(L="/index"===(L=O)?"/":L);let B=!0===w.isDev||!D,M=D&&!B;U&&I&&(0,a.setReferenceManifestsSingleton)({page:v,clientReferenceManifest:I,serverActionsManifest:U,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:U})});let k=e.method||"GET",K=(0,s.getTracer)(),$=K.getActiveScopeSpan(),H={params:x,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:B,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>w.onRequestError(e,t,n,N)},sharedContext:{buildId:S}},F=new u.NodeNextRequest(e),G=new u.NodeNextResponse(t),Y=c.NextRequestAdapter.fromNodeNextRequest(F,(0,c.signalFromNodeResponse)(t));try{let a=async e=>w.handle(Y,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=K.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${k} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${v}`)}),i=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var s,l;let u=async({previousCacheEntry:r})=>{try{if(!i&&T&&b&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await a(o);e.fetchMetrics=H.renderOpts.fetchMetrics;let l=H.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let u=H.renderOpts.collectedTags;if(!D)return await (0,_.sendResponse)(F,G,s,H.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(s.headers);u&&(t[h.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,n=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await w.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:T})},N),t}},c=await w.handleResponse({req:e,nextConfig:y,cacheKey:L,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:b,responseGenerator:u,waitUntil:n.waitUntil,isMinimalMode:i});if(!D)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",T?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),P&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,f.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&D||d.delete(h.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,g.getCacheControlHeader)(c.cacheControl)),await (0,_.sendResponse)(F,G,new Response(c.value.body,{headers:d,status:c.value.status||200})),null};$?await l($):await K.withPropagatedContext(e.headers,()=>K.trace(d.BaseServerSpan.handleRequest,{spanName:`${k} ${v}`,kind:s.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},l))}catch(t){if(t instanceof m.NoFallbackError||await w.onRequestError(e,t,{routerKind:"App Router",routePath:j,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:T})}),D)throw t;return await (0,_.sendResponse)(F,G,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>C,"routeModule",()=>w,"serverHooks",()=>P,"workAsyncStorage",()=>y,"workUnitAsyncStorage",()=>A],54696)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__b80ff44a._.js.map