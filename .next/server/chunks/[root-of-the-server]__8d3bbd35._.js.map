{"version":3,"sources":["../../../src/lib/supabase.ts","../../../src/lib/clerkSafe.ts","../../../src/lib/ingest/signature.ts"],"sourcesContent":["import { createClient, SupabaseClient } from \"@supabase/supabase-js\";\n\n/**\n * NOTE: This file augments the existing minimal supabase client helper while preserving\n * the original `supabase` export and behavior so other modules keep working.\n *\n * - Existing code (kept): supabase (created using SERVICE_ROLE_KEY || ANON_KEY if present)\n * - Additions:\n *   - getServerSupabase(): returns a server client using SUPABASE_SERVICE_ROLE_KEY (throws if missing)\n *   - getBrowserSupabase(): returns a browser/anon client using NEXT_PUBLIC_* anon key (returns null if missing)\n *   - serverSupabase / browserSupabase: convenience memoized clients (or null)\n */\n\n/* --- existing vars (kept for compatibility) --- */\nconst url = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL;\nconst key = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_ANON_KEY;\n\nlet _supabase: SupabaseClient | null = null;\nif (url && key) {\n  _supabase = createClient(url, key);\n} else {\n  console.warn(\"Supabase client not configured (missing SUPABASE_URL or KEY). Some server operations will fail until configured.\");\n}\n\nexport const supabase = _supabase;\n\n/* --- new, non-breaking helpers --- */\nconst anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ?? process.env.SUPABASE_ANON_KEY;\nconst serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\n/**\n * Memoized server client using the service role key (bypasses RLS).\n * Use this in server-only code paths that need elevated privileges.\n */\nlet _serverSupabase: SupabaseClient | null = null;\n\n/**\n * Safe server client getter.\n * Returns null (instead of throwing) when SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY are missing.\n * Useful for build/CI environments where secrets are not present.\n */\nexport function getServerSupabaseSafe(): SupabaseClient | null {\n  if (!url || !serviceRoleKey) {\n    return null;\n  }\n  if (!_serverSupabase) {\n    _serverSupabase = createClient(url, serviceRoleKey, {\n      // Add server-specific options here if needed\n    });\n  }\n  return _serverSupabase;\n}\n\nexport function getServerSupabase(): SupabaseClient {\n  const client = getServerSupabaseSafe();\n  if (!client) {\n    throw new Error(\"Server Supabase client is not configured. Ensure SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY are set in the environment.\");\n  }\n  return client;\n}\n\n/**\n * Memoized browser/anon client. Safe to call from client code if NEXT_PUBLIC_* vars are configured.\n * Returns null when anon config is missing (caller should handle null).\n */\nlet _browserSupabase: SupabaseClient | null = null;\nexport function getBrowserSupabase(): SupabaseClient | null {\n  if (!url || !anonKey) {\n    if (typeof window === \"undefined\") {\n      // server-side: warn but do not throw\n      console.warn(\"Browser Supabase client not configured (missing NEXT_PUBLIC_SUPABASE_URL or NEXT_PUBLIC_SUPABASE_ANON_KEY).\");\n    }\n    return null;\n  }\n  if (!_browserSupabase) {\n    _browserSupabase = createClient(url, anonKey, {\n      // client options if needed\n    });\n  }\n  return _browserSupabase;\n}\n\n/**\n * Convenience exports that create clients if possible (null when missing).\n * These are provided for callers that prefer a value rather than calling the getters.\n */\nexport const serverSupabase: SupabaseClient | null = (url && serviceRoleKey) ? createClient(url, serviceRoleKey) : null;\nexport const browserSupabase: SupabaseClient | null = (url && anonKey) ? createClient(url, anonKey) : null;\n\n/* --- Backwards-compatible alias for callers expecting getServiceSupabaseClient --- */\n/* The previous attempt to re-export from \"./supabase\" caused a redeclaration when this file\n   is the module itself. Provide a direct alias to the server getter already defined above.\n*/\nexport const getServiceSupabaseClient = getServerSupabase;\n","// url=https://github.com/medicalexcom/avidiatech-app/blob/main/src/lib/clerkSafe.ts\n/**\n * safeGetAuth(req)\n *\n * Defensive wrapper around Clerk's getAuth for environments where clerkMiddleware\n * may not be initialized (build / CI / tests). Returns a minimal auth object or\n * { userId: null } on error rather than allowing getAuth() to run unchecked.\n *\n * Usage: call safeGetAuth(req) INSIDE your request handlers (not at module top-level).\n */\nexport function safeGetAuth(req: any): { userId?: string | null; sessionId?: string | null; actor?: any } {\n  // Quick short-circuit: if essential Clerk env is not present, avoid requiring Clerk.\n  // This prevents build-time/CI warnings where Clerk can't detect middleware.\n  if (!process.env.CLERK_SECRET && !process.env.NEXT_PUBLIC_CLERK_FRONTEND_API && !process.env.NEXT_PUBLIC_CLERK_FRONTEND) {\n    return { userId: null };\n  }\n\n  try {\n    // Require at runtime to avoid top-level Clerk initialization during build\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\n    const clerk = require(\"@clerk/nextjs/server\");\n    if (clerk && typeof clerk.getAuth === \"function\") {\n      try {\n        // getAuth expects the Next Request-like object in your handlers\n        return clerk.getAuth(req);\n      } catch (err) {\n        // getAuth might still throw if middleware not detected; swallow it and return null userId\n        // but keep the error in logs for diagnostics\n        // eslint-disable-next-line no-console\n        console.warn(\"safeGetAuth: getAuth threw:\", String(err));\n        return { userId: null };\n      }\n    }\n  } catch (e) {\n    // Clerk package not available or require failed (build/CI). Return safe fallback.\n    // eslint-disable-next-line no-console\n    console.warn(\"safeGetAuth: @clerk/nextjs/server not available at runtime:\", String(e));\n    return { userId: null };\n  }\n\n  return { userId: null };\n}\n","// HMAC SHA256 signing helpers for gateway <-> ingestion engine\n// Usage:\n//   const sig = signPayload(JSON.stringify(payload), process.env.INGEST_SECRET);\n//   const ok = verifySignature(JSON.stringify(payload), sig, process.env.INGEST_SECRET);\n\nimport crypto from \"crypto\";\n\nexport function signPayload(payload: string, secret: string): string {\n  if (!secret || !payload) return \"\";\n  return crypto.createHmac(\"sha256\", secret).update(payload).digest(\"hex\");\n}\n\n/**\n * Try to parse provided signature into a Buffer.\n * Accepts:\n *  - raw hex (e.g. \"a3f...\")\n *  - prefixed hex (e.g. \"sha256=a3f...\")\n *  - base64 (e.g. \"AbC...==\")\n */\nfunction signatureToBuffer(sig?: string | null): Buffer | null {\n  if (!sig) return null;\n  sig = sig.trim();\n\n  // strip common prefix 'sha256=' if present\n  if (sig.toLowerCase().startsWith(\"sha256=\")) {\n    sig = sig.slice(\"sha256=\".length);\n  }\n\n  // try hex\n  try {\n    if (/^[0-9a-fA-F]+$/.test(sig)) {\n      return Buffer.from(sig, \"hex\");\n    }\n  } catch (err) {\n    // ignore\n  }\n\n  // try base64\n  try {\n    return Buffer.from(sig, \"base64\");\n  } catch (err) {\n    // ignore\n  }\n\n  return null;\n}\n\nexport function verifySignature(\n  payload: string,\n  signature: string | undefined | null,\n  secret: string\n): boolean {\n  if (!secret) return false;\n  if (!signature) return false;\n  try {\n    const expectedHex = signPayload(payload, secret);\n    const expectedBuf = Buffer.from(expectedHex, \"hex\");\n\n    const actualBuf = signatureToBuffer(signature);\n    if (!actualBuf) return false;\n\n    // Must match length for timingSafeEqual\n    if (expectedBuf.length !== actualBuf.length) return false;\n\n    return crypto.timingSafeEqual(expectedBuf, actualBuf);\n  } catch (err) {\n    return false;\n  }\n}\n"],"names":[],"mappings":"uCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAcA,IAAM,EAAM,QAAQ,GAAG,CAAC,wBAAwB,EAAI,QAAQ,GAAG,CAAC,YAAY,CACtE,EAAM,QAAQ,GAAG,CAAC,yBAAyB,EAAI,QAAQ,GAAG,CAAC,iBAAiB,CAE9E,EAAmC,KACnC,GAAO,EACT,EAAY,CAAA,AADE,EACF,EAAA,YAAA,AAAY,EAAC,EAAK,GAE9B,QAAQ,IAAI,CAAC,oHAGR,IAAM,EAAW,EAGlB,EAAU,QAAQ,GAAG,CAAC,6BAA6B,EAAI,QAAQ,GAAG,CAAC,iBAAiB,CACpF,EAAiB,QAAQ,GAAG,CAAC,yBAAyB,CAMxD,EAAyC,KAmBtC,SAAS,IACd,IAAM,EAZN,AAAI,AAAC,GAAQ,GAGT,AAAC,CAHO,AAYG,GARb,EAAkB,CAAA,EAAA,EAAA,EAJS,IAGP,MACF,AAAY,EAAC,EAAK,EAAgB,CAEpD,EAAA,EAEK,GAPE,KAYT,GAAI,CAAC,EACH,MADW,AACL,AAAI,MAAM,2HAElB,OAAO,CACT,CA2BsD,GAAO,GAAkB,CAAA,EAAA,EAAA,YAAA,AAAY,EAAC,EAAK,GAC1C,GAAO,GAAW,CAAA,EAAA,EAAA,IAD0C,QAC1C,AAAY,EAAC,EAAK,WAAW,oDAM9D,6LCnFjC,SAAS,EAAY,CAAQ,EAGlC,GAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAI,CAAC,QAAQ,GAAG,CAAC,8BAA8B,EAAI,CAAC,QAAQ,GAAG,CAAC,0BAA0B,CACrH,CADuH,KAChH,CAAE,OAAQ,IAAK,EAGxB,GAAI,CAGF,IAAM,EAAA,EAAA,CAAA,CAAA,MACN,GAAI,GAAkC,YAAzB,AAAqC,OAA9B,EAAM,OAAO,CAC/B,GAAI,CAEF,OAAO,EAAM,OAAO,CAAC,EACvB,CAAE,MAAO,EAAK,CAIZ,QAAQ,IAAI,CAAC,8BAA+B,OAAO,GAErD,CAEJ,CAAE,MAAO,EAAG,CAGV,QAAQ,IAAI,CAAC,8DAA+D,OAAO,GAErF,CAEA,MAAO,CAAE,OAAQ,IAAK,CACxB,oDCpCA,IAAA,EAAA,EAAA,CAAA,CAAA,OAEO,SAAS,EAAY,CAAe,CAAE,CAAc,SACzD,AAAI,AAAC,GAAW,EACT,EAAA,GADQ,EAAU,EACZ,CAAC,UAAU,CAAC,SAAU,GAAQ,MAAM,CAAC,GAAS,MAAM,CAAC,OADlC,EAElC,CAqCO,SAAS,EACd,CAAe,CACf,CAAoC,CACpC,CAAc,EAEd,GAAI,CAAC,GACD,CAAC,EADQ,OAAO,EAEpB,AADgB,GACZ,CACF,GAFqB,CAEf,EAAc,EAAY,EAAS,GACnC,EAAc,OAAO,IAAI,CAAC,EAAa,OAEvC,EAAY,AAvCtB,SAAS,AAAkB,CAAmB,EAC5C,GAAI,CAAC,EAAK,OAAO,KAIb,CAHJ,EAAM,EAAI,IAAI,EAAA,EAGN,WAAW,GAAG,UAAU,CAAC,YAAY,CAC3C,EAAM,EAAI,KAAK,CAAC,EAAgB,EAIlC,GAAI,CACF,EAL0B,CAKtB,iBAAiB,IAAI,CAAC,GACxB,GAD8B,IACvB,OAAO,IAAI,CAAC,EAAK,MAE5B,CAAE,MAAO,EAAK,CAEd,CAGA,GAAI,CACF,OAAO,OAAO,IAAI,CAAC,EAAK,SAC1B,CAAE,MAAO,EAAK,CAEd,CAEA,OAAO,IACT,EAawC,GACpC,GAAI,CAAC,GAGD,EAAY,MAAM,GAAK,EAAU,MAAM,CAH3B,CAG6B,MAHtB,CAG6B,CAEpD,OAAO,EAAA,OAAM,CAAC,eAAe,CAAC,EAAa,EAC7C,CAAE,MAAO,EAAK,CACZ,OAAO,CACT,CACF"}