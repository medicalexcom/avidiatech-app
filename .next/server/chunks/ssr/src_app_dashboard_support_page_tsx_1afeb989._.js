module.exports=[3716,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(79858);let e=null;function f(){if(e)return e;let a=process.env.NEXT_PUBLIC_SUPABASE_URL,b=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;if(!a||!b)throw Error("Missing Supabase configuration. Ensure NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY are set.");return e=(0,d.createClient)(a,b,{auth:{persistSession:!0,autoRefreshToken:!0},realtime:{params:{eventsPerSecond:10}}})}function g(){let[a,d]=(0,c.useState)(null),[e,g]=(0,c.useState)([]),[h,i]=(0,c.useState)(""),[j,k]=(0,c.useState)(!0),[l,m]=(0,c.useState)(!1),[n,o]=(0,c.useState)(null),[p,q]=(0,c.useState)(!1),[r,s]=(0,c.useState)(new Set),[t,u]=(0,c.useState)({}),v=(0,c.useRef)(null),w=(0,c.useRef)(null),x=(0,c.useRef)(null),y=(0,c.useRef)(null),z=(0,c.useRef)(null),A=(0,c.useCallback)(()=>{v.current?.scrollIntoView({behavior:"smooth"})},[]);(0,c.useEffect)(()=>{A()},[e,A]),(0,c.useEffect)(()=>{B()},[]),(0,c.useEffect)(()=>(a?.id&&(D(a.id),E(a.id)),()=>{F()}),[a?.id]);let B=async()=>{try{k(!0),o(null);let a=await fetch("/api/chat/threads",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subject:"Support Request",forceNew:!1})});if(!a.ok){let b=await a.json();throw Error(b.error||"Failed to create thread")}let b=await a.json();d(b.thread),await C(b.thread.id)}catch(a){console.error("Chat initialization error:",a),o(a.message||"Failed to initialize chat")}finally{k(!1)}},C=async a=>{try{let b=await fetch(`/api/chat/messages?threadId=${a}`);if(!b.ok)throw Error("Failed to load messages");let c=await b.json();g(c.messages),c.messages.forEach(async a=>{if(a.chat_files&&Array.isArray(a.chat_files)){for(let b of a.chat_files)if(b?.id&&b?.storage_path)try{let a=f(),{data:c}=await a.storage.from("chat-uploads").createSignedUrl(b.storage_path,604800);c?.signedUrl&&u(a=>({...a,[b.id]:c.signedUrl}))}catch(a){}}})}catch(a){console.error("Error loading messages:",a),o(a.message||"Failed to load messages")}},D=a=>{x.current=f().channel(`chat-messages-${a}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:`thread_id=eq.${a}`},a=>{let b=a.new;g(a=>a.some(a=>a.id===b.id)?a:[...a,b])}).subscribe()},E=a=>{let b=f().channel(`chat-presence-${a}`,{config:{presence:{key:"user-presence"}}}).on("presence",{event:"sync"},()=>{let a=b.presenceState(),c=new Set;Object.values(a).forEach(a=>{a.forEach(a=>{a.typing&&c.add(a.user_id)})}),s(c)}).subscribe(async a=>{"SUBSCRIBED"===a&&await b.track({online_at:new Date().toISOString(),typing:!1})});y.current=b},F=()=>{x.current&&(f().removeChannel(x.current),x.current=null),y.current&&(f().removeChannel(y.current),y.current=null)},G=async b=>{if(b.preventDefault(),h.trim()&&a&&!l)try{m(!0),o(null);let b=await fetch("/api/chat/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({threadId:a.id,content:h.trim(),messageType:"text"})});if(!b.ok){let a=await b.json();throw Error(a.error||"Failed to send message")}i(""),I(!1)}catch(a){console.error("Error sending message:",a),o(a.message||"Failed to send message")}finally{m(!1)}},H=async b=>{let c=b.target.files?.[0];if(c&&a)try{q(!0),o(null);let b=f(),d=Date.now(),e=c.name.replace(/[^a-zA-Z0-9.-]/g,"_"),g=`${a.id}/${d}-${e}`,{data:h,error:i}=await b.storage.from("chat-uploads").upload(g,c,{cacheControl:"3600",upsert:!1});if(i)throw Error(`Upload failed: ${i.message}`);let j={storagePath:g,fileName:c.name,fileSize:c.size,fileType:c.type},k=await fetch("/api/chat/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({threadId:a.id,content:`ðŸ“Ž ${c.name}`,messageType:"file",metadata:j})});if(!k.ok){let a=await k.json().catch(()=>({}));throw Error(a.error||"Failed to send file message")}let l=await k.json();if(l?.file?.id&&l?.file?.storage_path)try{let{data:a}=await b.storage.from("chat-uploads").createSignedUrl(l.file.storage_path,604800);a?.signedUrl&&u(b=>({...b,[l.file.id]:a.signedUrl}))}catch(a){try{let{data:a}=await b.storage.from("chat-uploads").createSignedUrl(g,604800);a?.signedUrl&&u(b=>({...b,[g]:a.signedUrl}))}catch(a){}}else try{let{data:a}=await b.storage.from("chat-uploads").createSignedUrl(g,604800);a?.signedUrl&&u(b=>({...b,[g]:a.signedUrl}))}catch(a){}w.current&&(w.current.value="")}catch(a){console.error("Error uploading file:",a),o(a.message||"Failed to upload file")}finally{q(!1)}},I=a=>{y.current&&y.current.track({online_at:new Date().toISOString(),typing:a})};return j?(0,b.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"}),(0,b.jsx)("p",{className:"text-gray-600",children:"Loading support chat..."})]})}):(0,b.jsxs)("div",{className:"flex flex-col h-screen bg-gray-50",children:[(0,b.jsxs)("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:[(0,b.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"Support Chat"}),a&&(0,b.jsxs)("p",{className:"text-sm text-gray-600 mt-1",children:[a.subject," â€¢ ",a.status]})]}),n&&(0,b.jsxs)("div",{className:"bg-red-50 border-l-4 border-red-500 p-4 mx-6 mt-4",children:[(0,b.jsx)("p",{className:"text-red-700",children:n}),(0,b.jsx)("button",{onClick:()=>o(null),className:"text-red-600 underline text-sm mt-1",children:"Dismiss"})]}),(0,b.jsxs)("div",{className:"flex-1 overflow-y-auto px-6 py-4 space-y-4",children:[0===e.length?(0,b.jsx)("div",{className:"text-center text-gray-500 mt-8",children:(0,b.jsx)("p",{children:"No messages yet. Start the conversation!"})}):e.map(a=>{let c,d,e,f="agent"===a.sender_role,g="system"===a.sender_role;if(a.chat_files&&Array.isArray(a.chat_files)&&a.chat_files.length>0){let b=a.chat_files[0];b?.id&&t[b.id]?c=t[b.id]:b?.storage_path&&t[b?.storage_path]&&(c=t[b.storage_path])}return(0,b.jsx)("div",{className:`flex ${f||g?"justify-start":"justify-end"}`,children:(0,b.jsxs)("div",{className:`max-w-md rounded-lg px-4 py-2 ${f?"bg-blue-100 text-blue-900":g?"bg-gray-100 text-gray-700":"bg-green-100 text-green-900"}`,children:[(0,b.jsx)("p",{className:"text-xs font-semibold mb-1",children:f?"Support Agent":g?"System":"You"}),(0,b.jsx)("p",{className:"whitespace-pre-wrap break-words",children:a.content}),c&&(0,b.jsx)("div",{className:"mt-2",children:(0,b.jsx)("a",{href:c,target:"_blank",rel:"noreferrer",className:"underline",children:"Open attachment"})}),(0,b.jsx)("p",{className:"text-xs opacity-70 mt-1",children:(d=new Date(a.created_at),(e=Math.floor((new Date().getTime()-d.getTime())/6e4))<1?"Just now":e<60?`${e}m ago`:e<1440?`${Math.floor(e/60)}h ago`:d.toLocaleDateString())})]})},a.id)}),r.size>0&&(0,b.jsx)("div",{className:"flex justify-start",children:(0,b.jsx)("div",{className:"bg-gray-200 rounded-lg px-4 py-2",children:(0,b.jsx)("p",{className:"text-sm text-gray-600",children:"Support agent is typing..."})})}),(0,b.jsx)("div",{ref:v})]}),(0,b.jsx)("div",{className:"bg-white border-t border-gray-200 px-6 py-4",children:(0,b.jsxs)("form",{onSubmit:G,className:"flex items-end space-x-2",children:[(0,b.jsx)("button",{type:"button",onClick:()=>w.current?.click(),disabled:p||!a,className:"flex-shrink-0 p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed",title:"Attach file",children:p?(0,b.jsx)("span",{className:"animate-spin",children:"â³"}):(0,b.jsx)("span",{className:"text-xl",children:"ðŸ“Ž"})}),(0,b.jsx)("input",{ref:w,type:"file",onChange:H,className:"hidden",accept:"image/*,.pdf,.doc,.docx,.txt"}),(0,b.jsx)("textarea",{value:h,onChange:a=>{i(a.target.value),I(!0),z.current&&clearTimeout(z.current),z.current=setTimeout(()=>{I(!1)},2e3)},onKeyDown:a=>{"Enter"!==a.key||a.shiftKey||(a.preventDefault(),G(a))},placeholder:"Type your message... (Shift+Enter for new line)",className:"flex-1 resize-none border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",rows:2,disabled:!a||l}),(0,b.jsx)("button",{type:"submit",disabled:!h.trim()||!a||l,className:"flex-shrink-0 bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors",children:l?"Sending...":"Send"})]})})]})}a.s(["default",()=>g],3716)}];

//# sourceMappingURL=src_app_dashboard_support_page_tsx_1afeb989._.js.map