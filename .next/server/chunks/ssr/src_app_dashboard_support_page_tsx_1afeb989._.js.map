{"version":3,"sources":["../../../../src/app/dashboard/support/page.tsx","../../../../src/lib/supabase-chat-client.ts"],"sourcesContent":["\"use client\";\n\nimport React, { useState, useEffect, useRef, useCallback } from \"react\";\nimport { getChatSupabaseClient } from \"@/lib/supabase-chat-client\";\nimport type {\n  ChatThread,\n  ChatMessage,\n  CreateThreadResponse,\n  GetMessagesResponse,\n  CreateMessageResponse,\n  PresenceState,\n} from \"@/lib/chat-types\";\nimport { RealtimeChannel } from \"@supabase/supabase-js\";\n\n/**\n * Support Chat Page\n *\n * A real-time support chat interface with:\n * - Thread creation/retrieval\n * - Real-time message updates via Supabase Realtime\n * - File upload support\n * - Presence/typing indicators\n * - Auto-scroll to latest messages\n */\nexport default function SupportChatPage() {\n  const [thread, setThread] = useState<ChatThread | null>(null);\n  const [messages, setMessages] = useState<ChatMessage[]>([]);\n  const [messageInput, setMessageInput] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(true);\n  const [isSending, setIsSending] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [isUploading, setIsUploading] = useState(false);\n  const [typingUsers, setTypingUsers] = useState<Set<string>>(new Set());\n\n  const [signedUrls, setSignedUrls] = useState<Record<string, string>>({});\n\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const channelRef = useRef<RealtimeChannel | null>(null);\n  const presenceChannelRef = useRef<RealtimeChannel | null>(null);\n  const typingTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n\n  // Auto-scroll to bottom when new messages arrive\n  const scrollToBottom = useCallback(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, []);\n\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages, scrollToBottom]);\n\n  // Initialize: Create or fetch thread\n  useEffect(() => {\n    initializeChat();\n  }, []);\n\n  // Set up realtime subscription when thread is ready\n  useEffect(() => {\n    if (thread?.id) {\n      subscribeToMessages(thread.id);\n      subscribeToPresence(thread.id);\n    }\n\n    return () => {\n      cleanupSubscriptions();\n    };\n  }, [thread?.id]);\n\n  const initializeChat = async () => {\n    try {\n      setIsLoading(true);\n      setError(null);\n\n      // Create or fetch existing open thread\n      const response = await fetch(\"/api/chat/threads\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          subject: \"Support Request\",\n          forceNew: false,\n        }),\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.error || \"Failed to create thread\");\n      }\n\n      const data: CreateThreadResponse = await response.json();\n      setThread(data.thread);\n\n      // Load existing messages\n      await loadMessages(data.thread.id);\n    } catch (err: any) {\n      console.error(\"Chat initialization error:\", err);\n      setError(err.message || \"Failed to initialize chat\");\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const loadMessages = async (threadId: string) => {\n    try {\n      const response = await fetch(`/api/chat/messages?threadId=${threadId}`);\n\n      if (!response.ok) {\n        throw new Error(\"Failed to load messages\");\n      }\n\n      const data: GetMessagesResponse = await response.json();\n      setMessages(data.messages);\n\n      // Preload signed urls for any attached files returned with messages\n      data.messages.forEach(async (msg: any) => {\n        // If messages include chat_files relation (server returns chat_files in select)\n        if (msg.chat_files && Array.isArray(msg.chat_files)) {\n          for (const f of msg.chat_files) {\n            if (f?.id && f?.storage_path) {\n              try {\n                const supabase = getChatSupabaseClient();\n                const { data: urlData } = await supabase.storage\n                  .from(\"chat-uploads\")\n                  .createSignedUrl(f.storage_path, 60 * 60 * 24 * 7);\n                if (urlData?.signedUrl) {\n                  setSignedUrls((s) => ({ ...s, [f.id]: urlData.signedUrl }));\n                }\n              } catch (err) {\n                // ignore\n              }\n            }\n          }\n        }\n      });\n    } catch (err: any) {\n      console.error(\"Error loading messages:\", err);\n      setError(err.message || \"Failed to load messages\");\n    }\n  };\n\n  const subscribeToMessages = (threadId: string) => {\n    const supabase = getChatSupabaseClient();\n\n    // Create a channel for this thread's messages\n    const channel = supabase\n      .channel(`chat-messages-${threadId}`)\n      .on(\n        \"postgres_changes\",\n        {\n          event: \"INSERT\",\n          schema: \"public\",\n          table: \"chat_messages\",\n          filter: `thread_id=eq.${threadId}`,\n        },\n        (payload: any) => {\n          const newMessage = payload.new as ChatMessage;\n          setMessages((prev) => {\n            // Avoid duplicates\n            if (prev.some((m) => m.id === newMessage.id)) {\n              return prev;\n            }\n            return [...prev, newMessage];\n          });\n        }\n      )\n      .subscribe();\n\n    channelRef.current = channel;\n  };\n\n  const subscribeToPresence = (threadId: string) => {\n    const supabase = getChatSupabaseClient();\n\n    // Create presence channel for typing indicators\n    const presenceChannel = supabase\n      .channel(`chat-presence-${threadId}`, {\n        config: {\n          presence: {\n            key: \"user-presence\",\n          },\n        },\n      })\n      .on(\"presence\", { event: \"sync\" }, () => {\n        const state: PresenceState = presenceChannel.presenceState();\n        const typing = new Set<string>();\n\n        Object.values(state).forEach((presences) => {\n          presences.forEach((presence: any) => {\n            if (presence.typing) {\n              typing.add(presence.user_id);\n            }\n          });\n        });\n\n        setTypingUsers(typing);\n      })\n      .subscribe(async (status) => {\n        if (status === \"SUBSCRIBED\") {\n          // Track this user's presence\n          await presenceChannel.track({\n            online_at: new Date().toISOString(),\n            typing: false,\n          });\n        }\n      });\n\n    presenceChannelRef.current = presenceChannel;\n  };\n\n  const cleanupSubscriptions = () => {\n    if (channelRef.current) {\n      getChatSupabaseClient().removeChannel(channelRef.current);\n      channelRef.current = null;\n    }\n    if (presenceChannelRef.current) {\n      getChatSupabaseClient().removeChannel(presenceChannelRef.current);\n      presenceChannelRef.current = null;\n    }\n  };\n\n  const handleSendMessage = async (e: React.FormEvent) => {\n    e.preventDefault();\n\n    if (!messageInput.trim() || !thread || isSending) {\n      return;\n    }\n\n    try {\n      setIsSending(true);\n      setError(null);\n\n      const response = await fetch(\"/api/chat/messages\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          threadId: thread.id,\n          content: messageInput.trim(),\n          messageType: \"text\",\n        }),\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.error || \"Failed to send message\");\n      }\n\n      // Server will broadcast the message via Realtime; we don't need to append locally.\n      setMessageInput(\"\");\n\n      // Update typing indicator\n      updateTypingStatus(false);\n    } catch (err: any) {\n      console.error(\"Error sending message:\", err);\n      setError(err.message || \"Failed to send message\");\n    } finally {\n      setIsSending(false);\n    }\n  };\n\n  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (!file || !thread) {\n      return;\n    }\n\n    try {\n      setIsUploading(true);\n      setError(null);\n\n      const supabase = getChatSupabaseClient();\n\n      // Generate unique file path\n      const timestamp = Date.now();\n      const sanitizedFileName = file.name.replace(/[^a-zA-Z0-9.-]/g, \"_\");\n      const filePath = `${thread.id}/${timestamp}-${sanitizedFileName}`;\n\n      // Upload to Supabase Storage\n      const { data: uploadData, error: uploadError } = await supabase.storage\n        .from(\"chat-uploads\")\n        .upload(filePath, file, {\n          cacheControl: \"3600\",\n          upsert: false,\n        });\n\n      if (uploadError) {\n        throw new Error(`Upload failed: ${uploadError.message}`);\n      }\n\n      // Prepare metadata we send to server so server can create canonical chat_files row\n      const metadata = {\n        storagePath: filePath,\n        fileName: file.name,\n        fileSize: file.size,\n        fileType: file.type,\n      };\n\n      // Send a message creation request to server. Server will:\n      //  - insert a chat_messages row\n      //  - insert a chat_files row linked to the message (if storagePath present)\n      const response = await fetch(\"/api/chat/messages\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          threadId: thread.id,\n          content: `üìé ${file.name}`,\n          messageType: \"file\",\n          metadata,\n        }),\n      });\n\n      if (!response.ok) {\n        const errData = await response.json().catch(() => ({}));\n        throw new Error(errData.error || \"Failed to send file message\");\n      }\n\n      const result = await response.json();\n\n      // If server returned a canonical file record, prefer that to create signed URL mapping\n      if (result?.file?.id && result?.file?.storage_path) {\n        try {\n          const { data: urlData } = await supabase.storage\n            .from(\"chat-uploads\")\n            .createSignedUrl(result.file.storage_path, 60 * 60 * 24 * 7);\n          if (urlData?.signedUrl) {\n            setSignedUrls((s) => ({ ...s, [result.file.id]: urlData.signedUrl }));\n          }\n        } catch (err) {\n          // fallback: try to create signed URL from the client-side path\n          try {\n            const { data: urlData } = await supabase.storage\n              .from(\"chat-uploads\")\n              .createSignedUrl(filePath, 60 * 60 * 24 * 7);\n            if (urlData?.signedUrl) {\n              // since we don't have the file id (server returned none), store keyed by filePath\n              setSignedUrls((s) => ({ ...s, [filePath]: urlData.signedUrl }));\n            }\n          } catch (err2) {\n            // ignore\n          }\n        }\n      } else {\n        // Fallback: server didn't return file record ‚Äî generate signed URL using client path\n        try {\n          const { data: urlData } = await supabase.storage\n            .from(\"chat-uploads\")\n            .createSignedUrl(filePath, 60 * 60 * 24 * 7);\n          if (urlData?.signedUrl) {\n            setSignedUrls((s) => ({ ...s, [filePath]: urlData.signedUrl }));\n          }\n        } catch (err) {\n          // ignore\n        }\n      }\n\n      // Clear file input\n      if (fileInputRef.current) {\n        fileInputRef.current.value = \"\";\n      }\n    } catch (err: any) {\n      console.error(\"Error uploading file:\", err);\n      setError(err.message || \"Failed to upload file\");\n    } finally {\n      setIsUploading(false);\n    }\n  };\n\n  const updateTypingStatus = (isTyping: boolean) => {\n    if (presenceChannelRef.current) {\n      presenceChannelRef.current.track({\n        online_at: new Date().toISOString(),\n        typing: isTyping,\n      });\n    }\n  };\n\n  const handleInputChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    setMessageInput(e.target.value);\n\n    // Update typing indicator\n    updateTypingStatus(true);\n\n    // Clear previous timeout\n    if (typingTimeoutRef.current) {\n      clearTimeout(typingTimeoutRef.current);\n    }\n\n    // Set new timeout to clear typing after 2 seconds of inactivity\n    typingTimeoutRef.current = setTimeout(() => {\n      updateTypingStatus(false);\n    }, 2000);\n  };\n\n  const formatTimestamp = (timestamp: string) => {\n    const date = new Date(timestamp);\n    const now = new Date();\n    const diffMs = now.getTime() - date.getTime();\n    const diffMins = Math.floor(diffMs / 60000);\n\n    if (diffMins < 1) return \"Just now\";\n    if (diffMins < 60) return `${diffMins}m ago`;\n    if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;\n\n    return date.toLocaleDateString();\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4\"></div>\n          <p className=\"text-gray-600\">Loading support chat...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex flex-col h-screen bg-gray-50\">\n      {/* Header */}\n      <div className=\"bg-white border-b border-gray-200 px-6 py-4\">\n        <h1 className=\"text-2xl font-bold text-gray-900\">Support Chat</h1>\n        {thread && (\n          <p className=\"text-sm text-gray-600 mt-1\">\n            {thread.subject} ‚Ä¢ {thread.status}\n          </p>\n        )}\n      </div>\n\n      {/* Error Banner */}\n      {error && (\n        <div className=\"bg-red-50 border-l-4 border-red-500 p-4 mx-6 mt-4\">\n          <p className=\"text-red-700\">{error}</p>\n          <button\n            onClick={() => setError(null)}\n            className=\"text-red-600 underline text-sm mt-1\"\n          >\n            Dismiss\n          </button>\n        </div>\n      )}\n\n      {/* Messages Area */}\n      <div className=\"flex-1 overflow-y-auto px-6 py-4 space-y-4\">\n        {messages.length === 0 ? (\n          <div className=\"text-center text-gray-500 mt-8\">\n            <p>No messages yet. Start the conversation!</p>\n          </div>\n        ) : (\n          messages.map((message) => {\n            const isAgent = message.sender_role === \"agent\";\n            const isSystem = message.sender_role === \"system\";\n\n            // If message has a linked chat_files row returned by server, prefer that signed URL\n            let fileUrl: string | undefined = undefined;\n            if ((message as any).chat_files && Array.isArray((message as any).chat_files) && (message as any).chat_files.length > 0) {\n              const f = (message as any).chat_files[0];\n              if (f?.id && signedUrls[f.id]) fileUrl = signedUrls[f.id];\n              else if (f?.storage_path && signedUrls[f?.storage_path]) fileUrl = signedUrls[f.storage_path];\n            }\n\n            return (\n              <div\n                key={message.id}\n                className={`flex ${\n                  isAgent || isSystem ? \"justify-start\" : \"justify-end\"\n                }`}\n              >\n                <div\n                  className={`max-w-md rounded-lg px-4 py-2 ${\n                    isAgent\n                      ? \"bg-blue-100 text-blue-900\"\n                      : isSystem\n                      ? \"bg-gray-100 text-gray-700\"\n                      : \"bg-green-100 text-green-900\"\n                  }`}\n                >\n                  <p className=\"text-xs font-semibold mb-1\">\n                    {isAgent ? \"Support Agent\" : isSystem ? \"System\" : \"You\"}\n                  </p>\n                  <p className=\"whitespace-pre-wrap break-words\">\n                    {message.content}\n                  </p>\n\n                  {/* If there's an attached file url, render link */}\n                  {fileUrl && (\n                    <div className=\"mt-2\">\n                      <a href={fileUrl} target=\"_blank\" rel=\"noreferrer\" className=\"underline\">\n                        Open attachment\n                      </a>\n                    </div>\n                  )}\n\n                  <p className=\"text-xs opacity-70 mt-1\">\n                    {formatTimestamp(message.created_at)}\n                  </p>\n                </div>\n              </div>\n            );\n          })\n        )}\n\n        {/* Typing Indicator */}\n        {typingUsers.size > 0 && (\n          <div className=\"flex justify-start\">\n            <div className=\"bg-gray-200 rounded-lg px-4 py-2\">\n              <p className=\"text-sm text-gray-600\">Support agent is typing...</p>\n            </div>\n          </div>\n        )}\n\n        <div ref={messagesEndRef} />\n      </div>\n\n      {/* Input Area */}\n      <div className=\"bg-white border-t border-gray-200 px-6 py-4\">\n        <form onSubmit={handleSendMessage} className=\"flex items-end space-x-2\">\n          {/* File Upload Button */}\n          <button\n            type=\"button\"\n            onClick={() => fileInputRef.current?.click()}\n            disabled={isUploading || !thread}\n            className=\"flex-shrink-0 p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed\"\n            title=\"Attach file\"\n          >\n            {isUploading ? (\n              <span className=\"animate-spin\">‚è≥</span>\n            ) : (\n              <span className=\"text-xl\">üìé</span>\n            )}\n          </button>\n          <input\n            ref={fileInputRef}\n            type=\"file\"\n            onChange={handleFileUpload}\n            className=\"hidden\"\n            accept=\"image/*,.pdf,.doc,.docx,.txt\"\n          />\n\n          {/* Message Input */}\n          <textarea\n            value={messageInput}\n            onChange={handleInputChange}\n            onKeyDown={(e) => {\n              if (e.key === \"Enter\" && !e.shiftKey) {\n                e.preventDefault();\n                handleSendMessage(e);\n              }\n            }}\n            placeholder=\"Type your message... (Shift+Enter for new line)\"\n            className=\"flex-1 resize-none border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n            rows={2}\n            disabled={!thread || isSending}\n          />\n\n          {/* Send Button */}\n          <button\n            type=\"submit\"\n            disabled={!messageInput.trim() || !thread || isSending}\n            className=\"flex-shrink-0 bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors\"\n          >\n            {isSending ? \"Sending...\" : \"Send\"}\n          </button>\n        </form>\n      </div>\n    </div>\n  );\n}\n","\"use client\";\n\nimport { createClient, SupabaseClient } from \"@supabase/supabase-js\";\n\n/**\n * Browser-safe Supabase client for chat features\n * Uses NEXT_PUBLIC_* environment variables for client-side access\n * \n * This client is separate from server-side clients to ensure proper\n * authentication context and RLS enforcement.\n */\n\nlet supabaseChatClient: SupabaseClient | null = null;\n\n/**\n * Get or create a singleton Supabase client for chat features\n * This client uses the anon key and respects RLS policies\n */\nexport function getChatSupabaseClient(): SupabaseClient {\n  if (supabaseChatClient) {\n    return supabaseChatClient;\n  }\n\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n  if (!supabaseUrl || !supabaseAnonKey) {\n    throw new Error(\n      \"Missing Supabase configuration. Ensure NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY are set.\"\n    );\n  }\n\n  supabaseChatClient = createClient(supabaseUrl, supabaseAnonKey, {\n    auth: {\n      persistSession: true,\n      autoRefreshToken: true,\n    },\n    realtime: {\n      params: {\n        eventsPerSecond: 10,\n      },\n    },\n  });\n\n  return supabaseChatClient;\n}\n\n/**\n * Helper to set the auth token for the Supabase client\n * Call this after user authentication to enable RLS\n */\nexport function setChatAuthToken(token: string) {\n  const client = getChatSupabaseClient();\n  // Note: With Clerk, you may need to set up a custom JWT provider\n  // or use Supabase's setAuth method with your auth token\n  // This is a placeholder for the actual implementation\n  console.log(\"Set auth token for chat client\");\n}\n\n/**\n * Helper to clear the auth session\n */\nexport async function clearChatAuth() {\n  const client = getChatSupabaseClient();\n  await client.auth.signOut();\n}\n"],"names":[],"mappings":"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"}