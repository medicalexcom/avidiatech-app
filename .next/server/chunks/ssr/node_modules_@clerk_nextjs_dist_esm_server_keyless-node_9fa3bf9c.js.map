{"version":3,"sources":["../../../../node_modules/%40clerk/nextjs/dist/esm/server/keyless-node.js","../../../../node_modules/%40clerk/nextjs/dist/esm/server/keyless-custom-headers.js"],"sourcesContent":["import \"../chunk-BUSYA2B4.js\";\nimport { createClerkClientWithOptions } from \"./createClerkClient\";\nimport { nodeCwdOrThrow, nodeFsOrThrow, nodePathOrThrow } from \"./fs/utils\";\nimport { collectKeylessMetadata, formatMetadataHeaders } from \"./keyless-custom-headers\";\nconst CLERK_HIDDEN = \".clerk\";\nconst CLERK_LOCK = \"clerk.lock\";\nfunction updateGitignore() {\n  const { existsSync, writeFileSync, readFileSync, appendFileSync } = nodeFsOrThrow();\n  const path = nodePathOrThrow();\n  const cwd = nodeCwdOrThrow();\n  const gitignorePath = path.join(cwd(), \".gitignore\");\n  if (!existsSync(gitignorePath)) {\n    writeFileSync(gitignorePath, \"\");\n  }\n  const gitignoreContent = readFileSync(gitignorePath, \"utf-8\");\n  const COMMENT = `# clerk configuration (can include secrets)`;\n  if (!gitignoreContent.includes(CLERK_HIDDEN + \"/\")) {\n    appendFileSync(gitignorePath, `\n${COMMENT}\n/${CLERK_HIDDEN}/\n`);\n  }\n}\nconst generatePath = (...slugs) => {\n  const path = nodePathOrThrow();\n  const cwd = nodeCwdOrThrow();\n  return path.join(cwd(), CLERK_HIDDEN, ...slugs);\n};\nconst _TEMP_DIR_NAME = \".tmp\";\nconst getKeylessConfigurationPath = () => generatePath(_TEMP_DIR_NAME, \"keyless.json\");\nconst getKeylessReadMePath = () => generatePath(_TEMP_DIR_NAME, \"README.md\");\nlet isCreatingFile = false;\nfunction safeParseClerkFile() {\n  const { readFileSync } = nodeFsOrThrow();\n  try {\n    const CONFIG_PATH = getKeylessConfigurationPath();\n    let fileAsString;\n    try {\n      fileAsString = readFileSync(CONFIG_PATH, { encoding: \"utf-8\" }) || \"{}\";\n    } catch {\n      fileAsString = \"{}\";\n    }\n    return JSON.parse(fileAsString);\n  } catch {\n    return void 0;\n  }\n}\nconst lockFileWriting = () => {\n  const { writeFileSync } = nodeFsOrThrow();\n  isCreatingFile = true;\n  writeFileSync(\n    CLERK_LOCK,\n    // In the rare case, the file persists give the developer enough context.\n    \"This file can be deleted. Please delete this file and refresh your application\",\n    {\n      encoding: \"utf8\",\n      mode: \"0777\",\n      flag: \"w\"\n    }\n  );\n};\nconst unlockFileWriting = () => {\n  const { rmSync } = nodeFsOrThrow();\n  try {\n    rmSync(CLERK_LOCK, { force: true, recursive: true });\n  } catch {\n  }\n  isCreatingFile = false;\n};\nconst isFileWritingLocked = () => {\n  const { existsSync } = nodeFsOrThrow();\n  return isCreatingFile || existsSync(CLERK_LOCK);\n};\nasync function createOrReadKeyless() {\n  const { writeFileSync, mkdirSync } = nodeFsOrThrow();\n  if (isFileWritingLocked()) {\n    return null;\n  }\n  lockFileWriting();\n  const CONFIG_PATH = getKeylessConfigurationPath();\n  const README_PATH = getKeylessReadMePath();\n  mkdirSync(generatePath(_TEMP_DIR_NAME), { recursive: true });\n  updateGitignore();\n  const envVarsMap = safeParseClerkFile();\n  if ((envVarsMap == null ? void 0 : envVarsMap.publishableKey) && (envVarsMap == null ? void 0 : envVarsMap.secretKey)) {\n    unlockFileWriting();\n    return envVarsMap;\n  }\n  const client = createClerkClientWithOptions({});\n  const keylessHeaders = await collectKeylessMetadata().then(formatMetadataHeaders).catch(() => new Headers());\n  const accountlessApplication = await client.__experimental_accountlessApplications.createAccountlessApplication({ requestHeaders: keylessHeaders }).catch(() => null);\n  if (accountlessApplication) {\n    writeFileSync(CONFIG_PATH, JSON.stringify(accountlessApplication), {\n      encoding: \"utf8\",\n      mode: \"0777\",\n      flag: \"w\"\n    });\n    const README_NOTIFICATION = `\n## DO NOT COMMIT\nThis directory is auto-generated from \\`@clerk/nextjs\\` because you are running in Keyless mode. Avoid committing the \\`.clerk/\\` directory as it includes the secret key of the unclaimed instance.\n  `;\n    writeFileSync(README_PATH, README_NOTIFICATION, {\n      encoding: \"utf8\",\n      mode: \"0777\",\n      flag: \"w\"\n    });\n  }\n  unlockFileWriting();\n  return accountlessApplication;\n}\nfunction removeKeyless() {\n  const { rmSync } = nodeFsOrThrow();\n  if (isFileWritingLocked()) {\n    return void 0;\n  }\n  lockFileWriting();\n  try {\n    rmSync(generatePath(), { force: true, recursive: true });\n  } catch {\n  }\n  unlockFileWriting();\n}\nexport {\n  createOrReadKeyless,\n  removeKeyless,\n  safeParseClerkFile\n};\n//# sourceMappingURL=keyless-node.js.map","\"use server\";\nimport \"../chunk-BUSYA2B4.js\";\nimport { headers } from \"next/headers\";\nasync function collectKeylessMetadata() {\n  var _a, _b, _c, _d, _e, _f;\n  const headerStore = await headers();\n  return {\n    nodeVersion: process.version,\n    nextVersion: getNextVersion(),\n    npmConfigUserAgent: process.env.npm_config_user_agent,\n    // eslint-disable-line\n    userAgent: (_a = headerStore.get(\"User-Agent\")) != null ? _a : \"unknown user-agent\",\n    port: process.env.PORT,\n    // eslint-disable-line\n    host: (_b = headerStore.get(\"host\")) != null ? _b : \"unknown host\",\n    xPort: (_c = headerStore.get(\"x-forwarded-port\")) != null ? _c : \"unknown x-forwarded-port\",\n    xHost: (_d = headerStore.get(\"x-forwarded-host\")) != null ? _d : \"unknown x-forwarded-host\",\n    xProtocol: (_e = headerStore.get(\"x-forwarded-proto\")) != null ? _e : \"unknown x-forwarded-proto\",\n    xClerkAuthStatus: (_f = headerStore.get(\"x-clerk-auth-status\")) != null ? _f : \"unknown x-clerk-auth-status\",\n    isCI: detectCIEnvironment()\n  };\n}\nconst CI_ENV_VARS = [\n  \"CI\",\n  \"CONTINUOUS_INTEGRATION\",\n  \"BUILD_NUMBER\",\n  \"BUILD_ID\",\n  \"BUILDKITE\",\n  \"CIRCLECI\",\n  \"GITHUB_ACTIONS\",\n  \"GITLAB_CI\",\n  \"JENKINS_URL\",\n  \"TRAVIS\",\n  \"APPVEYOR\",\n  \"WERCKER\",\n  \"DRONE\",\n  \"CODESHIP\",\n  \"SEMAPHORE\",\n  \"SHIPPABLE\",\n  \"TEAMCITY_VERSION\",\n  \"BAMBOO_BUILDKEY\",\n  \"GO_PIPELINE_NAME\",\n  \"TF_BUILD\",\n  \"SYSTEM_TEAMFOUNDATIONCOLLECTIONURI\",\n  \"BITBUCKET_BUILD_NUMBER\",\n  \"HEROKU_TEST_RUN_ID\",\n  \"VERCEL\",\n  \"NETLIFY\"\n];\nfunction detectCIEnvironment() {\n  const ciIndicators = CI_ENV_VARS;\n  const falsyValues = /* @__PURE__ */ new Set([\"\", \"false\", \"0\", \"no\"]);\n  return ciIndicators.some((indicator) => {\n    const value = process.env[indicator];\n    if (value === void 0) {\n      return false;\n    }\n    const normalizedValue = value.trim().toLowerCase();\n    return !falsyValues.has(normalizedValue);\n  });\n}\nfunction getNextVersion() {\n  var _a;\n  try {\n    return (_a = process.title) != null ? _a : \"unknown-process-title\";\n  } catch {\n    return void 0;\n  }\n}\nfunction formatMetadataHeaders(metadata) {\n  const headers2 = new Headers();\n  if (metadata.nodeVersion) {\n    headers2.set(\"Clerk-Node-Version\", metadata.nodeVersion);\n  }\n  if (metadata.nextVersion) {\n    headers2.set(\"Clerk-Next-Version\", metadata.nextVersion);\n  }\n  if (metadata.npmConfigUserAgent) {\n    headers2.set(\"Clerk-NPM-Config-User-Agent\", metadata.npmConfigUserAgent);\n  }\n  if (metadata.userAgent) {\n    headers2.set(\"Clerk-Client-User-Agent\", metadata.userAgent);\n  }\n  if (metadata.port) {\n    headers2.set(\"Clerk-Node-Port\", metadata.port);\n  }\n  if (metadata.host) {\n    headers2.set(\"Clerk-Client-Host\", metadata.host);\n  }\n  if (metadata.xPort) {\n    headers2.set(\"Clerk-X-Port\", metadata.xPort);\n  }\n  if (metadata.xHost) {\n    headers2.set(\"Clerk-X-Host\", metadata.xHost);\n  }\n  if (metadata.xProtocol) {\n    headers2.set(\"Clerk-X-Protocol\", metadata.xProtocol);\n  }\n  if (metadata.xClerkAuthStatus) {\n    headers2.set(\"Clerk-Auth-Status\", metadata.xClerkAuthStatus);\n  }\n  if (metadata.isCI) {\n    headers2.set(\"Clerk-Is-CI\", \"true\");\n  }\n  return headers2;\n}\nexport {\n  collectKeylessMetadata,\n  formatMetadataHeaders\n};\n//# sourceMappingURL=keyless-custom-headers.js.map"],"names":[],"mappings":"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","ignoreList":[0,1]}