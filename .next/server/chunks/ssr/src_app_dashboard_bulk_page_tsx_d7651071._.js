module.exports=[53120,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(50944);function e(a){if(!a)return"—";try{return new Date(a).toLocaleString()}catch{return a}}function f(){let a=(0,d.useSearchParams)(),f=a?.get("bulkJobId")||"",[g,h]=(0,c.useState)(null),[i,j]=(0,c.useState)([]),[k,l]=(0,c.useState)(!1),[m,n]=(0,c.useState)(!1),[o,p]=(0,c.useState)(null),[q]=(0,c.useState)(200),[r,s]=(0,c.useState)(0),[t,u]=(0,c.useState)(!0),[v]=(0,c.useState)(3e3),[w,x]=(0,c.useState)({}),[y,z]=(0,c.useState)(null),A=(0,c.useMemo)(()=>`/api/v1/bulk/${encodeURIComponent(f)}`,[f]);async function B(){if(f){l(!0),p(null);try{let a=await fetch(A);if(!a.ok){let b=await a.json().catch(()=>null);throw Error(b?.error??`Failed to fetch job (${a.status})`)}let b=await a.json();h(b?.data??b)}catch(a){p(String(a?.message||a))}finally{l(!1)}}}async function C(){if(f){n(!0),p(null);try{let a=`${A}/items?limit=${q}&offset=${r}`,b=await fetch(a);if(!b.ok){let a=await b.json().catch(()=>null);throw Error(a?.error??`Failed to fetch items (${b.status})`)}let c=await b.json();j(c?.data??c??[])}catch(a){p(String(a?.message||a))}finally{n(!1)}}}(0,c.useEffect)(()=>{f&&(B(),C())},[f,r]),(0,c.useEffect)(()=>{if(!f||!t)return;let a=!0,b=setInterval(async()=>{a&&(await B(),await C())},v);return()=>{a=!1,clearInterval(b)}},[f,t,r,v]);let D=g?.total_items??i?.length??0,E=g?.completed_items??i.filter(a=>"succeeded"===a.status).length,F=g?.failed_items??i.filter(a=>"failed"===a.status).length,G=Math.max(0,(D??0)-(E??0)-(F??0)),H=D?Math.round((E??0)/D*100):0;async function I(){if(!f)return;let a=`${A}/items/errors`;window.open(a,"_blank")}async function J(a){if(f&&a){x(b=>({...b,[a]:!0})),z(null);try{let b=`${A}/items/${encodeURIComponent(a)}/retry`,c=await fetch(b,{method:"POST"});if(!c.ok){let a=await c.json().catch(()=>null);throw Error(a?.error??`Retry failed (${c.status})`)}z("Item re-enqueued"),await C(),await B()}catch(a){z(String(a?.message||a))}finally{x(b=>{let c={...b};return delete c[a],c}),setTimeout(()=>z(null),4e3)}}}async function K(){if(f){z(null);try{let a=`${A}/retry-failed`,b=await fetch(a,{method:"POST"});if(!b.ok){let a=await b.json().catch(()=>null);throw Error(a?.error??`Retry failed (${b.status})`)}z("Failed items enqueued for retry"),await C(),await B()}catch(a){z(String(a?.message||a))}finally{setTimeout(()=>z(null),4e3)}}}function L(a){a&&window.open(`/dashboard/extract?ingestionId=${encodeURIComponent(a)}`,"_blank")}return(0,b.jsxs)("div",{className:"mx-auto max-w-7xl p-4",children:[(0,b.jsxs)("div",{className:"flex items-start justify-between gap-4 mb-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h1",{className:"text-2xl font-semibold",children:"Bulk job"}),(0,b.jsxs)("div",{className:"mt-1 text-sm text-slate-600",children:["Job id: ",(0,b.jsx)("span",{className:"font-mono",children:f||"—"})]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("button",{onClick:()=>{B(),C()},className:"rounded-md border px-3 py-2 text-sm bg-white",disabled:!f||k||m,children:"Refresh"}),(0,b.jsxs)("label",{className:"inline-flex items-center gap-2 text-sm",children:[(0,b.jsx)("input",{type:"checkbox",checked:t,onChange:a=>u(a.target.checked)}),"Auto refresh"]}),(0,b.jsx)("button",{onClick:I,className:"rounded-md bg-rose-600 px-3 py-2 text-sm text-white",disabled:!f,title:"Download CSV of failed items",children:"Download errors CSV"})]})]}),o?(0,b.jsx)("div",{className:"mb-4 rounded-md border border-rose-300 bg-rose-50 p-3 text-sm text-rose-800",children:o}):null,(0,b.jsxs)("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-12",children:[(0,b.jsxs)("div",{className:"lg:col-span-8 space-y-4",children:[(0,b.jsxs)("section",{className:"rounded-2xl border bg-white p-4 shadow-sm",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"text-xs text-slate-500",children:"Summary"}),(0,b.jsx)("h2",{className:"text-lg font-semibold",children:g?.name??"Bulk job"})]}),(0,b.jsxs)("div",{className:"text-right",children:[(0,b.jsx)("div",{className:"text-xs text-slate-500",children:"Created"}),(0,b.jsx)("div",{className:"font-mono text-sm",children:e(g?.created_at)})]})]}),(0,b.jsxs)("div",{className:"mt-4",children:[(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsxs)("div",{className:"rounded-lg border px-3 py-2 text-sm",children:["Total: ",(0,b.jsx)("span",{className:"font-semibold ml-2",children:D??"—"})]}),(0,b.jsxs)("div",{className:"rounded-lg border px-3 py-2 text-sm",children:["Completed: ",(0,b.jsx)("span",{className:"font-semibold ml-2",children:E??0})]}),(0,b.jsxs)("div",{className:"rounded-lg border px-3 py-2 text-sm",children:["Failed: ",(0,b.jsx)("span",{className:"font-semibold ml-2",children:F??0})]}),(0,b.jsxs)("div",{className:"rounded-lg border px-3 py-2 text-sm",children:["Queued: ",(0,b.jsx)("span",{className:"font-semibold ml-2",children:G??0})]})]}),(0,b.jsxs)("div",{className:"mt-3",children:[(0,b.jsx)("div",{className:"h-3 w-full rounded-full bg-slate-200",children:(0,b.jsx)("div",{className:"h-3 rounded-full bg-gradient-to-r from-sky-400 via-emerald-400 to-amber-400",style:{width:`${Math.min(100,Math.max(0,H))}%`}})}),(0,b.jsxs)("div",{className:"mt-2 text-sm text-slate-500",children:["Progress: ",H,"%"]})]})]})]}),(0,b.jsxs)("section",{className:"rounded-2xl border bg-white p-4 shadow-sm",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsx)("h3",{className:"text-sm font-semibold",children:"Items"}),(0,b.jsxs)("div",{className:"text-xs text-slate-500",children:["Showing ",i.length," items (offset ",r,")"]})]}),(0,b.jsx)("div",{className:"mt-3 overflow-auto",children:(0,b.jsxs)("table",{className:"min-w-full text-sm",children:[(0,b.jsx)("thead",{children:(0,b.jsxs)("tr",{className:"text-left text-xs text-slate-500",children:[(0,b.jsx)("th",{className:"py-2 pr-3",children:"#"}),(0,b.jsx)("th",{className:"py-2 pr-3",children:"URL"}),(0,b.jsx)("th",{className:"py-2 pr-3",children:"Status"}),(0,b.jsx)("th",{className:"py-2 pr-3",children:"Ingestion"}),(0,b.jsx)("th",{className:"py-2 pr-3",children:"Pipeline"}),(0,b.jsx)("th",{className:"py-2 pr-3",children:"Error"}),(0,b.jsx)("th",{className:"py-2 pr-3",children:"Actions"})]})}),(0,b.jsx)("tbody",{children:m?(0,b.jsx)("tr",{children:(0,b.jsx)("td",{className:"py-4 text-sm text-slate-500",colSpan:7,children:"Loading items…"})}):0===i.length?(0,b.jsx)("tr",{children:(0,b.jsx)("td",{className:"py-4 text-sm text-slate-500",colSpan:7,children:"No items found."})}):i.map(a=>(0,b.jsxs)("tr",{className:"border-t",children:[(0,b.jsx)("td",{className:"py-2 pr-3 align-top",children:a.item_index+1}),(0,b.jsx)("td",{className:"py-2 pr-3 align-top max-w-[36ch] truncate",children:a.input_url}),(0,b.jsx)("td",{className:"py-2 pr-3 align-top",children:(0,b.jsx)("span",{className:`inline-flex items-center rounded-full px-2 py-0.5 text-xs ${"succeeded"===a.status?"bg-emerald-50 text-emerald-700":"failed"===a.status?"bg-rose-50 text-rose-700":"bg-slate-100 text-slate-700"}`,children:a.status??"—"})}),(0,b.jsx)("td",{className:"py-2 pr-3 align-top",children:a.ingestion_id?(0,b.jsxs)("button",{className:"text-xs text-sky-700 underline",onClick:()=>L(a.ingestion_id),children:[a.ingestion_id.slice(0,10),"…"]}):"—"}),(0,b.jsx)("td",{className:"py-2 pr-3 align-top",children:a.pipeline_run_id?(0,b.jsxs)("a",{className:"text-xs underline",href:`/api/v1/pipeline/run/${encodeURIComponent(a.pipeline_run_id)}/output/0`,target:"_blank",rel:"noreferrer",children:[a.pipeline_run_id.slice(0,10),"…"]}):"—"}),(0,b.jsx)("td",{className:"py-2 pr-3 align-top",children:a.last_error?(0,b.jsx)("div",{className:"max-w-[28ch] truncate text-xs text-rose-700",children:"string"==typeof a.last_error?a.last_error:JSON.stringify(a.last_error)}):"—"}),(0,b.jsx)("td",{className:"py-2 pr-3 align-top",children:(0,b.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,b.jsx)("button",{className:"rounded px-2 py-1 text-xs border bg-white",onClick:()=>L(a.ingestion_id),disabled:!a.ingestion_id,children:"Open Extract"}),(0,b.jsx)("button",{className:"rounded px-2 py-1 text-xs border bg-white",onClick:()=>{var b;(b=a.ingestion_id)&&window.open(`/dashboard/describe?ingestionId=${encodeURIComponent(b)}`,"_blank")},disabled:!a.ingestion_id,children:"Open Describe"}),(0,b.jsx)("button",{className:"rounded px-2 py-1 text-xs border bg-white",onClick:()=>{var b;(b=a.ingestion_id)&&window.open(`/dashboard/monitor?ingestionId=${encodeURIComponent(b)}`,"_blank")},disabled:!a.ingestion_id,children:"Open Monitor"}),(0,b.jsx)("button",{className:"rounded px-2 py-1 text-xs bg-amber-400 text-slate-900",disabled:w[a.id]||"failed"!==a.status,onClick:()=>J(a.id),children:w[a.id]?"Retrying…":"Retry"})]})})]},a.id))})]})}),(0,b.jsxs)("div",{className:"mt-4 flex items-center justify-between",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,b.jsx)("button",{className:"rounded px-2 py-1 border",onClick:()=>s(Math.max(0,r-q)),disabled:0===r,children:"Prev"}),(0,b.jsx)("button",{className:"rounded px-2 py-1 border",onClick:()=>s(r+q),disabled:i.length<q,children:"Next"}),(0,b.jsxs)("div",{className:"text-xs text-slate-500",children:["offset ",r]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("button",{className:"rounded px-3 py-2 bg-sky-600 text-white text-sm",onClick:K,disabled:0===F,children:"Retry failed items"}),y?(0,b.jsx)("div",{className:"text-sm text-slate-600",children:y}):null]})]})]})]}),(0,b.jsxs)("aside",{className:"lg:col-span-4 space-y-4",children:[(0,b.jsxs)("section",{className:"rounded-2xl border bg-white p-4 shadow-sm",children:[(0,b.jsx)("h3",{className:"text-sm font-semibold",children:"Job details"}),(0,b.jsxs)("div",{className:"mt-3 text-sm text-slate-700",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("strong",{children:"Name:"})," ",g?.name??"—"]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("strong",{children:"Created by:"})," ",(0,b.jsx)("span",{className:"font-mono",children:g?.created_by??"—"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("strong",{children:"Created:"})," ",e(g?.created_at)]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("strong",{children:"Updated:"})," ",e(g?.updated_at)]})]})]}),(0,b.jsxs)("section",{className:"rounded-2xl border bg-white p-4 shadow-sm",children:[(0,b.jsx)("h3",{className:"text-sm font-semibold",children:"Quick actions"}),(0,b.jsxs)("div",{className:"mt-3 space-y-2",children:[(0,b.jsx)("button",{className:"w-full rounded px-3 py-2 bg-sky-600 text-white",onClick:I,disabled:!f,children:"Download failed rows CSV"}),(0,b.jsx)("button",{className:"w-full rounded px-3 py-2 bg-white border text-sm",onClick:()=>{B(),C()},children:"Refresh now"})]})]}),(0,b.jsxs)("section",{className:"rounded-2xl border bg-white p-4 shadow-sm",children:[(0,b.jsx)("h3",{className:"text-sm font-semibold",children:"Diagnostics"}),(0,b.jsx)("div",{className:"mt-2 text-xs text-slate-600",children:"Failed rows will appear here and can be downloaded for inspection. If items are stuck, check worker logs and Redis connectivity."})]})]})]})]})}a.s(["default",()=>f])}];

//# sourceMappingURL=src_app_dashboard_bulk_page_tsx_d7651071._.js.map