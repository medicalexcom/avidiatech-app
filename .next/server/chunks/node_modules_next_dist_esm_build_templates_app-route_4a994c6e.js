module.exports=[18769,e=>{"use strict";var t=e.i(47909),r=e.i(74017),n=e.i(96250),a=e.i(59756),o=e.i(61916),s=e.i(14444),i=e.i(37092),l=e.i(69741),u=e.i(16795),c=e.i(87718),d=e.i(95169),p=e.i(47587),m=e.i(66012),_=e.i(70101),f=e.i(26937),h=e.i(10372),w=e.i(93695);e.i(52474);var g=e.i(5232),R=e.i(89171),S=e.i(86883),v=e.i(24389);let E=Number(process.env.SEARCH_TIMEOUT_MS??8e3);function y(e,t={},r=E){let n=new AbortController,a=setTimeout(()=>n.abort(),r);return fetch(e,{...t,signal:n.signal}).finally(()=>clearTimeout(a))}function C(e){if(!e)return null;try{return new URL(e).hostname.replace(/^www\./,"").toLowerCase()}catch{return null}}async function k(e,t,r=10,n=E){if(!t)return[];let a=`https://serpapi.com/search.json?q=${encodeURIComponent(e)}&api_key=${encodeURIComponent(t)}&num=${r}`;try{let e=await y(a,{},n);if(!e.ok)throw Error(`SerpAPI error ${e.status}`);let t=await e.json();return((t.orgic_results??t.organic_results??t.organic_results??[])||[]).map(e=>({url:e.link??e.url??e.displayed_link??void 0,title:e.title??e.name??void 0,snippet:e.snippet??e.snippet??void 0})).filter(Boolean)}catch(e){return console.warn("serpApiSearch error:",e?.message??e),[]}}async function A(e,t,r=E){try{let n=await y(e,{redirect:"follow"},r);if(!n.ok)return{ok:!1,error:`status ${n.status}`};let a=(await n.text()).toLowerCase(),o=0,s=[];if(t.sku){let e=t.sku.toLowerCase();a.includes(e)&&(o+=.7,s.push(`sku:${t.sku}`))}if(t.ndc){let e=t.ndc.toLowerCase();a.includes(e)&&(o+=.6,s.push(`ndc:${t.ndc}`))}if(t.name){let e=t.name.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(Boolean);if(e.length){let t=e.reduce((e,t)=>e+ +!!a.includes(t),0),r=t/e.length;o+=Math.min(.5,.5*r),t>0&&s.push(`name_tokens:${t}/${e.length}`)}}let i=null;try{i=new URL(e).hostname.replace(/^www\./,""),t.supplierDomain&&t.supplierDomain.toLowerCase().includes(i)?(o+=.1,s.push(`domain:${i}`)):t.supplierDomain&&i.includes(t.supplierDomain.toLowerCase())&&(o+=.08,s.push(`domain_partial:${i}`))}catch{}o>1&&(o=1);let l=(a.slice(0,2e3)||"").replace(/\s+/g," ").slice(0,2e3);return{ok:!0,score:o,matchedTokens:s,snippet:l,domain:i}}catch(e){return{ok:!1,error:String(e?.message??e)}}}let b=process.env.SUPABASE_URL,x=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!b||!x)throw Error("Missing Supabase env vars for matcher");let T=(0,v.createClient)(b,x,{auth:{persistSession:!1}}),O=process.env.SERPAPI_KEY??"",N=Number(process.env.SEARCH_MAX_RESULTS??5),$=Number(process.env.VALIDATION_CONFIDENCE_THRESHOLD??.65),I="true"===String(process.env.ALLOW_RESELLERS??"false").toLowerCase();function L(e){return e?e.toString().toLowerCase().replace(/\s+/g,"").replace(/[^a-z0-9]/g,""):""}async function P(e){let t=e.supplier_key??L(e.supplier_name),r=(e.supplier_name??"").toString().trim(),n=e.tenant_id??null;try{let{data:e}=await T.from("product_source_index").select("source_domain").eq("tenant_id",n).eq("supplier_key",t).limit(5);if(Array.isArray(e)&&e.length){let n=e.map(e=>"string"==typeof e.source_domain?e.source_domain.replace(/^www\./,"").toLowerCase():null).filter(Boolean);for(let e of n)if(e&&(t&&e.includes(t)||r&&e.includes(r.toLowerCase().replace(/\s+/g,""))))return e;if(n.length)return n[0]}}catch(e){console.warn("resolveManufacturerDomain: product_source_index lookup failed",String(e))}if(!O)return null;for(let e of[`${r} official site`,`${r} manufacturer official website`,`${r} company website`,`${r} official website`].filter(Boolean))try{let n=await k(e,O,5);if(!n||0===n.length)continue;for(let e of n){let n=C(e.url);if(!n)continue;let a=n.toLowerCase(),o=L(t),s=r.toLowerCase().replace(/\s+/g,"");if(o&&a.includes(o)||r&&a.includes(s)||/^(?:[^.]*?)acon(?:[^.]*)\.|acon-lab|aconlabs/.test(a))return a}let a=n[0],o=C(a.url);if(o)return o}catch(e){console.warn("resolveManufacturerDomain: serpApiSearch error",String(e))}return null}async function D(e){let t,r,n,a,o,s,i,l,u=(t=[],r=(e.sku??"").toString().trim(),n=(e.product_name??"").toString().trim(),a=(e.brand_name??"").toString().trim(),o=(e.supplier_name??"").toString().trim(),s=(e.supplier_key??"").toString().trim(),i=(e.ndc_item_code??"").toString().trim(),r&&(o&&t.push(`${r} ${o}`),s&&t.push(`${r} ${s}`),t.push(`${r} ${n}`.trim()),t.push(r)),i&&t.push(i),n&&(a&&t.push(`"${n}" ${a}`),t.push(`"${n}"`),t.push(`${n} ${o}`)),l=new Set,t.filter(e=>{if(!e)return!1;let t=e.toLowerCase();return!l.has(t)&&(l.add(t),!0)})),c=e.sku??null,d=e.ndc_item_code??null,p=e.product_name??null,m=e.supplier_key??L(e.supplier_name);e.supplier_name;let _=await P(e);if(!_&&!I)return await T.from("match_url_job_rows").update({status:"unresolved",updated_at:new Date().toISOString()}).eq("id",e.id),{ok:!1,reason:"no_manufacturer_domain"};let f=new Map;if(O)for(let e of u){for(let t of(await k(e,O,N))){if(!t.url)continue;let e=t.url.split("#")[0];f.has(e)||f.set(e,{url:e,title:t.title,snippet:t.snippet,source:"serpapi"})}if(f.size>=N)break}if(0===f.size)if(!I||!O)return await T.from("match_url_job_rows").update({status:"unresolved",updated_at:new Date().toISOString()}).eq("id",e.id),{ok:!1,reason:"no_candidates"};else for(let e of u){for(let t of(await k(e,O,2*N))){if(!t.url)continue;let e=t.url.split("#")[0];f.has(e)||f.set(e,{url:e,title:t.title,snippet:t.snippet,source:"serpapi"})}if(f.size>=N)break}let h=Array.from(f.values());if(!I&&_&&0===(h=h.filter(e=>{let t=C(e.url);return!!t&&(t===_||t.endsWith(`.${_}`))})).length)return await T.from("match_url_job_rows").update({status:"unresolved",updated_at:new Date().toISOString()}).eq("id",e.id),{ok:!1,reason:"no_manufacturer_candidates"};let w=[];for(let e of h.slice(0,N))try{let t=await A(e.url,{sku:c,ndc:d,name:p,supplierDomain:_??m});t.ok?w.push({url:e.url,score:t.score,matchedTokens:t.matchedTokens,domain:t.domain??null,source:e.source,snippet:e.snippet??t.snippet}):w.push({url:e.url,score:0,matchedTokens:[],domain:C(e.url),source:e.source,snippet:e.snippet})}catch(t){w.push({url:e.url,score:0,matchedTokens:[],domain:C(e.url),source:e.source,snippet:e.snippet})}w.sort((e,t)=>t.score-e.score);let g=w[0];if(!g||g.score<$){let t=w.map(e=>({url:e.url,domain:e.domain??null,score:e.score,source:e.source,snippet:e.snippet}));return await T.from("match_url_job_rows").update({candidates:t,status:"unresolved",confidence:Math.max(...t.map(e=>e.score),0),updated_at:new Date().toISOString()}).eq("id",e.id),{ok:!1,reason:"low_confidence",candidates:t}}let R=g.domain??(()=>{try{return new URL(g.url).hostname.replace(/^www\./,"")}catch{return null}})(),S={url:g.url,domain:R,score:g.score,source:g.source,snippet:g.snippet};try{await T.from("match_url_job_rows").update({candidates:[S],status:"resolved_confident",resolved_url:g.url,resolved_domain:R,confidence:g.score,matched_by:"serpapi:manufacturer_only",updated_at:new Date().toISOString()}).eq("id",e.id)}catch(e){console.warn("Failed to update row with accepted candidate:",e)}try{let t=new Date().toISOString(),r={tenant_id:e.tenant_id,supplier_key:e.supplier_key??L(e.supplier_name),supplier_name:e.supplier_name??null,sku:e.sku??null,sku_norm:e.sku_norm??null,ndc_item_code:e.ndc_item_code??null,ndc_item_code_norm:e.ndc_item_code_norm??null,product_name:e.product_name??null,brand_name:e.brand_name??null,source_url:g.url,source_domain:R,confidence:g.score,signals:{matched_by:"serpapi:manufacturer_only"},last_seen_at:t,updated_at:t,created_at:t};await T.from("product_source_index").upsert(r,{onConflict:"tenant_id,supplier_key,sku_norm"})}catch(e){console.warn("product_source_index upsert failed:",e)}return{ok:!0,accepted:S}}let U=process.env.SUPABASE_URL,j=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!U||!j)throw Error("Missing SUPABASE env vars");let q=(0,v.createClient)(U,j,{auth:{persistSession:!1}});async function M(e,t){try{let{userId:r}=(0,S.getAuth)(e);if(!r)return R.NextResponse.json({ok:!1,error:"Unauthorized"},{status:401});let n=t?.params??null;n&&"function"==typeof n.then&&(n=await n);let a=n?.id;if(!a)return R.NextResponse.json({ok:!1,error:"job id required"},{status:400});let o=Number(process.env.MATCH_BATCH_LIMIT??25),{data:s,error:i}=await q.from("match_url_job_rows").select("*").eq("job_id",a).eq("status","queued").order("created_at",{ascending:!0}).limit(o);if(i)return console.error("failed to fetch queued rows:",i),R.NextResponse.json({ok:!1,error:String(i.message??i)},{status:500});if(!s||0===s.length)return R.NextResponse.json({ok:!0,processed:0,message:"no queued rows"},{status:200});try{await q.from("match_url_jobs").update({status:"running",updated_at:new Date().toISOString()}).eq("id",a)}catch(e){}let l=0,u=[];for(let e of s){try{let t=await D(e);u.push({row_id:e.row_id??e.id,result:t})}catch(t){console.error("processRow error for",e.id,t),u.push({row_id:e.row_id??e.id,error:String(t?.message??t)})}l+=1}try{await q.from("match_url_jobs").update({status:"partial",updated_at:new Date().toISOString()}).eq("id",a)}catch(e){}return R.NextResponse.json({ok:!0,processed:l,results:u},{status:200})}catch(e){return console.error("start route error:",e),R.NextResponse.json({ok:!1,error:String(e?.message??e)},{status:500})}}e.s(["POST",()=>M,"runtime",0,"nodejs"],63748);var H=e.i(63748);let B=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/v1/match/url-jobs/[id]/start/route",pathname:"/api/v1/match/url-jobs/[id]/start",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/v1/match/url-jobs/[id]/start/route.ts",nextConfigOutput:"",userland:H}),{workAsyncStorage:K,workUnitAsyncStorage:F,serverHooks:z}=B;function V(){return(0,n.patchFetch)({workAsyncStorage:K,workUnitAsyncStorage:F})}async function W(e,t,n){B.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/v1/match/url-jobs/[id]/start/route";R=R.replace(/\/index$/,"")||"/";let S=await B.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!S)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:v,params:E,nextConfig:y,parsedUrl:C,isDraftMode:k,prerenderManifest:A,routerServerContext:b,isOnDemandRevalidate:x,revalidateOnlyGenerated:T,resolvedPathname:O,clientReferenceManifest:N,serverActionsManifest:$}=S,I=(0,l.normalizeAppPath)(R),L=!!(A.dynamicRoutes[I]||A.routes[O]),P=async()=>((null==b?void 0:b.render404)?await b.render404(e,t,C,!1):t.end("This page could not be found"),null);if(L&&!k){let e=!!A.routes[O],t=A.dynamicRoutes[I];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await P();throw new w.NoFallbackError}}let D=null;!L||B.isDev||k||(D="/index"===(D=O)?"/":D);let U=!0===B.isDev||!L,j=L&&!U;$&&N&&(0,s.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:N,serverActionsManifest:$,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:$})});let q=e.method||"GET",M=(0,o.getTracer)(),H=M.getActiveScopeSpan(),K={params:E,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>B.onRequestError(e,t,n,b)},sharedContext:{buildId:v}},F=new u.NodeNextRequest(e),z=new u.NodeNextResponse(t),V=c.NextRequestAdapter.fromNodeNextRequest(F,(0,c.signalFromNodeResponse)(t));try{let s=async e=>B.handle(V,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=M.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${q} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${R}`)}),i=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var o,l;let u=async({previousCacheEntry:r})=>{try{if(!i&&x&&T&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await s(a);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let u=K.renderOpts.collectedTags;if(!L)return await (0,m.sendResponse)(F,z,o,K.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(o.headers);u&&(t[h.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,n=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await B.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:x})},b),t}},c=await B.handleResponse({req:e,nextConfig:y,cacheKey:D,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:T,responseGenerator:u,waitUntil:n.waitUntil,isMinimalMode:i});if(!L)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",x?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),k&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,_.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&L||d.delete(h.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,f.getCacheControlHeader)(c.cacheControl)),await (0,m.sendResponse)(F,z,new Response(c.value.body,{headers:d,status:c.value.status||200})),null};H?await l(H):await M.withPropagatedContext(e.headers,()=>M.trace(d.BaseServerSpan.handleRequest,{spanName:`${q} ${R}`,kind:o.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},l))}catch(t){if(t instanceof w.NoFallbackError||await B.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:x})}),L)throw t;return await (0,m.sendResponse)(F,z,new Response(null,{status:500})),null}}e.s(["handler",()=>W,"patchFetch",()=>V,"routeModule",()=>B,"serverHooks",()=>z,"workAsyncStorage",()=>K,"workUnitAsyncStorage",()=>F],18769)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_4a994c6e.js.map