module.exports=[10100,e=>{"use strict";var t=e.i(47909),r=e.i(74017),n=e.i(96250),i=e.i(59756),o=e.i(61916),a=e.i(14444),s=e.i(37092),l=e.i(69741),c=e.i(16795),d=e.i(87718),u=e.i(95169),p=e.i(47587),m=e.i(66012),f=e.i(70101),_=e.i(26937),g=e.i(10372),h=e.i(93695);e.i(52474);var w=e.i(5232),R=e.i(89171),v=e.i(44070),E=e.i(54799);async function y(e){let t=(0,v.getServiceSupabaseClient)(),{data:r,error:n}=await t.from("ecommerce_connections").select("id, tenant_id, platform, status, config, secrets_enc, updated_at").eq("tenant_id",e.tenantId).eq("platform",e.platform).eq("status","active").order("updated_at",{ascending:!1}).limit(1).maybeSingle();if(n)throw Error(`connection_load_failed: ${n.message}`);if(!r)throw Error("connection_not_found");let i=function(e){let t=function(){let e=process.env.INTEGRATIONS_ENCRYPTION_KEY||"";if(!e)throw Error("INTEGRATIONS_ENCRYPTION_KEY missing");let t=Buffer.from(e,"base64");if(32!==t.length)throw Error("INTEGRATIONS_ENCRYPTION_KEY must be 32 bytes base64");return t}(),[r,n,i]=(e||"").split(".");if(!r||!n||!i)throw Error("invalid_encrypted_payload");let o=Buffer.from(r,"base64"),a=Buffer.from(n,"base64"),s=Buffer.from(i,"base64"),l=E.default.createDecipheriv("aes-256-gcm",t,o);return l.setAuthTag(a),JSON.parse(Buffer.concat([l.update(s),l.final()]).toString("utf8"))}(r.secrets_enc);return{id:r.id,tenant_id:r.tenant_id,platform:r.platform,config:r.config??{},secrets:i}}var N=e.i(50656);function x(e){return`https://api.bigcommerce.com/stores/${e}/v3`}function S(e){return{"content-type":"application/json","x-auth-token":e,accept:"application/json"}}async function b(e){let t=e.creds.storeHash??e.creds.store_hash,r=e.creds.accessToken??e.creds.access_token;if(!t||!r)throw Error("bigcommerce_missing_credentials");let n=`${x(t)}/catalog/products?keyword=${encodeURIComponent(e.sku)}&limit=50`,i=await (0,N.safeFetch)(n,{method:"GET",headers:S(r),timeoutMs:12e3}),o=await i.text().catch(()=>""),a=o?JSON.parse(o):null;if(!i.ok)throw Error(`bigcommerce_search_failed:${i.status}:${o}`);return(a?.data??[]).find(t=>{let r=String(t?.sku??"").trim();return r?r===e.sku:!!Array.isArray(t?.variants)&&t.variants.some(t=>String(t?.sku??"").trim()===e.sku)})??null}function T(e,t){let r=e?.normalized_payload??{},n=e?.seo_payload??{},i=e?.description_html??null,o={name:"string"==typeof r?.name&&r.name.trim()?r.name.trim():"string"==typeof n?.h1&&n.h1.trim()?n.h1.trim():"New Product",type:"physical",weight:1,description:"string"==typeof i?i:"",sku:t||void 0,is_visible:!1,custom_fields:[{name:"Avidia Ingestion ID",value:String(e?.id??"")},{name:"Avidia Source URL",value:String(e?.source_url??"")}].filter(e=>e.value)};return"string"==typeof n?.pageTitle&&n.pageTitle.trim()&&(o.page_title=n.pageTitle.trim()),"string"==typeof n?.metaDescription&&n.metaDescription.trim()&&(o.meta_description=n.metaDescription.trim()),o}async function C(e){let t=e.creds.storeHash??e.creds.store_hash,r=e.creds.accessToken??e.creds.access_token;if(!t||!r)throw Error("bigcommerce_missing_credentials");let n=function(e){let t=e?.normalized_payload??{};for(let r of[t?.sku,t?.mpn,t?.part_number,t?.specs?.sku,t?.specs?.mpn,e?.sku,e?.mpn]){let e="string"==typeof r?r.trim():"";if(e)return e}return null}(e.ingestionRow),i=[],o=!!e.opts?.allowOverwriteExisting;n||i.push("missing_sku");let a=null;if(n)try{a=await b({creds:e.creds,sku:n})}catch(e){i.push("search_failed")}if(a&&!o)return{ok:!0,platform:"bigcommerce",action:"needs_review",product_id:a.id,sku:n,warnings:i,needs_review:!0,reason:"sku_exists_requires_manual_overwrite"};if(a&&o){let o=`${x(t)}/catalog/products/${a.id}`,s=T(e.ingestionRow,n),l=await (0,N.safeFetch)(o,{method:"PUT",headers:S(r),body:JSON.stringify(s),timeoutMs:15e3}),c=await l.text().catch(()=>"");if(!l.ok)throw Error(`bigcommerce_update_failed:${l.status}:${c}`);let d=c?JSON.parse(c):null,u=d?.data??null;return{ok:!0,platform:"bigcommerce",action:"updated",product_id:u?.id??a.id,sku:n,warnings:i}}let s=`${x(t)}/catalog/products`,l=T(e.ingestionRow,n),c=await (0,N.safeFetch)(s,{method:"POST",headers:S(r),body:JSON.stringify(l),timeoutMs:15e3}),d=await c.text().catch(()=>"");if(!c.ok)throw Error(`bigcommerce_create_failed:${c.status}:${d}`);let u=d?JSON.parse(d):null,p=u?.data??null;return{ok:!0,platform:"bigcommerce",action:"created",product_id:p?.id??void 0,sku:n,warnings:i}}async function O(e){let t=(0,v.getServiceSupabaseClient)(),{data:r,error:n}=await t.from("product_ingestions").select("id, tenant_id, source_url, normalized_payload, seo_payload, description_html, diagnostics").eq("id",e.ingestionId).maybeSingle();if(n)throw Error(`ingestion_load_failed: ${n.message}`);if(!r)throw Error("ingestion_not_found");if(!r.tenant_id)throw Error("missing_tenant_id_for_import");if(!r.normalized_payload)throw Error("ingestion_not_ready");let i=String(r.tenant_id),o=e.platform??"bigcommerce",a=new Date().toISOString(),s=await y({tenantId:i,platform:o}),l=String(s.config?.store_hash??s.secrets?.store_hash??""),c=String(s.secrets?.access_token??"");if(!l||!c)throw Error("bigcommerce_connection_incomplete");let d=await C({creds:{store_hash:l,access_token:c},ingestionRow:r,opts:{allowOverwriteExisting:!!e.allowOverwriteExisting}}),u=new Date().toISOString(),p=r.diagnostics||{},m={...p.import||{},status:d.ok?"completed":"failed",started_at:a,last_run_at:u,platform:o,result:d},f={...p,import:m},{error:_}=await t.from("product_ingestions").update({diagnostics:f,updated_at:u}).eq("id",r.id);if(_)throw Error(`import_persist_failed: ${_.message}`);return{ingestionId:r.id,platform:o,result:d}}async function k(e){let t=e.headers.get("x-pipeline-secret")||"",r=process.env.PIPELINE_INTERNAL_SECRET||"";if(!r||t!==r)return R.NextResponse.json({error:"unauthorized"},{status:401});let n=await e.json().catch(()=>({})),i=n?.ingestionId?.toString()||"",o=n?.options??{};if(!i)return R.NextResponse.json({error:"missing_ingestionId"},{status:400});try{let e=o?.platform??"bigcommerce",t=!!o?.allowOverwriteExisting,r=await O({ingestionId:i,platform:e,allowOverwriteExisting:t});return R.NextResponse.json(r,{status:200})}catch(t){let e=t?.message||String(t);if("ingestion_not_found"===e)return R.NextResponse.json({error:"ingestion_not_found"},{status:404});if("ingestion_not_ready"===e)return R.NextResponse.json({error:"ingestion_not_ready"},{status:409});if("missing_tenant_id_for_import"===e)return R.NextResponse.json({error:"missing_tenant_id_for_import"},{status:422});if("connection_not_found"===e)return R.NextResponse.json({error:"connection_not_found"},{status:409});if(e.startsWith("connection_load_failed:"))return R.NextResponse.json({error:"connection_load_failed",detail:e},{status:500});if("bigcommerce_connection_incomplete"===e)return R.NextResponse.json({error:"bigcommerce_connection_incomplete"},{status:409});if(e.startsWith("bigcommerce_"))return R.NextResponse.json({error:"bigcommerce_error",detail:e},{status:502});if(e.startsWith("import_persist_failed:"))return R.NextResponse.json({error:"import_persist_failed",detail:e},{status:500});return R.NextResponse.json({error:"import_internal_failed",detail:e},{status:500})}}e.s(["POST",()=>k],12797);var A=e.i(12797);let I=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/v1/pipeline/internal/import/route",pathname:"/api/v1/pipeline/internal/import",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/v1/pipeline/internal/import/route.ts",nextConfigOutput:"",userland:A}),{workAsyncStorage:P,workUnitAsyncStorage:$,serverHooks:j}=I;function q(){return(0,n.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:$})}async function D(e,t,n){I.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/v1/pipeline/internal/import/route";R=R.replace(/\/index$/,"")||"/";let v=await I.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:E,params:y,nextConfig:N,parsedUrl:x,isDraftMode:S,prerenderManifest:b,routerServerContext:T,isOnDemandRevalidate:C,revalidateOnlyGenerated:O,resolvedPathname:k,clientReferenceManifest:A,serverActionsManifest:P}=v,$=(0,l.normalizeAppPath)(R),j=!!(b.dynamicRoutes[$]||b.routes[k]),q=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,x,!1):t.end("This page could not be found"),null);if(j&&!S){let e=!!b.routes[k],t=b.dynamicRoutes[$];if(t&&!1===t.fallback&&!e){if(N.experimental.adapterPath)return await q();throw new h.NoFallbackError}}let D=null;!j||I.isDev||S||(D="/index"===(D=k)?"/":D);let H=!0===I.isDev||!j,M=j&&!H;P&&A&&(0,a.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:A,serverActionsManifest:P,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:P})});let U=e.method||"GET",F=(0,o.getTracer)(),K=F.getActiveScopeSpan(),B={params:y,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!N.experimental.authInterrupts},cacheComponents:!!N.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:N.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>I.onRequestError(e,t,n,T)},sharedContext:{buildId:E}},L=new c.NodeNextRequest(e),G=new c.NodeNextResponse(t),z=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(t));try{let a=async e=>I.handle(z,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${U} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${R}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var o,l;let c=async({previousCacheEntry:r})=>{try{if(!s&&C&&O&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await a(i);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let c=B.renderOpts.collectedTags;if(!j)return await (0,m.sendResponse)(L,G,o,B.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(o.headers);c&&(t[g.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,n=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:C})},T),t}},d=await I.handleResponse({req:e,nextConfig:N,cacheKey:D,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:O,responseGenerator:c,waitUntil:n.waitUntil,isMinimalMode:s});if(!j)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",C?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,f.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&j||u.delete(g.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,_.getCacheControlHeader)(d.cacheControl)),await (0,m.sendResponse)(L,G,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};K?await l(K):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${U} ${R}`,kind:o.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof h.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:$,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:C})}),j)throw t;return await (0,m.sendResponse)(L,G,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>q,"routeModule",()=>I,"serverHooks",()=>j,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>$],10100)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_7fe85adf.js.map