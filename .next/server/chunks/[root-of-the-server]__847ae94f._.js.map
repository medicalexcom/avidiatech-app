{"version":3,"sources":["../../../src/lib/supabase.ts","../../../src/lib/utils/safeFetch.ts"],"sourcesContent":["import { createClient, SupabaseClient } from \"@supabase/supabase-js\";\n\n/**\n * NOTE: This file augments the existing minimal supabase client helper while preserving\n * the original `supabase` export and behavior so other modules keep working.\n *\n * - Existing code (kept): supabase (created using SERVICE_ROLE_KEY || ANON_KEY if present)\n * - Additions:\n *   - getServerSupabase(): returns a server client using SUPABASE_SERVICE_ROLE_KEY (throws if missing)\n *   - getBrowserSupabase(): returns a browser/anon client using NEXT_PUBLIC_* anon key (returns null if missing)\n *   - serverSupabase / browserSupabase: convenience memoized clients (or null)\n */\n\n/* --- existing vars (kept for compatibility) --- */\nconst url = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL;\nconst key = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_ANON_KEY;\n\nlet _supabase: SupabaseClient | null = null;\nif (url && key) {\n  _supabase = createClient(url, key);\n} else {\n  console.warn(\"Supabase client not configured (missing SUPABASE_URL or KEY). Some server operations will fail until configured.\");\n}\n\nexport const supabase = _supabase;\n\n/* --- new, non-breaking helpers --- */\nconst anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ?? process.env.SUPABASE_ANON_KEY;\nconst serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\n/**\n * Memoized server client using the service role key (bypasses RLS).\n * Use this in server-only code paths that need elevated privileges.\n */\nlet _serverSupabase: SupabaseClient | null = null;\n\n/**\n * Safe server client getter.\n * Returns null (instead of throwing) when SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY are missing.\n * Useful for build/CI environments where secrets are not present.\n */\nexport function getServerSupabaseSafe(): SupabaseClient | null {\n  if (!url || !serviceRoleKey) {\n    return null;\n  }\n  if (!_serverSupabase) {\n    _serverSupabase = createClient(url, serviceRoleKey, {\n      // Add server-specific options here if needed\n    });\n  }\n  return _serverSupabase;\n}\n\nexport function getServerSupabase(): SupabaseClient {\n  const client = getServerSupabaseSafe();\n  if (!client) {\n    throw new Error(\"Server Supabase client is not configured. Ensure SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY are set in the environment.\");\n  }\n  return client;\n}\n\n/**\n * Memoized browser/anon client. Safe to call from client code if NEXT_PUBLIC_* vars are configured.\n * Returns null when anon config is missing (caller should handle null).\n */\nlet _browserSupabase: SupabaseClient | null = null;\nexport function getBrowserSupabase(): SupabaseClient | null {\n  if (!url || !anonKey) {\n    if (typeof window === \"undefined\") {\n      // server-side: warn but do not throw\n      console.warn(\"Browser Supabase client not configured (missing NEXT_PUBLIC_SUPABASE_URL or NEXT_PUBLIC_SUPABASE_ANON_KEY).\");\n    }\n    return null;\n  }\n  if (!_browserSupabase) {\n    _browserSupabase = createClient(url, anonKey, {\n      // client options if needed\n    });\n  }\n  return _browserSupabase;\n}\n\n/**\n * Convenience exports that create clients if possible (null when missing).\n * These are provided for callers that prefer a value rather than calling the getters.\n */\nexport const serverSupabase: SupabaseClient | null = (url && serviceRoleKey) ? createClient(url, serviceRoleKey) : null;\nexport const browserSupabase: SupabaseClient | null = (url && anonKey) ? createClient(url, anonKey) : null;\n\n/* --- Backwards-compatible alias for callers expecting getServiceSupabaseClient --- */\n/* The previous attempt to re-export from \"./supabase\" caused a redeclaration when this file\n   is the module itself. Provide a direct alias to the server getter already defined above.\n*/\nexport const getServiceSupabaseClient = getServerSupabase;\n","export async function safeFetch(input: RequestInfo, init?: RequestInit & { timeoutMs?: number }) {\n  const timeoutMs = init?.timeoutMs ?? 15000;\n  const controller = new AbortController();\n  const id = setTimeout(() => controller.abort(), timeoutMs);\n  try {\n    const res = await fetch(input, { ...init, signal: controller.signal });\n    clearTimeout(id);\n    return res;\n  } catch (err) {\n    clearTimeout(id);\n    throw err;\n  }\n}\n"],"names":[],"mappings":"s3BAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAcA,IAAM,EAAM,QAAQ,GAAG,CAAC,wBAAwB,EAAI,QAAQ,GAAG,CAAC,YAAY,CACtE,EAAM,QAAQ,GAAG,CAAC,yBAAyB,EAAI,QAAQ,GAAG,CAAC,iBAAiB,CAE9E,EAAmC,KACnC,GAAO,EACT,EAAY,CADE,AACF,EAAA,EAAA,YAAA,AAAY,EAAC,EAAK,GAE9B,QAAQ,IAAI,CAAC,oHAGR,IAAM,EAAW,EAGlB,EAAU,QAAQ,GAAG,CAAC,6BAA6B,EAAI,QAAQ,GAAG,CAAC,iBAAiB,CACpF,EAAiB,QAAQ,GAAG,CAAC,yBAAyB,CAMxD,EAAyC,KAmBtC,SAAS,IACd,IAAM,EAZN,AAAI,AAAC,GAAQ,GAGT,AAAC,CAHO,AAYG,GARb,EAAkB,CAAA,EAAA,EAAA,EAJS,IAGP,MACF,AAAY,EAAC,EAAK,EAAgB,CAEpD,EAAA,EAEK,GAPE,KAYT,GAAI,CAAC,EACH,MAAM,AAAI,AADC,MACK,2HAElB,OAAO,CACT,CA2BsD,GAAO,GAAkB,CAAA,EAAA,EAAA,YAAA,AAAY,EAAC,EAAK,GAC1C,GAAO,GAAW,CAAA,EAAA,EAAA,IAD0C,QAC1C,AAAY,EAAC,EAAK,WAAW,oDAM9D,0GC7FjC,eAAe,EAAU,CAAkB,CAAE,CAA2C,EAC7F,IAAM,EAAY,GAAM,WAAa,KAC/B,EAAa,IAAI,gBACjB,EAAK,WAAW,IAAM,EAAW,KAAK,GAAI,GAChD,GAAI,CACF,IAAM,EAAM,MAAM,MAAM,EAAO,CAAE,GAAG,CAAI,CAAE,OAAQ,EAAW,MAAM,AAAC,GAEpE,OADA,aAAa,GACN,CACT,CAAE,MAAO,EAAK,CAEZ,MADA,aAAa,GACP,CACR,CACF"}