module.exports=[54799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},37957,e=>{"use strict";var t=e.i(47909),r=e.i(74017),a=e.i(96250),o=e.i(59756),n=e.i(61916),s=e.i(14444),i=e.i(37092),l=e.i(69741),u=e.i(16795),d=e.i(87718),c=e.i(95169),p=e.i(47587),h=e.i(66012),f=e.i(70101),_=e.i(26937),g=e.i(10372),m=e.i(93695);e.i(52474);var R=e.i(5232),E=e.i(89171),w=e.i(24389),v=e.i(86883),y=e.i(54799);let S=process.env.SUPABASE_URL,A=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!S||!A)throw Error("Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY env vars");let b=(0,w.createClient)(S,A,{auth:{persistSession:!1}});async function C(e){if(!e?.source_url)throw Error("source_url required");let t=new URL(e.source_url);t.hash="";let r=t.toString(),{data:a}=await b.from("monitor_watches").select("*").eq("source_url",r).limit(1).maybeSingle();if(a)return e.product_id&&!a.product_id&&await b.from("monitor_watches").update({product_id:e.product_id}).eq("id",a.id),a;let o={source_url:r,product_id:e.product_id??null,tenant_id:e.tenant_id??null,created_by:e.created_by??null,frequency_seconds:e.frequency_seconds??86400,auto_watch:!0},{data:n,error:s}=await b.from("monitor_watches").insert([o]).select("*").maybeSingle();if(s)throw s;return n}let x=process.env.SUPABASE_URL,U=process.env.SUPABASE_SERVICE_ROLE_KEY,P=process.env.UPLOAD_BUCKET??"imports";if(!x||!U)throw Error("Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY env vars");let I=(0,w.createClient)(x,U,{auth:{persistSession:!1}});async function N(e){try{let{userId:t}=(0,v.getAuth)(e);if(!t)return E.NextResponse.json({ok:!1,error:"Unauthorized"},{status:401});let r=await e.formData(),a=r.get("file");if(!a)return E.NextResponse.json({ok:!1,error:"No file provided"},{status:400});let o=r.get("source_url")||r.get("canonical_url")||null,n=await a.arrayBuffer(),s=Buffer.from(n),i=a.name??`file-${Date.now()}`,l=i.replace(/\s+/g,"_"),u=`${Date.now()}-${l}`,{data:d,error:c}=await I.storage.from(P).upload(u,s,{contentType:a.type??void 0,upsert:!1});if(c)return console.error("storage upload error:",c),E.NextResponse.json({ok:!1,error:c.message??String(c)},{status:500});let p=(d&&(d.path||d.fullPath||d.Key))??u,h=String(p).replace(RegExp(`^${P}\\/`),"").replace(/^\/+/,""),f=`${P}/${h}`,_={file_path:f,file_name:i,file_format:i.split(".").pop()??null,mapping:null,platform:null,status:"created",uploaded_by:t,created_at:new Date().toISOString()};try{let{data:e,error:r}=await I.from("product_ingestions").insert([_]).select("*").maybeSingle();if(r){console.warn("Insert into product_ingestions failed:",r);let e=(0,y.randomUUID)();return(async()=>{try{let e=o??`supabase://${f}`;await C({source_url:e,product_id:null,created_by:t}),console.log("Created monitor watch for upload (synthetic):",e)}catch(e){console.warn("createWatchForIngestion failed (synthetic):",e?.message??e)}})(),E.NextResponse.json({ok:!0,warning:"Could not create DB row; returning synthetic jobId. Please check product_ingestions table/permissions.",jobId:e,file_path:f,file_name:i,file_format:_.file_format,rawUpload:d,dbError:r.message??r},{status:200})}let a=null;return e&&(a=e.id??e.job_id??null,null!==a&&"string"!=typeof a&&(a=String(a))),a||(a=(0,y.randomUUID)()),(async()=>{try{let r=o??`supabase://${f}`;await C({source_url:r,product_id:e?.id??null,created_by:t,frequency_seconds:null}),console.log("Created monitor watch for upload",r)}catch(e){console.warn("createWatchForIngestion failed:",e?.message??e)}})(),E.NextResponse.json({ok:!0,jobId:a,file_path:f,file_name:i,file_format:_.file_format,rawUpload:d,inserted:e??null},{status:200})}catch(r){console.error("Unexpected insert error:",r);let e=(0,y.randomUUID)();return(async()=>{try{let e=o??`supabase://${f}`;await C({source_url:e,product_id:null,created_by:t}),console.log("Created monitor watch for upload (unexpected error path)",e)}catch(e){console.warn("createWatchForIngestion failed (unexpected):",e?.message??e)}})(),E.NextResponse.json({ok:!0,warning:"Unexpected DB error while creating ingestion; returning synthetic jobId.",jobId:e,file_path:f,file_name:i,file_format:_.file_format,dbError:String(r?.message??r)},{status:200})}}catch(e){return console.error("upload-to-supabase route error:",e),E.NextResponse.json({ok:!1,error:String(e?.message??e)},{status:500})}}e.s(["POST",()=>N,"runtime",0,"nodejs"],93080);var O=e.i(93080);let T=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/upload-to-supabase/route",pathname:"/api/upload-to-supabase",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/upload-to-supabase/route.ts",nextConfigOutput:"",userland:O}),{workAsyncStorage:D,workUnitAsyncStorage:k,serverHooks:j}=T;function q(){return(0,a.patchFetch)({workAsyncStorage:D,workUnitAsyncStorage:k})}async function B(e,t,a){T.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let E="/api/upload-to-supabase/route";E=E.replace(/\/index$/,"")||"/";let w=await T.prepare(e,t,{srcPage:E,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:v,params:y,nextConfig:S,parsedUrl:A,isDraftMode:b,prerenderManifest:C,routerServerContext:x,isOnDemandRevalidate:U,revalidateOnlyGenerated:P,resolvedPathname:I,clientReferenceManifest:N,serverActionsManifest:O}=w,D=(0,l.normalizeAppPath)(E),k=!!(C.dynamicRoutes[D]||C.routes[I]),j=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,A,!1):t.end("This page could not be found"),null);if(k&&!b){let e=!!C.routes[I],t=C.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await j();throw new m.NoFallbackError}}let q=null;!k||T.isDev||b||(q="/index"===(q=I)?"/":q);let B=!0===T.isDev||!k,M=k&&!B;O&&N&&(0,s.setReferenceManifestsSingleton)({page:E,clientReferenceManifest:N,serverActionsManifest:O,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:O})});let $=e.method||"GET",H=(0,n.getTracer)(),L=H.getActiveScopeSpan(),K={params:y,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:B,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>T.onRequestError(e,t,a,x)},sharedContext:{buildId:v}},F=new u.NodeNextRequest(e),V=new u.NodeNextResponse(t),W=d.NextRequestAdapter.fromNodeNextRequest(F,(0,d.signalFromNodeResponse)(t));try{let s=async e=>T.handle(W,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${$} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${E}`)}),i=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var n,l;let u=async({previousCacheEntry:r})=>{try{if(!i&&U&&P&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await s(o);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let u=K.renderOpts.collectedTags;if(!k)return await (0,h.sendResponse)(F,V,n,K.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(n.headers);u&&(t[g.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,a=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:U})},x),t}},d=await T.handleResponse({req:e,nextConfig:S,cacheKey:q,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:U,revalidateOnlyGenerated:P,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:i});if(!k)return null;if((null==d||null==(n=d.value)?void 0:n.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",U?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,f.fromNodeOutgoingHttpHeaders)(d.value.headers);return i&&k||c.delete(g.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,_.getCacheControlHeader)(d.cacheControl)),await (0,h.sendResponse)(F,V,new Response(d.value.body,{headers:c,status:d.value.status||200})),null};L?await l(L):await H.withPropagatedContext(e.headers,()=>H.trace(c.BaseServerSpan.handleRequest,{spanName:`${$} ${E}`,kind:n.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof m.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:U})}),k)throw t;return await (0,h.sendResponse)(F,V,new Response(null,{status:500})),null}}e.s(["handler",()=>B,"patchFetch",()=>q,"routeModule",()=>T,"serverHooks",()=>j,"workAsyncStorage",()=>D,"workUnitAsyncStorage",()=>k],37957)},29652,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__e438751d._.js"].map(t=>e.l(t))).then(()=>t(26445)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__6c34d651._.js.map