module.exports=[67404,e=>{"use strict";e.i(78417);var t=e.i(51564),n=e.i(15484);e.i(79640);var r=e.i(39184);e.i(10698),e.i(52119),e.i(1618),e.i(39345),e.i(87442),e.i(31112);var a=e.i(31293),i=e.i(62790),s=class{#e;#t=864e5;constructor(e){this.#e=e}isEventThrottled(e){let t=Date.now(),n=this.#n(e),r=this.#e.getItem(n);return!!r&&!(t-r>this.#t)||(this.#e.setItem(n,t),!1)}#n(e){let{sk:t,pk:n,payload:r,...a}=e,i={...r,...a};return JSON.stringify(Object.keys({...r,...a}).sort().map(e=>i[e]))}},o=class{#r="clerk_telemetry_throttler";getItem(e){return this.#a()[e]}setItem(e,t){try{let n=this.#a();n[e]=t,localStorage.setItem(this.#r,JSON.stringify(n))}catch(e){e instanceof DOMException&&("QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&localStorage.length>0&&localStorage.removeItem(this.#r)}}removeItem(e){try{let t=this.#a();delete t[e],localStorage.setItem(this.#r,JSON.stringify(t))}catch{}}#a(){try{let e=localStorage.getItem(this.#r);if(!e)return{};return JSON.parse(e)}catch{return{}}}static isSupported(){return!1}},l=class{#e=new Map;#i=1e4;getItem(e){return this.#e.size>this.#i?void this.#e.clear():this.#e.get(e)}setItem(e,t){this.#e.set(e,t)}removeItem(e){this.#e.delete(e)}};let u=new Set(["error","warn","info","debug","trace"]);var c=class{#s;#o;#l={};#u=[];#c=null;constructor(e){this.#s={maxBufferSize:e.maxBufferSize??5,samplingRate:e.samplingRate??1,perEventSampling:e.perEventSampling??!0,disabled:e.disabled??!1,debug:e.debug??!1,endpoint:"https://clerk-telemetry.com"},e.clerkVersion?this.#l.clerkVersion=e.clerkVersion??"":this.#l.clerkVersion="",this.#l.sdk=e.sdk,this.#l.sdkVersion=e.sdkVersion,this.#l.publishableKey=e.publishableKey??"";const t=(0,a.parsePublishableKey)(e.publishableKey);t&&(this.#l.instanceType=t.instanceType),e.secretKey&&(this.#l.secretKey=e.secretKey.substring(0,16)),this.#o=new s(o.isSupported()?new o:new l)}get isEnabled(){return!("development"!==this.#l.instanceType||this.#s.disabled||"undefined"!=typeof process&&process.env&&(0,i.isTruthy)(process.env.CLERK_TELEMETRY_DISABLED))}get isDebug(){return this.#s.debug||"undefined"!=typeof process&&process.env&&(0,i.isTruthy)(process.env.CLERK_TELEMETRY_DEBUG)}record(e){try{let t=this.#d(e.event,e.payload);if(this.#h(t.event,t),!this.#g(t,e.eventSamplingRate))return;this.#u.push({kind:"event",value:t}),this.#m()}catch(e){console.error("[clerk/telemetry] Error recording telemetry event",e)}}recordLog(e){try{if(!this.#p(e))return;let t="string"==typeof e?.level&&u.has(e.level),n="string"==typeof e?.message&&e.message.trim().length>0,r=null,a=e?.timestamp;if("number"==typeof a||"string"==typeof a){let e=new Date(a);Number.isNaN(e.getTime())||(r=e)}if(!t||!n||null===r){this.isDebug&&"undefined"!=typeof console&&console.warn("[clerk/telemetry] Dropping invalid telemetry log entry",{levelIsValid:t,messageIsValid:n,timestampIsValid:null!==r});return}let i=this.#_(),s={sdk:i.name,sdkv:i.version,cv:this.#l.clerkVersion??"",lvl:e.level,msg:e.message,ts:r.toISOString(),pk:this.#l.publishableKey||null,payload:this.#f(e.context)};this.#u.push({kind:"log",value:s}),this.#m()}catch(e){console.error("[clerk/telemetry] Error recording telemetry log entry",e)}}#g(e,t){return this.isEnabled&&!this.isDebug&&this.#y(e,t)}#p(e){return!0}#y(e,t){let n=Math.random();return!!(n<=this.#s.samplingRate&&(!1===this.#s.perEventSampling||void 0===t||n<=t))&&!this.#o.isEventThrottled(e)}#m(){this.#v()}#v(){let e=[...this.#u];if(this.#u=[],this.#c=null,0===e.length)return;let t=e.filter(e=>"event"===e.kind).map(e=>e.value),n=e.filter(e=>"log"===e.kind).map(e=>e.value);t.length>0&&fetch(new URL("/v1/event",this.#s.endpoint),{headers:{"Content-Type":"application/json"},keepalive:!0,method:"POST",body:JSON.stringify({events:t})}).catch(()=>void 0),n.length>0&&fetch(new URL("/v1/logs",this.#s.endpoint),{headers:{"Content-Type":"application/json"},keepalive:!0,method:"POST",body:JSON.stringify({logs:n})}).catch(()=>void 0)}#h(e,t){this.isDebug&&(void 0!==console.groupCollapsed?(console.groupCollapsed("[clerk/telemetry]",e),console.log(t),console.groupEnd()):console.log("[clerk/telemetry]",e,t))}#_(){return{name:this.#l.sdk,version:this.#l.sdkVersion}}#d(e,t){let n=this.#_();return{event:e,cv:this.#l.clerkVersion??"",it:this.#l.instanceType??"",sdk:n.name,sdkv:n.version,...this.#l.publishableKey?{pk:this.#l.publishableKey}:{},...this.#l.secretKey?{sk:this.#l.secretKey}:{},payload:t}}#f(e){if(null==e||"object"!=typeof e)return null;try{let t=JSON.parse(JSON.stringify(e));if(t&&"object"==typeof t&&!Array.isArray(t))return t;return null}catch{return null}}};(0,r.withLegacyReturn)(t.verifyToken);var d=e.i(57594);let h={secretKey:d.SECRET_KEY,publishableKey:d.PUBLISHABLE_KEY,apiUrl:d.API_URL,apiVersion:d.API_VERSION,userAgent:"@clerk/nextjs@6.36.2",proxyUrl:d.PROXY_URL,domain:d.DOMAIN,isSatellite:d.IS_SATELLITE,machineSecretKey:d.MACHINE_SECRET_KEY,sdkMetadata:d.SDK_METADATA,telemetry:{disabled:d.TELEMETRY_DISABLED,debug:d.TELEMETRY_DEBUG}},g=e=>{let n,r,a,i;return n={...h,...e},r=(0,t.createBackendApiClient)(n),a=(0,t.createAuthenticateRequest)({options:n,apiClient:r}),i=new c({publishableKey:n.publishableKey,secretKey:n.secretKey,samplingRate:.1,...n.sdkMetadata?{sdk:n.sdkMetadata.name,sdkVersion:n.sdkMetadata.version}:{},...n.telemetry||{}}),{...r,...a,telemetry:i}};var m=e.i(73271);let p=new(e.i(78500)).AsyncLocalStorage;var _=e.i(13832);let f=async()=>{var e,r;let a;try{let e=await (0,n.buildRequestLike)(),r=(0,m.getHeader)(e,t.constants.Headers.ClerkRequestData);a=(0,_.decryptClerkRequestData)(r)}catch(e){if(e&&(0,n.isPrerenderingBailout)(e))throw e}let i=null!=(r=null==(e=p.getStore())?void 0:e.get("requestData"))?r:a;return(null==i?void 0:i.secretKey)||(null==i?void 0:i.publishableKey)?g(i):g({})};e.s(["clerkClient",()=>f],67404)},13868,40317,47916,e=>{"use strict";var t=e.i(89171),n=e.i(67404);class r extends Error{status;constructor(e,t){super(t),this.status=e,this.name="HttpError"}}e.s(["HttpError",()=>r],40317);var a=e.i(44070);function i(e){if(!e)return;let t=e.trim().toLowerCase();return t.length?t:void 0}let s={ingestion:{column:"ingestion_count",quotaKey:"ingestion"},seo:{column:"seo_count",quotaKey:"seo"},variants:{column:"variants_count",quotaKey:"variants"},match:{column:"match_count",quotaKey:"match"}};async function o(e,t){let r,a=(r=process.env.OWNER_EMAILS)?r.split(",").map(e=>i(e)??"").filter(e=>!!e):[];if(!a||0===a.length)return!1;let s=i(t);if(s)return a.includes(s);try{let t=await (0,n.clerkClient)(),r=await t.users.getUser(e),s=i(r.primaryEmailAddress?.emailAddress)||i(r.emailAddresses?.[0]?.emailAddress);if(!s)return!1;return a.includes(s)}catch(e){return console.warn("billing.resolveOwnerOverride: clerk lookup failed (non-fatal)",e?.message??e),!1}}function l(e){let t=e.headers.get("x-tenant-id");return t||(new URL(e.url).searchParams.get("tenant_id")??void 0)}async function u(e,t){let n=(0,a.getServiceSupabaseClient)().from("team_members").select("tenant_id, role").eq("user_id",e).order("created_at",{ascending:!0}).limit(1);t&&(n=n.eq("tenant_id",t));let{data:i,error:s}=await n;if(s)throw Error(s.message);let o=i?.[0];if(!o)throw new r(403,"No tenant membership found for user.");return{tenantId:o.tenant_id,role:o.role}}async function c(e){var t;let n=(0,a.getServiceSupabaseClient)(),{data:r,error:i}=await n.from("tenant_subscriptions").select("plan_name, status, current_period_end, ingestion_quota, seo_quota, variant_quota, match_quota").eq("tenant_id",e).order("current_period_end",{ascending:!1}).limit(1);if(i)throw Error(i.message);let s=r?.[0];return{planName:s?.plan_name??null,status:s?.status??null,currentPeriodEnd:s?.current_period_end??null,quotas:{ingestion:s?.ingestion_quota??null,seo:s?.seo_quota??null,variants:s?.variant_quota??null,match:s?.match_quota??null},isActive:!!(t=s?.status??null)&&["active","trialing","paid"].includes(t)}}async function d(e){let t=(0,a.getServiceSupabaseClient)(),{data:n,error:r}=await t.from("usage_counters").select("id, tenant_id, period_start, ingestion_count, seo_count, variants_count, match_count, updated_at").eq("tenant_id",e).order("period_start",{ascending:!1}).limit(1);if(r)throw Error(r.message);if(n&&n.length>0){let e=n[0];return{id:e.id,tenant_id:e.tenant_id,period_start:e.period_start,ingestion_count:e.ingestion_count??0,seo_count:e.seo_count??0,variants_count:e.variants_count??0,match_count:e.match_count??0,updated_at:e.updated_at??void 0}}let i=new Date().toISOString().slice(0,10);try{let{data:n,error:r}=await t.from("usage_counters").insert({tenant_id:e,period_start:i}).select("id, tenant_id, period_start, ingestion_count, seo_count, variants_count, match_count, updated_at").limit(1);if(r){let n=String(r.message||"").toLowerCase();if(n.includes("duplicate")||n.includes("unique")){let{data:n,error:r}=await t.from("usage_counters").select("id, tenant_id, period_start, ingestion_count, seo_count, variants_count, match_count, updated_at").eq("tenant_id",e).order("period_start",{ascending:!1}).limit(1);if(r)throw Error(r.message);if(n&&n.length>0){let e=n[0];return{id:e.id,tenant_id:e.tenant_id,period_start:e.period_start,ingestion_count:e.ingestion_count??0,seo_count:e.seo_count??0,variants_count:e.variants_count??0,match_count:e.match_count??0,updated_at:e.updated_at??void 0}}}throw Error(r.message)}let a=n?.[0];return{id:a.id,tenant_id:a.tenant_id,period_start:a.period_start,ingestion_count:a.ingestion_count??0,seo_count:a.seo_count??0,variants_count:a.variants_count??0,match_count:a.match_count??0,updated_at:a.updated_at??void 0}}catch(t){let e=String(t?.message||t||"").toLowerCase();if(e.includes("does not exist")||e.includes('relation "usage_counters"'))throw Error("usage_counters table missing or schema mismatch. Run migrations.");throw t}}async function h(e,t,n){let r=(0,a.getServiceSupabaseClient)(),{column:i}=s[t],o=e[i]+n,{error:l}=await r.from("usage_counters").update({[i]:o,updated_at:new Date().toISOString()}).eq("id",e.id);if(l)throw Error(l.message);return{...e,[i]:o}}async function g({userId:e,requestedTenantId:t,userEmail:n}){let r=null;try{r=await u(e,t)}catch(a){if("1"===process.env.ALLOW_SYNTHETIC_TENANT_FOR_CREATORS){let n=t??e;console.warn(`billing: membership missing for ${e}; using synthetic tenant=${n} because ALLOW_SYNTHETIC_TENANT_FOR_CREATORS=1`),r={tenantId:n,role:"owner"}}else if(await o(e,n)){let n=t??e;console.warn(`billing: membership missing for ${e}; owner override applied, tenant=${n}`),r={tenantId:n,role:"owner"}}else throw a}if("owner"===r.role){let e={id:"",tenant_id:r.tenantId,period_start:new Date().toISOString().slice(0,10),ingestion_count:0,seo_count:0,variants_count:0,match_count:0,updated_at:new Date().toISOString()};return{tenantId:r.tenantId,role:"owner",subscription:{planName:null,status:"owner-bypass",currentPeriodEnd:null,quotas:{ingestion:null,seo:null,variants:null,match:null},isActive:!0},usage:e}}let a=await c(r.tenantId),i=await d(r.tenantId),s="owner"===r.role||await o(e,n)?"owner":r.role;return{tenantId:r.tenantId,role:s,subscription:a,usage:i}}async function m({userId:e,requestedTenantId:t,feature:n,increment:a=1,userEmail:i}){let o=await g({userId:e,requestedTenantId:t,userEmail:i}),l="owner"===o.role;if(!l&&!o.subscription.isActive)throw new r(402,"An active subscription is required for this action.");if(n){let{quotaKey:e}=s[n],t=o.subscription.quotas[e],i=o.usage[s[n].column]+a;if(!l&&null!==t&&i>t)throw new r(402,"Quota exceeded for this plan. Please upgrade to continue.");if(o.usage.id){let e=await h(o.usage,n,a);return{...o,usage:e}}}return o}function p(e){return e instanceof r?t.NextResponse.json({error:e.message},{status:e.status}):(console.error(e),t.NextResponse.json({error:"Internal server error"},{status:500}))}function _(e){if(!e)return;for(let t of["email","email_address"]){let n=e[t];if("string"==typeof n&&n.length>0)return n}let t=e.email_addresses;if(Array.isArray(t)){let e=t.find(e=>"string"==typeof e);if(e)return e}}e.s(["handleRouteError",()=>p,"requireSubscriptionAndUsage",()=>m,"tenantFromRequest",()=>l],13868),e.s(["extractEmailFromSessionClaims",()=>_],47916)}];

//# sourceMappingURL=_b92302d9._.js.map