module.exports=[67404,e=>{"use strict";e.i(78417);var t=e.i(51564),r=e.i(15484);e.i(79640);var a=e.i(39184);e.i(10698),e.i(52119),e.i(1618),e.i(39345),e.i(87442),e.i(31112);var n=e.i(31293),s=e.i(62790),i=class{#e;#t=864e5;constructor(e){this.#e=e}isEventThrottled(e){let t=Date.now(),r=this.#r(e),a=this.#e.getItem(r);return!!a&&!(t-a>this.#t)||(this.#e.setItem(r,t),!1)}#r(e){let{sk:t,pk:r,payload:a,...n}=e,s={...a,...n};return JSON.stringify(Object.keys({...a,...n}).sort().map(e=>s[e]))}},o=class{#a="clerk_telemetry_throttler";getItem(e){return this.#n()[e]}setItem(e,t){try{let r=this.#n();r[e]=t,localStorage.setItem(this.#a,JSON.stringify(r))}catch(e){e instanceof DOMException&&("QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&localStorage.length>0&&localStorage.removeItem(this.#a)}}removeItem(e){try{let t=this.#n();delete t[e],localStorage.setItem(this.#a,JSON.stringify(t))}catch{}}#n(){try{let e=localStorage.getItem(this.#a);if(!e)return{};return JSON.parse(e)}catch{return{}}}static isSupported(){return!1}},l=class{#e=new Map;#s=1e4;getItem(e){return this.#e.size>this.#s?void this.#e.clear():this.#e.get(e)}setItem(e,t){this.#e.set(e,t)}removeItem(e){this.#e.delete(e)}};let c=new Set(["error","warn","info","debug","trace"]);var u=class{#i;#o;#l={};#c=[];#u=null;constructor(e){this.#i={maxBufferSize:e.maxBufferSize??5,samplingRate:e.samplingRate??1,perEventSampling:e.perEventSampling??!0,disabled:e.disabled??!1,debug:e.debug??!1,endpoint:"https://clerk-telemetry.com"},e.clerkVersion?this.#l.clerkVersion=e.clerkVersion??"":this.#l.clerkVersion="",this.#l.sdk=e.sdk,this.#l.sdkVersion=e.sdkVersion,this.#l.publishableKey=e.publishableKey??"";const t=(0,n.parsePublishableKey)(e.publishableKey);t&&(this.#l.instanceType=t.instanceType),e.secretKey&&(this.#l.secretKey=e.secretKey.substring(0,16)),this.#o=new i(o.isSupported()?new o:new l)}get isEnabled(){return!("development"!==this.#l.instanceType||this.#i.disabled||"undefined"!=typeof process&&process.env&&(0,s.isTruthy)(process.env.CLERK_TELEMETRY_DISABLED))}get isDebug(){return this.#i.debug||"undefined"!=typeof process&&process.env&&(0,s.isTruthy)(process.env.CLERK_TELEMETRY_DEBUG)}record(e){try{let t=this.#d(e.event,e.payload);if(this.#h(t.event,t),!this.#g(t,e.eventSamplingRate))return;this.#c.push({kind:"event",value:t}),this.#m()}catch(e){console.error("[clerk/telemetry] Error recording telemetry event",e)}}recordLog(e){try{if(!this.#p(e))return;let t="string"==typeof e?.level&&c.has(e.level),r="string"==typeof e?.message&&e.message.trim().length>0,a=null,n=e?.timestamp;if("number"==typeof n||"string"==typeof n){let e=new Date(n);Number.isNaN(e.getTime())||(a=e)}if(!t||!r||null===a){this.isDebug&&"undefined"!=typeof console&&console.warn("[clerk/telemetry] Dropping invalid telemetry log entry",{levelIsValid:t,messageIsValid:r,timestampIsValid:null!==a});return}let s=this.#y(),i={sdk:s.name,sdkv:s.version,cv:this.#l.clerkVersion??"",lvl:e.level,msg:e.message,ts:a.toISOString(),pk:this.#l.publishableKey||null,payload:this.#f(e.context)};this.#c.push({kind:"log",value:i}),this.#m()}catch(e){console.error("[clerk/telemetry] Error recording telemetry log entry",e)}}#g(e,t){return this.isEnabled&&!this.isDebug&&this.#_(e,t)}#p(e){return!0}#_(e,t){let r=Math.random();return!!(r<=this.#i.samplingRate&&(!1===this.#i.perEventSampling||void 0===t||r<=t))&&!this.#o.isEventThrottled(e)}#m(){this.#v()}#v(){let e=[...this.#c];if(this.#c=[],this.#u=null,0===e.length)return;let t=e.filter(e=>"event"===e.kind).map(e=>e.value),r=e.filter(e=>"log"===e.kind).map(e=>e.value);t.length>0&&fetch(new URL("/v1/event",this.#i.endpoint),{headers:{"Content-Type":"application/json"},keepalive:!0,method:"POST",body:JSON.stringify({events:t})}).catch(()=>void 0),r.length>0&&fetch(new URL("/v1/logs",this.#i.endpoint),{headers:{"Content-Type":"application/json"},keepalive:!0,method:"POST",body:JSON.stringify({logs:r})}).catch(()=>void 0)}#h(e,t){this.isDebug&&(void 0!==console.groupCollapsed?(console.groupCollapsed("[clerk/telemetry]",e),console.log(t),console.groupEnd()):console.log("[clerk/telemetry]",e,t))}#y(){return{name:this.#l.sdk,version:this.#l.sdkVersion}}#d(e,t){let r=this.#y();return{event:e,cv:this.#l.clerkVersion??"",it:this.#l.instanceType??"",sdk:r.name,sdkv:r.version,...this.#l.publishableKey?{pk:this.#l.publishableKey}:{},...this.#l.secretKey?{sk:this.#l.secretKey}:{},payload:t}}#f(e){if(null==e||"object"!=typeof e)return null;try{let t=JSON.parse(JSON.stringify(e));if(t&&"object"==typeof t&&!Array.isArray(t))return t;return null}catch{return null}}};(0,a.withLegacyReturn)(t.verifyToken);var d=e.i(57594);let h={secretKey:d.SECRET_KEY,publishableKey:d.PUBLISHABLE_KEY,apiUrl:d.API_URL,apiVersion:d.API_VERSION,userAgent:"@clerk/nextjs@6.36.2",proxyUrl:d.PROXY_URL,domain:d.DOMAIN,isSatellite:d.IS_SATELLITE,machineSecretKey:d.MACHINE_SECRET_KEY,sdkMetadata:d.SDK_METADATA,telemetry:{disabled:d.TELEMETRY_DISABLED,debug:d.TELEMETRY_DEBUG}},g=e=>{let r,a,n,s;return r={...h,...e},a=(0,t.createBackendApiClient)(r),n=(0,t.createAuthenticateRequest)({options:r,apiClient:a}),s=new u({publishableKey:r.publishableKey,secretKey:r.secretKey,samplingRate:.1,...r.sdkMetadata?{sdk:r.sdkMetadata.name,sdkVersion:r.sdkMetadata.version}:{},...r.telemetry||{}}),{...a,...n,telemetry:s}};var m=e.i(73271);let p=new(e.i(78500)).AsyncLocalStorage;var y=e.i(13832);let f=async()=>{var e,a;let n;try{let e=await (0,r.buildRequestLike)(),a=(0,m.getHeader)(e,t.constants.Headers.ClerkRequestData);n=(0,y.decryptClerkRequestData)(a)}catch(e){if(e&&(0,r.isPrerenderingBailout)(e))throw e}let s=null!=(a=null==(e=p.getStore())?void 0:e.get("requestData"))?a:n;return(null==s?void 0:s.secretKey)||(null==s?void 0:s.publishableKey)?g(s):g({})};e.s(["clerkClient",()=>f],67404)},13868,40317,47916,e=>{"use strict";var t=e.i(89171),r=e.i(67404);class a extends Error{status;constructor(e,t){super(t),this.status=e,this.name="HttpError"}}e.s(["HttpError",()=>a],40317);var n=e.i(44070);function s(e){if(!e)return;let t=e.trim().toLowerCase();return t.length?t:void 0}let i={ingestion:{column:"ingestion_count",quotaKey:"ingestion"},seo:{column:"seo_count",quotaKey:"seo"},variants:{column:"variants_count",quotaKey:"variants"},match:{column:"match_count",quotaKey:"match"}};async function o(e,t){let a,n=(a=process.env.OWNER_EMAILS)?a.split(",").map(e=>s(e)??"").filter(e=>!!e):[];if(0===n.length)return!1;let i=s(t);if(i)return n.includes(i);try{let t=await (0,r.clerkClient)(),a=await t.users.getUser(e),i=s(a.primaryEmailAddress?.emailAddress)||s(a.emailAddresses?.[0]?.emailAddress);if(!i)return!1;return n.includes(i)}catch(e){return console.error("Failed to resolve owner override",e),!1}}function l(e){let t=e.headers.get("x-tenant-id");return t||(new URL(e.url).searchParams.get("tenant_id")??void 0)}async function c(e,t){let r=(0,n.getServiceSupabaseClient)().from("team_members").select("tenant_id, role").eq("user_id",e).order("created_at",{ascending:!0}).limit(1);t&&(r=r.eq("tenant_id",t));let{data:s,error:i}=await r;if(i)throw Error(i.message);let o=s?.[0];if(!o)throw new a(403,"No tenant membership found for user.");return{tenantId:o.tenant_id,role:o.role}}async function u(e){var t;let r=(0,n.getServiceSupabaseClient)(),{data:a,error:s}=await r.from("tenant_subscriptions").select("plan_name, status, current_period_end, ingestion_quota, seo_quota, variant_quota, match_quota").eq("tenant_id",e).order("current_period_end",{ascending:!1}).limit(1);if(s)throw Error(s.message);let i=a?.[0];return{planName:i?.plan_name??null,status:i?.status??null,currentPeriodEnd:i?.current_period_end??null,quotas:{ingestion:i?.ingestion_quota??null,seo:i?.seo_quota??null,variants:i?.variant_quota??null,match:i?.match_quota??null},isActive:!!(t=i?.status??null)&&["active","trialing","paid"].includes(t)}}async function d(e){let t=(0,n.getServiceSupabaseClient)(),{data:r,error:a}=await t.from("usage_counters").select("id, tenant_id, period_start, ingestion_count, seo_count, variants_count, match_count, updated_at").eq("tenant_id",e).order("period_start",{ascending:!1}).limit(1);if(a)throw Error(a.message);if(r&&r.length>0){let e=r[0];return{id:e.id,tenant_id:e.tenant_id,period_start:e.period_start,ingestion_count:e.ingestion_count??0,seo_count:e.seo_count??0,variants_count:e.variants_count??0,match_count:e.match_count??0,updated_at:e.updated_at??void 0}}let s=new Date().toISOString().slice(0,10),{data:i,error:o}=await t.from("usage_counters").insert({tenant_id:e,period_start:s}).select("id, tenant_id, period_start, ingestion_count, seo_count, variants_count, match_count, updated_at").limit(1);if(o)throw Error(o.message);let l=i?.[0];return{id:l.id,tenant_id:l.tenant_id,period_start:l.period_start,ingestion_count:l.ingestion_count??0,seo_count:l.seo_count??0,variants_count:l.variants_count??0,match_count:l.match_count??0,updated_at:l.updated_at??void 0}}async function h(e,t,r){let a=(0,n.getServiceSupabaseClient)(),{column:s}=i[t],o=e[s]+r,{error:l}=await a.from("usage_counters").update({[s]:o,updated_at:new Date().toISOString()}).eq("id",e.id);if(l)throw Error(l.message);return{...e,[s]:o}}async function g({userId:e,requestedTenantId:t,userEmail:r}){let a=await c(e,t),n=await u(a.tenantId),s=await d(a.tenantId),i="owner"===a.role||await o(e,r)?"owner":a.role;return{tenantId:a.tenantId,role:i,subscription:n,usage:s}}async function m({userId:e,requestedTenantId:t,feature:r,increment:n=1,userEmail:s}){let o=await g({userId:e,requestedTenantId:t,userEmail:s}),l="owner"===o.role;if(!l&&!o.subscription.isActive)throw new a(402,"An active subscription is required for this action.");if(r){let{quotaKey:e}=i[r],t=o.subscription.quotas[e],s=o.usage[i[r].column]+n;if(!l&&null!==t&&s>t)throw new a(402,"Quota exceeded for this plan. Please upgrade to continue.");let c=await h(o.usage,r,n);return{...o,usage:c}}return o}function p(e){return e instanceof a?t.NextResponse.json({error:e.message},{status:e.status}):(console.error(e),t.NextResponse.json({error:"Internal server error"},{status:500}))}function y(e){if(!e)return;for(let t of["email","email_address"]){let r=e[t];if("string"==typeof r&&r.length>0)return r}let t=e.email_addresses;if(Array.isArray(t)){let e=t.find(e=>"string"==typeof e);if(e)return e}}e.s(["handleRouteError",()=>p,"requireSubscriptionAndUsage",()=>m,"tenantFromRequest",()=>l],13868),e.s(["extractEmailFromSessionClaims",()=>y],47916)}];

//# sourceMappingURL=_b92302d9._.js.map