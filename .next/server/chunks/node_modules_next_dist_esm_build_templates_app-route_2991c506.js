module.exports=[29616,e=>{"use strict";var t=e.i(47909),a=e.i(74017),r=e.i(96250),n=e.i(59756),s=e.i(61916),l=e.i(14444),o=e.i(37092),i=e.i(69741),u=e.i(16795),d=e.i(87718),c=e.i(95169),p=e.i(47587),_=e.i(66012),f=e.i(70101),m=e.i(26937),g=e.i(10372),y=e.i(93695);e.i(52474);var b=e.i(5232),v=e.i(89171),h=e.i(24389),w=e.i(83305);function R(e){let t=e.toLowerCase();return t.includes("http://")||t.includes("https://")||t.includes("www.")||t.includes("product for ")}function k(e){if(null==e)return null;let t=String(e).trim();return t||null}function E(e,t){let a=k(e);return a?a.length>t?a.slice(0,t):a:null}function S(e){let t={};if(!e)return t;if("object"==typeof e&&!Array.isArray(e)){for(let[a,r]of Object.entries(e)){let e=k(a),n=k(r);e&&n&&(t[e]=n)}return t}if(Array.isArray(e)){for(let a of e)if(a&&"object"==typeof a){let e=k(a.key),r=k(a.value);if(e&&r){t[e]=r;continue}let n=Object.entries(a);if(1===n.length){let[e,a]=n[0],r=k(e),s=k(a);r&&s&&(t[r]=s)}}}return t}function x(e,t){for(let[a,r]of Object.entries(t)){let t=a.trim(),n=r.trim();t&&n&&(t in e||(e[t]=n))}}let j=process.env.INGEST_SECRET||"",A=process.env.SUPABASE_URL||process.env.NEXT_PUBLIC_SUPABASE_URL||"",C=process.env.SUPABASE_SERVICE_ROLE_KEY||"";function N(e){if(!e||"object"!=typeof e)return[];try{return Object.keys(e)}catch{return[]}}function O(e,t){if(null==e)return null;let a=String(e);return a.trim()?a.length>t?a.slice(0,t):a:null}async function T(){return v.NextResponse.json({ok:!0,route:"ingest_callback",ingest_secret_configured:!!j,supabase_configured:!!(A&&C),timestamp:new Date().toISOString()},{status:200})}async function P(e){let t=`${Date.now()}-${Math.random().toString(36).slice(2,10)}`;try{let a,r=await e.text(),n=e.headers.get("x-avidiatech-signature")||"";if(!j)return console.error("INGEST_SECRET not configured on callback"),v.NextResponse.json({error:"server_misconfigured",detail:"INGEST_SECRET missing"},{status:500});if(!(0,w.verifySignature)(r,n,j))return console.warn("ingest callback invalid signature"),v.NextResponse.json({error:"invalid_signature"},{status:401});try{a=JSON.parse(r||"{}")}catch(e){return v.NextResponse.json({error:"invalid_json",detail:String(e?.message||e)},{status:400})}let s=a.job_id;if(!s)return v.NextResponse.json({error:"missing job_id"},{status:400});let l=A&&C?(0,h.createClient)(A,C,{auth:{persistSession:!1}}):null;if(!l)return v.NextResponse.json({error:"supabase_not_configured",detail:"Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY"},{status:500});let{data:o,error:i}=await l.from("product_ingestions").select("id, status, diagnostics, attempts_count, last_error, created_at, job_id, source_url, ingest_callback_at, ingest_engine_status, ingest_callback_request_id").or(`id.eq.${s},job_id.eq.${s}`).limit(1).maybeSingle();if(i)return console.error("ingest callback: failed to load product_ingestions",i.message||i),v.NextResponse.json({error:"db_error",detail:i.message||String(i)},{status:500});if(!o)return console.warn("ingest callback: no product_ingestions row found for job_id=",s),v.NextResponse.json({error:"not_found"},{status:404});let u=new Date().toISOString(),d=o.attempts_count||0,c=o.diagnostics||{},p=function(e){let{callbackBody:t}=e,a=function(e){let t=[{label:"normalized_payload",obj:e.normalized_payload},{label:"specs_payload",obj:e.specs_payload},{label:"manuals_payload",obj:e.manuals_payload},{label:"variants_payload",obj:e.variants_payload},{label:"raw_payload",obj:e.raw_payload}].filter(e=>null!=e.obj),a=[];for(let e of t){let t=e.obj;if(t&&"object"==typeof t){for(let r of["data","product","result","payload"])t&&"object"==typeof t&&t[r]&&"object"==typeof t[r]&&a.push({label:`${e.label}.${r}`,obj:t[r]});for(let r of["scrape","page","document"])t&&"object"==typeof t&&t[r]&&"object"==typeof t[r]&&a.push({label:`${e.label}.${r}`,obj:t[r]})}}return[...t,...a]}(t),r=e=>(function(e,t){for(let a of e){let e=a.obj;for(let r of t){let t=r.split("."),n=e;for(let e of t){if(!n||"object"!=typeof n){n=void 0;break}n=n[e]}if(null!=n)return{value:n,source:a.label,path:r}}}return{value:void 0,source:null,path:null}})(a,e),n=[],s=r(["name_raw","product.name_raw","data.name_raw","product_name","title","h1","seo.h1","meta.title","name","productName"]),l=k(s.value);if(l){if(R(l)){let e=k(r(["raw_payload.name_raw","raw_payload.product.name_raw","raw_payload.data.name_raw","raw_payload.title"]).value);e&&!R(e)||n.push({field:"name",issue:"url_derived_or_placeholder",fix_hint:"Engine provided url-derived name (e.g., 'Product for <url>'); must provide grounded name_raw/title."})}}else n.push({field:"name",issue:"missing",fix_hint:"Ensure ingest callback includes a grounded name field (name_raw/title/name)."});let o=null;if(l&&!R(l))o=l;else{let e=k(r(["name_raw","title","product.name_raw","data.name_raw","raw_payload.name_raw","raw_payload.title"]).value);e&&!R(e)&&(o=e)}let i=r(["brand","brand_raw","brand_hint","manufacturer","make"]),u=k(i.value),d=r(["specs","product.specs","data.specs"]),c=r(["specs_structured","specifications","tech_specs","product.specs_structured","product.specifications","data.specs_structured","data.specifications"]),p=r(["specs_pdf","pdf_kv","pdf_manual_kv","product.specs_pdf","product.pdf_kv","data.specs_pdf","data.pdf_kv"]),_=S(d.value??null),f=S(c.value??null),m=p.value??null,g=S(m),y={},b=[];Object.keys(f).length&&(x(y,f),b.push(`${c.source}:${c.path}`)),Object.keys(_).length&&(x(y,_),b.push(`${d.source}:${d.path}`)),Object.keys(g).length&&(x(y,g),b.push(`${p.source}:${p.path}`)),Object.keys(y).length||n.push({field:"specs",issue:"empty",fix_hint:"No specs found in callback payload buckets. Ensure engine includes specs/specs_structured/specifications/specs_pdf/pdf_kv."});let v=u??null;if(!v)for(let e of["brand","manufacturer","make"]){let t=y[e];if("string"==typeof t&&t.trim().length>0){v=t.trim();break}}let h=E(r(["description_raw","product.description_raw","data.description_raw","description","sections.description"]).value??null,2e4),w=r(["features_raw","product.features_raw","data.features_raw","features_html","features_structured","features","product.features","data.features"]).value??null,j=Array.isArray(w)?w.map(e=>String(e)).map(e=>e.trim()).filter(Boolean):null,A=E(r(["pdf_text","product.pdf_text","data.pdf_text"]).value??null,2e4),C=k(r(["sku","product.sku","data.sku","mpn","product.mpn","data.mpn"]).value??null),N=r(["images","product.images","data.images"]),O=Array.isArray(N.value)?N.value:null,T=r(["pdf_manual_urls","manual_urls","product.pdf_manual_urls","data.pdf_manual_urls"]),P=Array.isArray(T.value)?T.value:null;return n.some(e=>"name"===e.field||"specs"===e.field)||!o?{normalized:null,issues:n,extracted:{nameCandidate:o??l??null,nameSource:o?s.source??null:null,brandCandidate:v??null,brandSource:i.source??null,specsCount:Object.keys(y).length,specSourcesUsed:b}}:{normalized:{format:"avidia_standard",name:o,brand:v??null,specs:y,name_raw:E(r(["name_raw","product.name_raw","data.name_raw"]).value??null,500),description_raw:h,features_raw:j,specs_structured:c.value??null,specs_pdf:Array.isArray(m)?m:null,pdf_text:A,sku:C,images:O,pdf_manual_urls:P},issues:[],extracted:{nameCandidate:o,nameSource:s.source??null,brandCandidate:v??null,brandSource:i.source??null,specsCount:Object.keys(y).length,specSourcesUsed:b}}}({sourceUrl:o.source_url||null,callbackBody:a}),_={...c.ingest_callback||{},request_id:t,last_callback_at:u,status:a.status||"completed",error:a.error||null,raw_diagnostics:a.diagnostics||null,callback_top_level_keys:N(a),payload_bucket_keys:{normalized_payload:N(a.normalized_payload),specs_payload:N(a.specs_payload),manuals_payload:N(a.manuals_payload),variants_payload:N(a.variants_payload),raw_payload:N(a.raw_payload)},payload_previews:{normalized_payload:O(JSON.stringify(a.normalized_payload??null),4e3),specs_payload:O(JSON.stringify(a.specs_payload??null),4e3),raw_payload:O(JSON.stringify(a.raw_payload??null),4e3)},normalized_validation:{ok:0===p.issues.length,issues:p.issues,extracted:p.extracted,validated_at:u}},f={...c,ingest_callback:_},m=a.status||"completed",g=p.normalized?m:"error",y={diagnostics:f,ingest_callback_at:u,ingest_callback_request_id:t,ingest_engine_status:g,ingest_callback_payload:{request_id:t,received_at:u,status:m,error:a.error||null,callback_top_level_keys:N(a),payload_bucket_keys:_.payload_bucket_keys,payload_previews:_.payload_previews,normalized_validation:_.normalized_validation},attempts_count:d+1,updated_at:u,completed_at:u,last_error:a.error||null};p.normalized?(y.normalized_payload=p.normalized,y.status=m):(y.status="error",y.last_error="ingest_invalid_normalized_payload",y.error={code:"ingest_invalid_normalized_payload",message:"Callback payload lacked grounded name/specs in any recognized field blocks; refusing to persist invalid normalized_payload.",issues:p.issues,extracted:p.extracted});let{error:b}=await l.from("product_ingestions").update(y).eq("id",o.id);if(b)return console.error("ingest callback: failed to update product_ingestions",b.message||b),v.NextResponse.json({error:"db_update_failed",detail:b.message||String(b)},{status:500});return v.NextResponse.json({ok:!0,requestId:t},{status:200})}catch(e){return console.error("POST /api/v1/ingest/callback error:",e),v.NextResponse.json({error:e?.message||"internal_error"},{status:500})}}e.s(["GET",()=>T,"POST",()=>P],5637);var U=e.i(5637);let I=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/v1/ingest/callback/route",pathname:"/api/v1/ingest/callback",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/v1/ingest/callback/route.ts",nextConfigOutput:"",userland:U}),{workAsyncStorage:$,workUnitAsyncStorage:q,serverHooks:z}=I;function M(){return(0,r.patchFetch)({workAsyncStorage:$,workUnitAsyncStorage:q})}async function H(e,t,r){I.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/v1/ingest/callback/route";v=v.replace(/\/index$/,"")||"/";let h=await I.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!h)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:w,params:R,nextConfig:k,parsedUrl:E,isDraftMode:S,prerenderManifest:x,routerServerContext:j,isOnDemandRevalidate:A,revalidateOnlyGenerated:C,resolvedPathname:N,clientReferenceManifest:O,serverActionsManifest:T}=h,P=(0,i.normalizeAppPath)(v),U=!!(x.dynamicRoutes[P]||x.routes[N]),$=async()=>((null==j?void 0:j.render404)?await j.render404(e,t,E,!1):t.end("This page could not be found"),null);if(U&&!S){let e=!!x.routes[N],t=x.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(k.experimental.adapterPath)return await $();throw new y.NoFallbackError}}let q=null;!U||I.isDev||S||(q="/index"===(q=N)?"/":q);let z=!0===I.isDev||!U,M=U&&!z;T&&O&&(0,l.setReferenceManifestsSingleton)({page:v,clientReferenceManifest:O,serverActionsManifest:T,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:T})});let H=e.method||"GET",D=(0,s.getTracer)(),B=D.getActiveScopeSpan(),L={params:R,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!k.experimental.authInterrupts},cacheComponents:!!k.cacheComponents,supportsDynamicResponse:z,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:k.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>I.onRequestError(e,t,r,j)},sharedContext:{buildId:w}},K=new u.NodeNextRequest(e),F=new u.NodeNextResponse(t),G=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let l=async e=>I.handle(G,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=D.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${H} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${v}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),i=async n=>{var s,i;let u=async({previousCacheEntry:a})=>{try{if(!o&&A&&C&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await l(n);e.fetchMetrics=L.renderOpts.fetchMetrics;let i=L.renderOpts.pendingWaitUntil;i&&r.waitUntil&&(r.waitUntil(i),i=void 0);let u=L.renderOpts.collectedTags;if(!U)return await (0,_.sendResponse)(K,F,s,L.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(s.headers);u&&(t[g.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,r=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:b.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:A})},j),t}},d=await I.handleResponse({req:e,nextConfig:k,cacheKey:q,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:C,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:o});if(!U)return null;if((null==d||null==(s=d.value)?void 0:s.kind)!==b.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(i=d.value)?void 0:i.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",A?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,f.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&U||c.delete(g.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,m.getCacheControlHeader)(d.cacheControl)),await (0,_.sendResponse)(K,F,new Response(d.value.body,{headers:c,status:d.value.status||200})),null};B?await i(B):await D.withPropagatedContext(e.headers,()=>D.trace(c.BaseServerSpan.handleRequest,{spanName:`${H} ${v}`,kind:s.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},i))}catch(t){if(t instanceof y.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:A})}),U)throw t;return await (0,_.sendResponse)(K,F,new Response(null,{status:500})),null}}e.s(["handler",()=>H,"patchFetch",()=>M,"routeModule",()=>I,"serverHooks",()=>z,"workAsyncStorage",()=>$,"workUnitAsyncStorage",()=>q],29616)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_2991c506.js.map